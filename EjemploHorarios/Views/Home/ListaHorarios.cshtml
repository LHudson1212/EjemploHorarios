@{
    ViewBag.Title = "Listado de Horarios - SENA";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">

<style>
    :root {
        --sena-green: #008037;
        --sena-green-light: #00a859;
        --sena-green-dark: #006028;
        --sena-green-glow: rgba(0, 168, 89, 0.4);
    }

    body {
        font-family: 'Segoe UI', sans-serif;
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #f0fdf4 100%);
        min-height: 100vh;
    }

    h2 {
        font-weight: 800;
        background: linear-gradient(135deg, var(--sena-green), var(--sena-green-light));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .card {
        border-radius: 1.25rem;
        box-shadow: 0 4px 16px rgba(0, 0, 0, .08);
        border: 1px solid rgba(0,128,55,.1);
        background: #fff;
    }

    .table th {
        background: linear-gradient(135deg, var(--sena-green), var(--sena-green-light));
        color: #fff;
        text-align: center;
        font-weight: 600;
    }

    .btn-outline-sena {
        border: 2px solid var(--sena-green);
        color: var(--sena-green);
        border-radius: .85rem;
        font-weight: 600;
        background: transparent;
        transition: all .3s ease;
    }

        .btn-outline-sena:hover {
            background: var(--sena-green);
            color: #fff;
            box-shadow: 0 4px 10px rgba(0,128,55,.3);
        }

    .bg-sena {
        background: linear-gradient(135deg, var(--sena-green), var(--sena-green-light));
    }

    /* filtros */
    .filters {
        padding: 1rem;
        border-bottom: 1px solid rgba(0,0,0,0.04);
        display: flex;
        gap: 0.75rem;
        align-items: flex-end;
        flex-wrap: wrap;
    }

        .filters .form-group {
            min-width: 180px;
            flex: 1 1 180px;
        }

            .filters .form-group.ficha {
                flex: 0 0 120px;
            }

        .filters .btn {
            min-width: 110px;
        }

    @@media (max-width: 768px) {
        .filters {
            gap: .5rem;
        }

            .filters .form-group {
                flex: 1 1 100%;
                min-width: 0;
            }
    }
</style>

<div class="container py-4">
    <div class="text-center mb-4">
        <h2>Gestión de Horarios</h2>
        <p class="text-muted mb-0">Consulta los horarios creados por ficha o por instructor</p>
    </div>

    <ul class="nav nav-pills justify-content-center mb-4" id="horariosTabs" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" id="fichas-tab" data-bs-toggle="pill" data-bs-target="#fichas" type="button">
                <i class="bi bi-journal-text me-1"></i> Por Ficha
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" id="instructores-tab" data-bs-toggle="pill" data-bs-target="#instructores" type="button">
                <i class="bi bi-person-badge me-1"></i> Por Instructor
            </button>
        </li>
    </ul>

    <div class="tab-content" id="horariosTabsContent">
        <!-- ================= TAB FICHAS ================= -->
        <div class="tab-pane fade show active" id="fichas" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header bg-sena text-white fw-bold d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-journal-text me-2"></i>Horarios por Ficha</span>
                    <button class="btn btn-light btn-sm" onclick="window.location.href='@Url.Action("Index","Home")'">
                        <i class="bi bi-plus-circle me-1"></i> Crear Nuevo
                    </button>
                </div>

                <!-- FILTROS -->
                <div class="filters">
                    <div class="form-group">
                        <label class="form-label small mb-1">Programa</label>
                        <input id="filterPrograma" list="programasList" class="form-control form-control-sm" placeholder="Escribe para buscar..." autocomplete="off" />
                        <datalist id="programasList"></datalist>
                    </div>

                    <div class="form-group ficha">
                        <label class="form-label small mb-1">Ficha</label>
                        <input id="filterFicha" list="fichasList" class="form-control form-control-sm" placeholder="Ej: 2995985" autocomplete="off" />
                        <datalist id="fichasList"></datalist>
                    </div>

                    <div class="form-group" style="max-width:140px;">
                        <label class="form-label small mb-1">Trimestre ficha</label>
                        <select id="filterTrimestreFicha" class="form-select form-select-sm">
                            <option value="">-- Todos --</option>
                        </select>
                    </div>

                    <div class="form-group" style="max-width:140px;">
                        <label class="form-label small mb-1">Trimestre (año)</label>
                        <select id="filterTrimestreAño" class="form-select form-select-sm">
                            <option value="">-- Todos --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label small mb-1">Instructor Líder</label>
                        <input id="filterInstructor" list="instructoresList" class="form-control form-control-sm" placeholder="Escribe para buscar..." autocomplete="off" />
                        <datalist id="instructoresList"></datalist>
                    </div>

                    <div class="d-flex gap-2 align-items-center">
                        <button id="btnBuscarFiltros" class="btn btn-success"><i class="bi bi-search me-1"></i> Buscar</button>
                        <button id="btnLimpiarFiltros" class="btn btn-outline-secondary">Limpiar</button>
                    </div>
                </div>

                <div class="card-body p-0">
                    <table class="table table-bordered align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Ficha</th>
                                <th>Programa</th>
                                <th>Fecha inicio</th>
                                <th>Fecha fin</th>
                                <th>Trimestre ficha</th>
                                <th>Trimestre del año</th>
                                <th>Fecha creación</th>
                                <th>Instructor Líder</th>
                                <th>Acción</th>
                            </tr>
                        </thead>

                        <tbody id="tbodyFichas">
                            <tr><td colspan="9" class="text-center text-muted py-3">Cargando horarios...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ================= TAB INSTRUCTORES ================= -->
        <div class="tab-pane fade" id="instructores" role="tabpanel">
            <div class="card mb-4">
                <div class="card-header bg-sena text-white fw-bold">
                    <i class="bi bi-person-badge me-2"></i>Horarios por Instructor
                </div>
                <div class="card-body p-0">
                    <table class="table table-bordered align-middle mb-0">
                        <thead>
                            <tr>
                                <th>Instructor</th>
                                <th>Total Horarios</th>
                                <th>Acción</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyInstructores">
                            <tr><td colspan="3" class="text-center text-muted py-3">Cargando horarios...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Estado global
        let ALL_HORARIOS = []; // datos originales completos traídos desde GetHorariosFicha

        document.addEventListener("DOMContentLoaded", () => {
            // eventos botones
            document.getElementById("btnBuscarFiltros").addEventListener("click", applyFilters);
            document.getElementById("btnLimpiarFiltros").addEventListener("click", clearFilters);

            // permitir buscar con Enter dentro de los inputs
            ["filterPrograma", "filterFicha", "filterInstructor"].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.addEventListener("keypress", (e) => { if (e.key === "Enter") { applyFilters(); e.preventDefault(); } });
            });

            cargarHorariosFicha();

            // Cargar horarios de instructores cuando se haga clic en el tab
            const instructorTab = document.getElementById('instructores-tab');
            if (instructorTab) {
                instructorTab.addEventListener('click', () => {
                    cargarHorariosInstructor();
                });
            }
        });

        /* ====================== CARGA Y RENDER TABLA ====================== */
        async function cargarHorariosFicha() {
            const tbody = document.getElementById("tbodyFichas");
            try {
                const resp = await fetch('@Url.Action("GetHorariosFicha","Home")', { credentials: 'same-origin' });
                const json = await resp.json();
                console.log("Respuesta horarios ficha:", json);

                if (!json.ok || !json.data || !json.data.length) {
                    tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-3">No hay horarios registrados.</td></tr>`;
                    ALL_HORARIOS = [];
                    populateFilterControls();
                    return;
                }

                ALL_HORARIOS = json.data;
                populateFilterControls();
                renderTable(ALL_HORARIOS);
            } catch (err) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-danger py-3">Error: ${err.message}</td></tr>`;
                console.error(err);
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById("tbodyFichas");
            if (!data || !data.length) {
                tbody.innerHTML = `<tr><td colspan="9" class="text-center text-muted py-3">
                    No hay coincidencias para los filtros seleccionados.</td></tr>`;
                return;
            }

            tbody.innerHTML = "";
            data.forEach(h => {
                const tr = document.createElement("tr");
                tr.innerHTML = `
                    <td>${h.CodigoFicha ?? ""}</td>
                    <td>${h.ProgramaNombre ?? ""}</td>
                    <td>${h.FechaInicioFicha ?? ""}</td>
                    <td>${h.FechaFinFicha ?? ""}</td>
                    <td class="text-center">${h.TrimestreFicha}</td>
                    <td class="text-center">${h.Trimestre_Año}</td>
                    <td>${h.FechaCreacionHorario ?? ""}</td>
                    <td>${h.InstructorLider ?? "Sin asignar"}</td>
                    <td class="text-center">
                        <button class="btn btn-outline-sena btn-sm" onclick="verHorarioFicha(${h.Id_Horario})">
                            <i class="bi bi-eye-fill"></i> Ver
                        </button>
                    </td>`;
                tbody.appendChild(tr);
            });
        }

        /* ====================== POPULAR FILTROS ====================== */
        function populateFilterControls() {
            const programasSet = new Set();
            const fichasSet = new Set();
            const instructoresSet = new Set();
            const trimestresFichaSet = new Set();
            const trimestresAnoSet = new Set();

            ALL_HORARIOS.forEach(h => {
                if (h.ProgramaNombre) programasSet.add(h.ProgramaNombre.trim());
                if (h.CodigoFicha != null) fichasSet.add(String(h.CodigoFicha).trim());
                if (h.InstructorLider) instructoresSet.add(h.InstructorLider.trim());
                if (h.TrimestreFicha != null) trimestresFichaSet.add(String(h.TrimestreFicha));
                if (h.Trimestre_Año != null) trimestresAnoSet.add(String(h.Trimestre_Año));
            });

            // programas datalist
            const dlProgramas = document.getElementById("programasList");
            dlProgramas.innerHTML = "";
            Array.from(programasSet).sort((a,b)=>a.localeCompare(b)).forEach(p => {
                const opt = document.createElement("option"); opt.value = p; dlProgramas.appendChild(opt);
            });

            // fichas datalist
            const dlFichas = document.getElementById("fichasList");
            dlFichas.innerHTML = "";
            Array.from(fichasSet).sort((a,b)=> a.localeCompare(b, undefined, {numeric: true})).forEach(f => {
                const opt = document.createElement("option"); opt.value = f; dlFichas.appendChild(opt);
            });

            // instructores datalist
            const dlInstr = document.getElementById("instructoresList");
            dlInstr.innerHTML = "";
            Array.from(instructoresSet).sort((a,b)=>a.localeCompare(b)).forEach(i => {
                const opt = document.createElement("option"); opt.value = i; dlInstr.appendChild(opt);
            });

            // trimestres ficha (1..7)
            const selTriFicha = document.getElementById("filterTrimestreFicha");
            const triFichaOptions = [`<option value="">-- Todos --</option>`].concat(
                Array.from(trimestresFichaSet)
                    .map(t => parseInt(t, 10))
                    .filter(n => !isNaN(n) && n >= 1 && n <= 7)
                    .sort((a,b)=> a - b)
                    .map(n => `<option value="${n}">${n}</option>`)
            );
            selTriFicha.innerHTML = triFichaOptions.join("");

            // trimestres año (1..4)
            const selTriAño = document.getElementById("filterTrimestreAño");
            const triAñoOptions = [`<option value="">-- Todos --</option>`].concat(
                Array.from(trimestresAnoSet)
                    .map(t => parseInt(t, 10))
                    .filter(n => !isNaN(n) && n >= 1 && n <= 4)
                    .sort((a,b)=> a - b)
                    .map(n => `<option value="${n}">${n}</option>`)
            );
            selTriAño.innerHTML = triAñoOptions.join("");
        }

        /* ====================== FILTRADO ====================== */
        function applyFilters() {
            const prog = (document.getElementById("filterPrograma").value || "").trim().toLowerCase();
            const ficha = (document.getElementById("filterFicha").value || "").trim().toLowerCase();
            const triFicha = (document.getElementById("filterTrimestreFicha").value || "").trim();
            const triAño = (document.getElementById("filterTrimestreAño").value || "").trim();
            const instr = (document.getElementById("filterInstructor").value || "").trim().toLowerCase();

            const results = ALL_HORARIOS.filter(h => {
                if (prog) {
                    const ph = (h.ProgramaNombre || "").toString().toLowerCase();
                    if (!ph.includes(prog)) return false;
                }
                if (ficha) {
                    const fh = (h.CodigoFicha != null ? h.CodigoFicha.toString().toLowerCase() : "");
                    if (!fh.includes(ficha)) return false;
                }
                if (triFicha) {
                    if ((h.TrimestreFicha == null ? "" : String(h.TrimestreFicha)) !== triFicha) return false;
                }
                if (triAño) {
                    if ((h.Trimestre_Año == null ? "" : String(h.Trimestre_Año)) !== triAño) return false;
                }
                if (instr) {
                    const ih = (h.InstructorLider || "").toString().toLowerCase();
                    if (!ih.includes(instr)) return false;
                }
                return true;
            });

            renderTable(results);
        }

        function clearFilters() {
            document.getElementById("filterPrograma").value = "";
            document.getElementById("filterFicha").value = "";
            document.getElementById("filterTrimestreFicha").value = "";
            document.getElementById("filterTrimestreAño").value = "";
            document.getElementById("filterInstructor").value = "";
            renderTable(ALL_HORARIOS);
        }

        /* ====================== HORARIOS POR INSTRUCTOR ====================== */
        async function cargarHorariosInstructor() {
            const tbody = document.getElementById("tbodyInstructores");
            tbody.innerHTML = `<tr><td colspan="3" class="text-center text-muted py-3">Cargando...</td></tr>`;

            try {
                const resp = await fetch('@Url.Action("GetHorariosInstructor", "Home")', {
                    credentials: "same-origin"
                });

                if (!resp.ok) {
                    throw new Error(`Error HTTP: ${resp.status}`);
                }

                const json = await resp.json();
                console.log("Respuesta horarios instructor:", json);

                if (!json.ok || !json.data || !json.data.length) {
                    tbody.innerHTML = `<tr><td colspan="3" class="text-center text-muted py-3">
                        No hay instructores con horarios asignados.</td></tr>`;
                    return;
                }

                tbody.innerHTML = "";

                // También obtener el conteo de horarios por instructor
                const respConteo = await fetch('@Url.Action("GetAsignacionesInstructor", "Home")');
                const jsonConteo = await respConteo.json();

                // Crear mapa de conteo por instructor
                const conteoMap = new Map();
                if (jsonConteo.ok && jsonConteo.data) {
                    jsonConteo.data.forEach(asignacion => {
                        const id = asignacion.IdInstructor;
                        conteoMap.set(id, (conteoMap.get(id) || 0) + 1);
                    });
                }

                json.data.forEach(instructor => {
                    const idInstructor = instructor.IdInstructor || 0;
                    const nombreInstructor = instructor.NombreInstructor || "Sin nombre";
                    const totalHorarios = conteoMap.get(idInstructor) || 0;

                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${nombreInstructor}</td>
                        <td class="text-center">${totalHorarios}</td>
                        <td class="text-center">
                            <button class="btn btn-outline-sena btn-sm" onclick="verHorarioInstructor(${idInstructor})">
                                <i class="bi bi-eye-fill"></i> Ver Horarios
                            </button>
                        </td>`;
                    tbody.appendChild(tr);
                });

            } catch (err) {
                console.error("Error cargando horarios por instructor:", err);
                tbody.innerHTML = `<tr><td colspan="3" class="text-center text-danger py-3">
                    Error al cargar los datos: ${err.message}</td></tr>`;
            }
        }

        /* ====================== DEPURACIÓN ====================== */
        async function debugHorariosInstructor() {
            try {
                console.log("=== DEBUG: Verificando datos de instructores ===");

                // 1. Verificar endpoint GetHorariosInstructor
                const resp1 = await fetch('@Url.Action("GetHorariosInstructor", "Home")');
                const json1 = await resp1.json();
                console.log("GetHorariosInstructor response:", json1);

                // 2. Verificar endpoint GetAsignacionesInstructor
                const resp2 = await fetch('@Url.Action("GetAsignacionesInstructor", "Home")');
                const json2 = await resp2.json();
                console.log("GetAsignacionesInstructor (primeros 5):",
                            json2.data ? json2.data.slice(0, 5) : "No data");

                // 3. Contar instructores únicos
                if (json2.ok && json2.data && json2.data.length > 0) {
                    const instructoresUnicos = [...new Set(json2.data.map(a => a.IdInstructor))];
                    console.log(`Instructores únicos en asignaciones: ${instructoresUnicos.length}`);
                    console.log("IDs:", instructoresUnicos);
                }
            } catch (err) {
                console.error("Error en debug:", err);
            }
        }

        /* ====================== REDIRECCIONES ====================== */
        function verHorarioFicha(idHorario) {
            window.location.href = '@Url.Action("VerHorarioFicha", "Home")?idHorario=' + idHorario;
        }

        function verHorarioInstructor(idInstructor) {
            window.location.href = '@Url.Action("VerHorarioInstructor", "Home")?idInstructor=' + idInstructor;
        }
    </script>
}