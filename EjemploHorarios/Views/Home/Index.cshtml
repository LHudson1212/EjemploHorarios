@model EjemploHorarios.Models.ViewModels.PlanificacionVM
@using System.Web.Helpers

@{
    ViewBag.Title = "Gestión de Horarios - SENA";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- ========================= CSS / ESTILOS ========================= -->
<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />

<style>
    /* ====================================================================
                   SISTEMA DE GESTIÓN DE HORARIOS SENA - ESTILOS ULTRA MEJORADOS
                   (Aplicados al código funcional existente)
               ==================================================================== */

    /* ====== Variables de tema ====== */
    :root {
        /* Colores principales SENA con más variantes */
        --sena-green: #008037;
        --sena-green-light: #00a859;
        --sena-green-dark: #006028;
        --sena-green-ultra-light: #e6f7ed;
        --sena-green-glow: rgba(0, 168, 89, 0.4);
        /* Colores de texto */
        --sena-ink: #1f2937;
        --sena-muted: #6b7280;
        --sena-light: #9ca3af;
        /* Colores por día */
        --day-lunes: linear-gradient(135deg, #00a859 0%, #00c96d 100%);
        --day-lunes-solid: #00a859;
        --day-martes: linear-gradient(135deg, #0091ea 0%,#00b0ff 100%);
        --day-martes-solid: #0091ea;
        --day-miercoles: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
        --day-miercoles-solid: #ff9800;
        --day-jueves: linear-gradient(135deg, #d81b60 0%, #f06292 100%);
        --day-jueves-solid: #d81b60;
        --day-viernes: linear-gradient(135deg, #8e24aa 0%, #ab47bc 100%);
        --day-viernes-solid: #8e24aa;
        --day-sabado: linear-gradient(135deg, #5d4037 0%, #795548 100%);
        --day-sabado-solid: #5d4037;
        /* Sombras */
        --shadow-xs: 0 1px 4px rgba(0, 0, 0, 0.02);
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
        --shadow-xl: 0 12px 32px rgba(0, 0, 0, 0.16);
        --shadow-2xl: 0 20px 48px rgba(0, 0, 0, 0.2);
        --shadow-glow: 0 0 20px var(--sena-green-glow);
        /* Efectos */
        --ring: 0 0 0 4px rgba(0, 128, 55, 0.15);
        --ring-success: 0 0 0 4px rgba(0, 168, 89, 0.25);
        --backdrop-blur: blur(16px);
        --backdrop-blur-strong: blur(24px);
        /* Transiciones */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-bounce: 600ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    * {
        box-sizing: border-box;
    }

    html {
        scroll-behavior: smooth;
        font-size: 16px;
    }

    body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        color: var(--sena-ink);
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #f0fdf4 100%);
        background-size: 200% 200%;
        animation: gradientShift 15s ease infinite;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
    }

    @@keyframes gradientShift {
        0%, 100% {
            background-position: 0% 50%
        }

        50% {
            background-position: 100% 50%
        }
    }

    /* Utilitarios */
    .border-sena {
        border-color: var(--sena-green) !important;
    }

    .bg-sena {
        background: linear-gradient(135deg, var(--sena-green) 0%, var(--sena-green-light) 100%) !important;
        color: #fff;
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
    }

        .bg-sena::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,.15) 0%, transparent 70%);
            animation: shimmer 4s ease-in-out infinite;
        }

    .text-sena {
        color: var(--sena-green) !important;
        font-weight: 600;
    }

    .pointer {
        cursor: pointer;
    }

    @@keyframes shimmer {
        from {
            transform: translate(-50%,-50%) rotate(0)
        }

        to {
            transform: translate(-50%,-50%) rotate(360deg)
        }
    }

    /* Tarjetas / contenedores */
    .card {
        border-radius: 1.25rem;
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(0,128,55,.1);
        background: rgba(255,255,255,.98);
        backdrop-filter: var(--backdrop-blur);
        transition: all var(--transition-base);
        overflow: hidden;
    }

        .card:hover {
            box-shadow: var(--shadow-xl), var(--shadow-glow);
            transform: translateY(-4px) scale(1.01);
            border-color: rgba(0,128,55,.2);
        }

    .card-header {
        border: 0;
        font-weight: 700;
        padding: 1.25rem 1.5rem;
    }

    /* Header principal */
    header {
        position: relative;
        padding: 1.5rem 0;
        margin-bottom: .5rem;
    }

        header h2 {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--sena-green) 0%, var(--sena-green-light) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: .25rem;
        }

    /* Controles */
    .form-label {
        font-weight: 700;
        color: var(--sena-green);
        margin-bottom: .55rem;
        font-size: .95rem;
        letter-spacing: .3px;
        display: flex;
        align-items: center;
        gap: .5rem;
    }

        .form-label::before {
            content: '';
            width: 4px;
            height: 16px;
            background: linear-gradient(180deg, var(--sena-green) 0%, var(--sena-green-light) 100%);
            border-radius: 2px;
        }

    .form-control, .form-select {
        border-radius: .85rem;
        border: 2px solid #e5e7eb;
        padding: .7rem 1rem;
        transition: all var(--transition-base);
        background: #fff;
        font-size: .95rem;
        box-shadow: var(--shadow-xs);
    }

        .form-control:focus, .form-select:focus {
            border-color: var(--sena-green);
            box-shadow: var(--ring), var(--shadow-md);
            outline: none;
            transform: translateY(-1px);
        }

    /* Botones */
    .btn {
        border-radius: .85rem;
        padding: .7rem 1.5rem;
        font-weight: 600;
        transition: all var(--transition-base);
        border: none;
        letter-spacing: .4px;
        box-shadow: var(--shadow-sm);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--sena-green) 0%, var(--sena-green-light) 100%);
        color: #fff;
    }

        .btn-success:hover {
            background: linear-gradient(135deg, var(--sena-green-dark) 0%, var(--sena-green) 100%);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            transform: translateY(-3px) scale(1.02);
        }

    .btn-outline-success {
        border: 2px solid var(--sena-green);
        color: var(--sena-green);
        background: transparent;
    }

        .btn-outline-success:hover {
            background: var(--sena-green);
            color: #fff;
        }

    /* Zona de días */
    .day-col {
        min-height: 500px;
        background: linear-gradient(180deg, rgba(246, 255, 246, .9) 0%, rgba(255,255,255,.95) 100%);
        border: 3px dashed #b6e4c3;
        border-radius: 1.25rem;
        padding: 1.25rem;
        transition: all var(--transition-base);
        position: relative;
        backdrop-filter: var(--backdrop-blur);
        box-shadow: var(--shadow-xs);
    }

        .day-col.dragover {
            background: linear-gradient(180deg, rgba(234,255,234,.98) 0%, rgba(246,255,246,.98) 100%);
            transform: scale(1.02);
            border-color: var(--sena-green);
            border-style: solid;
            box-shadow: var(--ring-success), var(--shadow-xl), var(--shadow-glow);
        }

        .day-col small.text-muted {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            color: var(--sena-light);
            font-size: .9rem;
            text-align: center;
            pointer-events: none;
            opacity: .6;
            font-weight: 600;
        }

    /* Tarjeta de evento */
    .event-card {
        border-left: 5px solid var(--sena-green);
        background: #fff;
        padding: 1rem;
        border-radius: 1rem;
        box-shadow: var(--shadow-sm);
        margin-bottom: 1rem;
        font-size: .95rem;
        text-align: left;
        transition: all var(--transition-base);
        position: relative;
    }

        .event-card:hover {
            transform: translateY(-4px) translateX(3px) scale(1.01);
            box-shadow: var(--shadow-lg);
        }

        .event-card small {
            display: block;
            color: var(--sena-muted);
            font-size: .86rem;
        }

        .event-card .btn {
            opacity: 0;
            transform: scale(.9) translateY(5px);
            transition: all var(--transition-bounce);
        }

        .event-card:hover .btn {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

    /* Chips (competencias) */
    .chip {
        display: inline-flex;
        align-items: center;
        gap: .6rem;
        padding: .5rem 1rem;
        border-radius: 999px;
        border: 2px solid #e5e7eb;
        background: linear-gradient(135deg, #fff 0%, #f9fafb 100%);
        font-size: .9rem;
        margin: .35rem .45rem .35rem 0;
        cursor: grab;
        transition: all var(--transition-base);
        font-weight: 500;
        box-shadow: var(--shadow-sm);
    }

        .chip:hover {
            box-shadow: var(--shadow-md), var(--shadow-glow);
            transform: translateY(-3px) scale(1.03);
            border-color: var(--sena-green-light);
        }

        .chip small {
            color: var(--sena-muted);
            font-weight: 600;
            font-size: .82rem;
        }

    /* Autocomplete */
    .autocomplete-list {
        position: absolute;
        left: 0;
        right: 0;
        top: calc(100% + .6rem);
        z-index: 1055;
        max-height: 320px;
        overflow-y: auto;
        border-radius: 1rem;
        border: 2px solid var(--sena-green-light);
        background: rgba(255,255,255,.98);
        box-shadow: var(--shadow-2xl);
    }

    .list-group-item-action {
        padding: .85rem 1.25rem;
        border: none;
        border-bottom: 1px solid #f3f4f6;
    }

        .list-group-item-action:hover {
            background: linear-gradient(90deg, rgba(234,255,234,.9) 0%, rgba(246,255,246,.5) 100%);
            color: var(--sena-green);
            font-weight: 600;
            padding-left: 1.5rem;
        }

    #fichaSugerencias.d-none {
        display: none;
    }

    /* Tabla */
    .table thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background: linear-gradient(135deg, var(--sena-green) 0%, var(--sena-green-light) 100%);
        color: #fff;
        font-weight: 700;
        padding: 1.25rem;
        border: none;
        letter-spacing: 1px;
    }

    /* Alertas */
    .floating-alert {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 3000 !important;
        min-width: 360px;
        max-width: 480px;
        box-shadow: var(--shadow-2xl);
        border-radius: 1.25rem;
        overflow: hidden;
        border: none;
    }

        .floating-alert .progress {
            height: 4px;
            background: rgba(0,0,0,.08);
            border-radius: 0;
        }

        .floating-alert .progress-bar {
            background: linear-gradient(90deg, var(--sena-green) 0%, var(--sena-green-light) 100%);
            transition: width 100ms linear;
            box-shadow: 0 0 10px rgba(0,168,89,.5);
        }

    /* Resultado ya usado en el horario */
    .resultado-usado {
        background: #dcfce7 !important;
        border-color: #16a34a !important;
        color: #166534 !important;
        font-weight: 600;
    }

    /* Competencia que ya tiene al menos una asignación */
    .competencia-usada {
        background: #dcfce7;
        border-radius: .75rem;
        padding: .15rem .4rem;
    }

    /* Resultado asignado en el horario */
    .asignacion-resultado {
        border-left: 4px solid #16a34a;
        background-color: #f0fdf4;
    }

    /* Competencia completa asignada en el horario */
    .asignacion-competencia {
        border-left: 4px solid #0f766e;
        background-color: #ecfdf3;
        box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.25);
    }

    @@media (max-width: 768px) {
        .floating-alert {
            min-width: 320px;
            right: 1rem;
            left: 1rem;
        }

        .day-col {
            min-height: 380px;
        }

        .table thead th {
            min-width: 150px;
            padding: 1rem;
            font-size: .9rem;
        }
    }

    /* ===== Efectos visuales del acordeón de competencias ===== */
    .card-header.pointer {
        cursor: pointer;
        transition: all 0.25s ease;
    }

        .card-header.pointer:hover {
            background: rgba(0, 128, 55, 0.05);
        }

    .card-header .bi {
        transition: transform 0.3s ease;
    }

    .collapse.show + .card-header .bi-chevron-down {
        transform: rotate(180deg);
    }

    .day-col {
        min-height: 120px;
        border: 1px dashed #aaa;
        border-radius: 8px;
        padding: 4px;
        background-color: #f8f9fa;
        transition: background-color 0.2s ease;
    }

        .day-col.drag-over {
            background-color: #d1e7dd;
        }

    .resultado-item.dragging {
        opacity: 0.5;
    }

    .asignacion {
        font-size: 0.85rem;
    }

        .asignacion .meta {
            display: flex;
            align-items: center;
            gap: .75rem;
            margin-top: .15rem;
            font-size: .85rem;
            color: var(--sena-muted);
            line-height: 1.2;
        }

            .asignacion .meta i {
                font-size: 1rem;
            }

            .asignacion .meta .sep {
                opacity: .5;
            }

        .asignacion .fw-semibold {
            font-weight: 600;
        }

    aside.col-lg-3 {
        align-self: flex-start;
    }

    #competenciasList {
        max-height: calc(100vh - 320px);
        overflow: auto;
    }

    #contenedorBarras .progress-bar {
        transition: width .4s ease, background-color .4s ease;
    }

    /* Colores para el horario */
    .bg-horario-ok {
        background: #00a859 !important;
    }

    .bg-horario-aviso {
        background: #ffb300 !important;
    }

    .bg-horario-peligro {
        background: #f57c00 !important;
    }

    .bg-horario-rojo {
        background: #d32f2f !important;
    }

    /* Colores para instructor */
    .bg-inst-ok {
        background: #00a859 !important;
    }

    .bg-inst-aviso {
        background: #ffb300 !important;
    }

    .bg-inst-alto {
        background: #f57c00 !important;
    }

    .bg-inst-max {
        background: #d32f2f !important;
    }

    .rotate-180 {
        transform: rotate(180deg);
    }

    .card-header .bi {
        transition: transform .25s ease;
    }

    .modal {
        z-index: 2000 !important;
    }

    .modal-backdrop {
        z-index: 1055;
    }

    #modalAsignar {
        z-index: 1060;
    }

    #modalHorarioInstructor {
        z-index: 1061;
    }

    #btnVerHorarioInstructor {
        padding: 0.5rem 0.75rem;
        border: 2px solid var(--sena-green);
        background: transparent;
        color: var(--sena-green);
        transition: all var(--transition-base);
        flex-shrink: 0;
    }

        #btnVerHorarioInstructor:hover:not(:disabled) {
            background: var(--sena-green);
            color: white;
            transform: translateY(-1px);
        }

        #btnVerHorarioInstructor:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            border-color: var(--sena-muted);
            color: var(--sena-muted);
        }

    #modalHorarioInstructor .modal-dialog {
        max-width: 600px;
        width: auto;
    }

    #modalHorarioInstructor .modal-content {
        border-radius: 12px;
        box-shadow: var(--shadow-xl);
    }

    #modalHorarioInstructor .modal-header {
        padding: 0.75rem 1rem;
        border-bottom: 2px solid rgba(255,255,255,0.2);
    }

    #modalHorarioInstructor .modal-body {
        max-height: 70vh;
    }

    #contenidoHorarioInstructor .horario-header {
        padding: 0.75rem 1rem;
        font-size: 0.9rem;
    }

    #contenidoHorarioInstructor .horario-dias {
        display: flex;
        gap: 0.5rem;
        padding: 0.75rem;
        max-height: 50vh;
        overflow-x: auto;
        overflow-y: hidden;
    }

    #contenidoHorarioInstructor .dia {
        min-width: 160px;
        flex: 1;
    }

        #contenidoHorarioInstructor .dia h5 {
            padding: 0.4rem 0.5rem;
            font-size: 0.85rem;
            border-radius: 8px 8px 0 0;
        }

    #contenidoHorarioInstructor .slot {
        padding: 0.3rem 0.4rem;
    }

    #contenidoHorarioInstructor .asignacion {
        padding: 0.4rem;
        margin: 0.25rem 0.2rem;
        border-radius: 8px;
        font-size: 0.8rem;
    }

        #contenidoHorarioInstructor .asignacion strong {
            font-size: 0.75rem;
        }

    #contenidoHorarioInstructor .muted {
        font-size: 0.7rem;
    }

    #contenidoHorarioInstructor .horario-dias::-webkit-scrollbar {
        height: 6px;
    }

    #contenidoHorarioInstructor .horario-dias::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }

    #contenidoHorarioInstructor .horario-dias::-webkit-scrollbar-thumb {
        background: var(--sena-green);
        border-radius: 3px;
    }

    @@media (max-width: 1200px) {
        #modalHorarioInstructor .modal-dialog {
            max-width: 500px;
        }

        #contenidoHorarioInstructor .horario-dias {
            flex-wrap: wrap;
            max-height: 60vh;
            overflow-y: auto;
        }

        #contenidoHorarioInstructor .dia {
            min-width: calc(50% - 0.5rem);
        }
    }

    @@media (max-width: 768px) {
        #modalHorarioInstructor .modal-dialog {
            position: static !important;
            margin: 1rem auto;
        }

        #contenidoHorarioInstructor .dia {
            min-width: 100%;
        }
    }

    .autocomplete-list {
        z-index: 1200;
    }

    .asignacion[data-resultado="null"] {
        background-color: #e7f5ef !important;
        border-left: 4px solid var(--sena-green);
    }

    #contenidoHorarioInstructor .fila-horario {
        display: flex;
        gap: 8px;
        width: 100%;
    }

    #contenidoHorarioInstructor .col-dia {
        flex: 1;
        min-width: 140px;
        max-width: 180px;
    }

    #contenidoHorarioInstructor .caja-asignacion {
        background: white;
        border-radius: 8px;
        padding: 6px;
        border: 1px solid #dcdcdc;
    }

    /* ====== FIX: que los títulos de competencias NO se corten ====== */
    .card.mb-2 {
        overflow: visible !important; /* evita que recorte el texto */
    }

    .card-header {
        align-items: flex-start !important; /* que el chevron no fuerce el centro */
        flex-wrap: wrap; /* permite salto de línea */
    }

    .comp-encabezado {
        flex: 1 1 auto; /* deja que ocupe el ancho disponible */
        min-width: 0; /* clave para que wrap funcione en flex */
        white-space: normal; /* permite varias líneas */
        word-break: break-word;
        line-height: 1.2;
        padding-right: .5rem; /* separa del icono */
    }

    .resultado-pendiente {
        background: #fff3cd !important;
        border-color: #ffecb5 !important;
        color: #664d03 !important;
    }

    .pendiente-orange {
        background: #ffedd5 !important;
        border: 1px solid #fdba74 !important;
        color: #9a3412 !important;
    }

    .comp-pendiente {
        border-left: 4px solid #ff9800 !important;
    }

    .pendiente-naranja {
        background: #fff7ed !important;
        border-color: #fb923c !important;
        color: #9a3412 !important;
    }
    .item-competencia {
        padding: 8px;
        border-radius: 6px;
        margin-bottom: 6px;
        cursor: grab;
    }

    .pendiente {
        background-color: #ff9800;
        color: white;
        font-weight: bold;
    }

    .completo {
        background-color: #4caf50;
        color: white;
    }
</style>


<!-- ========================= HTML / VISTA ========================= -->

<main class="container-fluid p-3">
    <header class="mb-3 text-center">
        <h2 class="text-sena mb-1">Sistema de Gestión de Horarios</h2>
        <p class="text-muted mb-0">Planifica y organiza la formación por días con arrastrar y soltar.</p>
    </header>

    <!-- Filtros -->
    <section class="row align-items-end mb-4 g-3" aria-label="Filtros de búsqueda">
        <!-- Año -->
        <div class="col-lg-2 col-md-3">
            <label class="form-label fw-bold text-sena" for="selAnio">Año del Horario</label>
            <input id="selAnio" type="number" step="1" min="@DateTime.Now.Year" max="2100" class="form-control" placeholder="Ej: 2026" autocomplete="off" />
        </div>

        <!-- Trimestre del año -->
        <div class="col-lg-2 col-md-3">
            <label class="form-label fw-bold text-sena" for="selTrimestreAnio">Trimestre del Año</label>
            <select id="selTrimestreAnio" class="form-select">
                <option value="">-- Selecciona un trimestre --</option>
                <option value="1">Trimestre 1</option>
                <option value="2">Trimestre 2</option>
                <option value="3">Trimestre 3</option>
                <option value="4">Trimestre 4</option>
            </select>
        </div>

        <!-- Ficha -->
        <div class="col-lg-4 col-md-6 position-relative">
            <label class="form-label fw-bold text-sena" for="inputFicha">Ficha</label>
            <input id="inputFicha"
                   class="form-control"
                   placeholder="Escribe el código o programa..."
                   autocomplete="off"
                   aria-autocomplete="list"
                   aria-expanded="false"
                   aria-controls="fichaSugerencias" />
            <input type="hidden" id="hfFichaId" />
            <div id="fichaSugerencias"
                 class="list-group autocomplete-list d-none"
                 role="listbox"
                 aria-label="Sugerencias de ficha">
            </div>
        </div>

        <!-- Trimestres ficha -->
        <div class="col-lg-3 col-md-4">
            <label class="form-label fw-bold text-sena">Trimestres</label>
            <div class="d-flex gap-2 align-items-center">
                <input id="txtTrimestreFicha"
                       type="number"
                       class="form-control text-center"
                       placeholder="1–7"
                       min="1" max="7"
                       readonly
                       style="width: 80px;" />
                <span class="fw-bold">→</span>
                <input id="txtSiguienteTrimestre"
                       type="number"
                       class="form-control text-center"
                       placeholder="Siguiente"
                       readonly
                       style="width: 100px;" />
            </div>
        </div>
    </section>

    @using (Html.BeginForm("GuardarHorario", "Home", FormMethod.Post, new { id = "formGuardarHorario", autocomplete = "off" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" id="hfAsignaciones" name="AsignacionesJson" />

        <div class="row g-3">
            <!-- Panel izquierdo -->
            <aside class="col-lg-3 d-flex flex-column" aria-label="Panel lateral">
                <!-- Importar Excel -->
                <div class="col-lg-12 col-md-12 mb-2">
                    <label class="form-label fw-bold text-sena">Importar Excel</label>
                    <div class="d-flex align-items-center gap-2">
                        <button type="button"
                                id="btnCargarExcel"
                                class="btn btn-success btn-sm"
                                data-bs-toggle="tooltip"
                                title="Importa la planeación desde un archivo Excel">
                            <i class="bi bi-file-earmark-excel-fill me-1"></i> Cargar Planeación
                        </button>
                        <input type="file" id="inputExcel" accept=".xlsx,.xls" class="d-none" />
                    </div>
                </div>

                <!-- Programa -->
                <div class="mb-2">
                    <label class="form-label fw-bold text-sena" for="inputPrograma">Programa de Formación</label>
                    <input id="inputPrograma"
                           type="text"
                           class="form-control"
                           placeholder="Escribe o selecciona un programa..."
                           autocomplete="off" />
                </div>

                <!-- Competencias -->
                <div class="card border-sena shadow-sm mb-3">
                    <div class="card-header bg-sena fw-bold d-flex justify-content-between align-items-center">
                        <span>Competencias</span>
                        <div class="input-group input-group-sm" style="width:55%;">
                            <input id="txtSearch"
                                   type="text"
                                   class="form-control"
                                   placeholder="Buscar..."
                                   autocomplete="off"
                                   aria-label="Buscar competencia" />
                            <span class="input-group-text bg-success text-white" title="Buscar">
                                <i class="bi bi-search"></i>
                            </span>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <div id="competenciasList"
                             class="list-group list-group-flush"
                             aria-live="polite"
                             aria-label="Listado de competencias">
                            <!-- Aquí se cargan dinámicamente competencias/resultados -->
                        </div>

                    </div>
                </div>
            </aside>

            <!-- Panel central -->
            <section class="col-lg-9">
                <div class="card border-sena shadow-sm">
                    <div class="card-header bg-sena fw-bold d-flex justify-content-between align-items-center">
                        <span>Días de formación</span>
                        <small class="opacity-75">
                            Arrastra los resultados de aprendizaje hacia un día para crear asignaciones
                        </small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle text-center"
                                   aria-label="Calendario semanal de formación">
                                <thead class="table-success">
                                    <tr>
                                        <th scope="col">Lunes</th>
                                        <th scope="col">Martes</th>
                                        <th scope="col">Miércoles</th>
                                        <th scope="col">Jueves</th>
                                        <th scope="col">Viernes</th>
                                        <th scope="col">Sábado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        @foreach (var d in new[] { "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado" })
                                        {
                                            <td>
                                                <div class="day-col"
                                                     id="day-@d.ToLower()"
                                                     data-day="@d"
                                                     role="list"
                                                     aria-label="@d">
                                                    <small class="text-muted drop-hint">Suelta aquí</small>
                                                </div>
                                            </td>
                                        }
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <small class="text-muted">
                            Arrastra aquí las asignaciones creadas desde la sección de competencias.
                        </small>
                    </div>
                </div>

                <div class="mt-3 text-end">
                    <button id="btnGuardarHorario"
                            type="button"
                            class="btn btn-success"
                            title="Guarda el horario actual">
                        <i class="bi bi-save me-2"></i>Guardar Todo
                    </button>

                    <button type="button"
                            class="btn btn-success"
                            onclick="location.href='@Url.Action("ListaHorarios", "Home")'"
                            title="Ver horarios guardados">
                        <i class="bi bi-calendar-check me-2"></i>Ver Horarios
                    </button>
                </div>
            </section>
        </div>
    }
</main>

<!-- Modal Asignar - Modificado -->
<div class="modal fade" id="modalAsignar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-sena">
            <div class="modal-header bg-sena text-white">
                <h5 class="modal-title">Asignar Instructor y Horario</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="alertChoque" class="alert alert-danger d-none text-center fw-bold" style="font-size: 1rem; border-radius: 10px;"></div>
                <input type="hidden" id="hfResultadoId" />
                <input type="hidden" id="hfProgramaId" />
                <input type="hidden" id="hfCompetenciaId" />

                <!-- Grupo de instructor con botón al lado -->
                <div class="mb-3">
                    <label class="form-label" for="selInstructor">Instructor</label>
                    <div class="d-flex gap-2 align-items-start">
                        <div class="flex-grow-1">
                            <input id="txtBuscarInstructor"
                                   class="form-control"
                                   placeholder="Escribe nombre o iniciales..."
                                   list="dlInstructores" />
                            <datalist id="dlInstructores"></datalist>

                            <input type="hidden" id="hfInstructorIdSeleccionado" />
                        </div>
                        <button type="button"
                                id="btnVerHorarioInstructor"
                                class="btn btn-outline-success"
                                title="Ver horario del instructor seleccionado"
                                disabled
                                style="white-space: nowrap;">
                            <i class="bi bi-calendar-week"></i>
                        </button>
                    </div>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label" for="horaDesde">Desde</label>
                        <input id="horaDesde" type="time" class="form-control" value="06:00" />
                    </div>
                    <div class="col-6">
                        <label class="form-label" for="horaHasta">Hasta</label>
                        <input id="horaHasta" type="time" class="form-control" value="09:00" />
                    </div>
                </div>

                <button id="btnGuardarAsignacion"
                        type="button"
                        class="btn btn-success w-100"
                        title="Guardar asignación">
                    <i class="bi bi-check-circle me-2"></i>Guardar
                </button>
            </div>
        </div>
    </div>
</div>


<!-- ================== BARRAS DE PROGRESO UNIFICADAS ================== -->
<div id="contenedorBarras" class="p-3 bg-white border rounded shadow-sm mt-4">

    <!-- ========== HORAS DEL HORARIO ========== -->
    <label class="fw-bold text-sena">
        <i class="bi bi-hourglass-split me-1"></i> Horas programadas del horario
    </label>

    <div class="d-flex justify-content-between small mb-1">
        <span id="lblHorasHorario">0 horas asignadas</span>
        <span class="text-muted">Límite: 440h – Objetivo: 352h (80%)</span>
    </div>

    <div class="progress mb-4" style="height: 20px;">
        <div id="barraHorario" class="progress-bar bg-success fw-bold" style="width: 0%;">0%</div>
    </div>

    <!-- ========== HORAS POR INSTRUCTOR ========== -->
    <label class="fw-bold text-sena">
        <i class="bi bi-person-lines-fill me-1"></i> Horas asignadas al instructor
    </label>

    <!-- 🔥 Botones para navegar entre instructores asignados -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <button id="btnPrevInstructor" class="btn btn-sm btn-outline-success">
            <i class="bi bi-chevron-left"></i>
        </button>

        <div class="fw-bold text-sena" id="nombreInstructorActual">
            Sin instructores asignados
        </div>

        <button id="btnNextInstructor" class="btn btn-sm btn-outline-success">
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>

    <div class="d-flex justify-content-between small mb-1">
        <span id="lblHorasInstructor">0 horas</span>
        <span id="lblMaxInstructor" class="text-muted">Máximo: 0h</span>
    </div>

    <div class="progress" style="height: 18px;">
        <div id="barraInstructor" class="progress-bar fw-bold" style="width: 0%;">0%</div>
    </div>

    <small id="estadoInstructor" class="text-muted mt-1 d-block"></small>
</div>



<!-- Modal Detalles (si luego quieres usarlo) -->
<div class="modal fade" id="modalDetalles" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-sena">
            <div class="modal-header bg-sena text-white">
                <h5 class="modal-title">Detalles de Asignación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detallesBody" aria-live="polite"></div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Competencia Completa -->
<div class="modal fade" id="modalConfirmCompetencia" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-sena">
            <div class="modal-header bg-sena text-white">
                <h5 class="modal-title">Agregar Competencia Completa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="fw-semibold mb-3">
                    ¿Deseas agregar la competencia
                    <span id="nombreCompetenciaConfirm" class="text-success"></span>
                    completa (con todos sus resultados de aprendizaje)?
                </p>
                <p class="text-muted small">
                    Esta competencia contiene
                    <span id="totalResultadosConfirm" class="fw-bold text-dark"></span>
                    resultados que se agregarán automáticamente al día
                    <span id="nombreDiaConfirm" class="text-primary fw-bold"></span>.
                </p>
                <div class="d-flex justify-content-center gap-3 mt-3">
                    <button type="button" class="btn btn-success" id="btnConfirmAgregarCompetencia">Sí, agregar</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Instructor Líder -->
<div class="modal fade" id="modalLider" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-sena">
            <div class="modal-header bg-sena text-white">
                <h5 class="modal-title">
                    <i class="bi bi-person-badge me-2"></i> Asignar Instructor Líder
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">

                <!-- === INFORMACIÓN VISUAL SOLO LECTURA (traída desde BD) === -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Programa de Formación</label>
                    <input id="txtProgramaModal" type="text" class="form-control" readonly />
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label fw-bold">Ficha</label>
                        <input id="txtFichaModal" type="text" class="form-control" readonly />
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-bold">Trimestre destino</label>
                        <input id="txtTrimestreDestinoModal" type="text" class="form-control text-center" readonly />
                    </div>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label fw-bold">Fecha inicio</label>
                        <input id="txtFechaInicioModal" type="date" class="form-control" readonly />
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-bold">Fecha fin</label>
                        <input id="txtFechaFinModal" type="date" class="form-control" readonly />
                    </div>
                </div>

                <hr />

                <!-- === INSTRUCTOR LÍDER (queda igual que antes) === -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Instructor Líder</label>

                    <input id="txtBuscarInstructorLider"
                           class="form-control"
                           placeholder="Escribe nombre o iniciales..."
                           list="dlInstructoresLider" />

                    <datalist id="dlInstructoresLider"></datalist>

                    <input type="hidden" id="hfInstructorLiderId" />
                </div>
                <button id="btnConfirmarLider"
                        type="button"
                        class="btn btn-success w-100">
                    <i class="bi bi-check-circle me-2"></i>Guardar Horario
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Ver Horario Instructor - Reducido y mejorado -->
<div class="modal fade" id="modalHorarioInstructor" tabindex="-1" aria-hidden="true"
     data-bs-backdrop="false" data-bs-keyboard="true" style="z-index:1061;">

    <div class="modal-dialog" id="dialogHorarioInstructor"
         style="width:500px; max-width:500px; margin:0;">

        <div class="modal-content border-sena" style="max-height:70vh; min-height:200px;">
            <div class="modal-header bg-sena text-white py-2">
                <h6 class="modal-title mb-0">
                    <i class="bi bi-calendar-week me-2"></i>
                    <span id="modalHorarioInstructorTitle">Horario del Instructor</span>
                </h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body p-0" id="contenidoHorarioInstructor"
                 style="overflow-y:auto;">
            </div>
        </div>

    </div>
</div>

<!-- ✅ Modal Detalle Competencia (AHORA FUERA DEL MODAL INSTRUCTOR) -->
<div class="modal fade" id="modalDetalleCompetencia" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="tituloDetalleCompetencia">Detalle Competencia</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <div id="resumenCompetenciaBox" class="mb-3"></div>

                <div class="table-responsive">
                    <table class="table table-sm table-striped align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>Resultado</th>
                                <th class="text-center">Req.</th>
                                <th class="text-center">Prog.</th>
                                <th class="text-center">Pend.</th>
                                <th class="text-center">%</th>
                            </tr>
                        </thead>
                        <tbody id="tbodyDetalleCompetencia"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- ========================= JS / LÓGICA ========================= -->
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // ========== UTILIDADES ==========
    function showAlert(message, type = "danger", ms = 4500) {
        const wrap = document.createElement("div");
        wrap.className = `alert alert-${type} floating-alert`;
        wrap.role = "alert";
        wrap.innerHTML = `
            <div class="d-flex align-items-start gap-2 p-3">
                <i class="bi ${type === "success" ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill"} fs-5 mt-1"></i>
                <div class="flex-grow-1">${message}</div>
                <button type="button" class="btn-close" aria-label="Close"></button>
            </div>
            <div class="progress"><div class="progress-bar" style="width:100%"></div></div>`;
        document.body.appendChild(wrap);

        const bar = wrap.querySelector(".progress-bar");
        const closeBtn = wrap.querySelector(".btn-close");
        let start = performance.now();

        const tick = (t) => {
            const elapsed = t - start;
            const pct = Math.max(0, 100 - (elapsed / ms) * 100);
            bar.style.width = pct + "%";
            if (elapsed >= ms) {
                wrap.classList.add("hide");
                setTimeout(() => wrap.remove(), 220);
            } else {
                wrap._raf = requestAnimationFrame(tick);
            }
        };
        wrap._raf = requestAnimationFrame(tick);

        closeBtn.addEventListener("click", () => {
            cancelAnimationFrame(wrap._raf);
            wrap.classList.add("hide");
            setTimeout(() => wrap.remove(), 200);
        });
    }

    function getAntiForgeryToken() {
        const el = document.querySelector('input[name="__RequestVerificationToken"]');
        return el ? el.value : null;
    }

    function debounce(fn, ms = 250) {
        let t;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(this, args), ms);
        };
    }


        // ✅ AQUÍ PEGAS TU FUNCIÓN:
        async function cargarResultadosCompetencia(nombreCompetencia) {
            const idFicha = hfFichaId.value;
            const trimestreAcad = txtSiguienteTrimestre.value; // destino

            const url = `/Home/GetResultadosPorCompetencia?nombreCompetencia=${encodeURIComponent(nombreCompetencia)}&idFicha=${idFicha}&trimestreAcad=${trimestreAcad}`;

            const resp = await fetch(url);
            const json = await resp.json();

            if (!json.ok) {
                showAlert(json.msg || "Error cargando resultados", "danger");
                return null;
            }

            return json; // {data, resumen}
        }

        // ========== ESTADO GLOBAL ==========
        let payload = {
            numeroFicha: "",
            nombreHorario: "Horario generado",
            trimestre: "",
            asignaciones: []
        };

        let COMPETENCIAS = [];                 // [{ Competencia, Resultados: [] }]
        let OPEN_COMP_IDS = new Set();        // ids de acordeones abiertos
        let COMP_DRAGGING = null;             // competencia que se arrastra completa
        let INSTRUCTORES_EN_HORARIO = [];
        let indexInstructorActual = 0;


    const INSTRUCTORES_BY_ID = new Map(); // cache id → nombre

    let dropContext = null;              // contexto de asignación que se está editando
    let dropContextGuardado = false;

    const nextId = (() => { let c = 1; return () => c++; })();
    // 🔥 NECESARIA: almacena horarios reales de otras fichas
    let HORARIOS_GLOBAL = [];

    let PENDIENTES_SET = new Set();

    function normTxt(s) {
        return (s || "")
            .toString()
            .normalize("NFD").replace(/[\u0300-\u036f]/g, "")
            .toUpperCase().trim()
            .replace(/\s+/g, " ");
    }

    function pendKey(comp, res) {
        return `${normTxt(comp)}|${normTxt(res)}`;
    }


    // Flag para permitir cerrar el modal cuando nosotros lo cerremos manualmente
    let allowCloseAsignarModal = false;

    let APLICAR_USOS_EN_COMPETENCIAS = false;
    // false = mientras editas antes de Guardar Todo
    // true  = cuando ya es horario oficial guardado

    // ========== REFERENCIAS DOM ==========
    const selAnio             = document.getElementById("selAnio");
    const selTrimestreAnio    = document.getElementById("selTrimestreAnio");
    const inputFicha          = document.getElementById("inputFicha");
    const fichaSugerencias    = document.getElementById("fichaSugerencias");
    const hfFichaId           = document.getElementById("hfFichaId");
    const txtTrimestreFicha   = document.getElementById("txtTrimestreFicha");
    const txtSiguienteTrimestre = document.getElementById("txtSiguienteTrimestre");
    const inputPrograma       = document.getElementById("inputPrograma");

    const competenciasList    = document.getElementById("competenciasList");
    const txtSearch           = document.getElementById("txtSearch");

    const btnCargarExcel      = document.getElementById("btnCargarExcel");
    const inputExcel          = document.getElementById("inputExcel");

    const modalAsignarEl      = document.getElementById("modalAsignar");
    const horaDesdeEl         = document.getElementById("horaDesde");
    const horaHastaEl         = document.getElementById("horaHasta");
    const btnGuardarAsig      = document.getElementById("btnGuardarAsignacion");

    const btnGuardarHorario   = document.getElementById("btnGuardarHorario");
    const btnConfirmarLider = document.getElementById("btnConfirmarLider");

    const txtBuscarInstructor = document.getElementById("txtBuscarInstructor");
    const dlInstructores = document.getElementById("dlInstructores");
    const hfInstructorIdSeleccionado = document.getElementById("hfInstructorIdSeleccionado");

    const txtBuscarInstructorLider = document.getElementById("txtBuscarInstructorLider");
    const dlInstructoresLider = document.getElementById("dlInstructoresLider");
    const hfInstructorLiderId = document.getElementById("hfInstructorLiderId");




        const ANIO_ACTUAL = new Date().getFullYear();

        selAnio.addEventListener("change", () => {
            const val = parseInt(selAnio.value, 10);

            if (!val) return;

            if (val < ANIO_ACTUAL) {
                alert(`⚠️ El año del horario no puede ser menor a ${ANIO_ACTUAL}.`);

                // Opción UX recomendada: corregir automáticamente
                selAnio.value = ANIO_ACTUAL;

                // Refrescar lógica dependiente del año
                refrescarTrimestresAnioDisponibles?.();
            }
        });


    async function refrescarTrimestresAnioDisponibles() {
        const idFicha = (hfFichaId.value || "").trim();
        const anio = (selAnio.value || "").trim();

        // Si no hay ficha/año, habilitar todo
        if (!idFicha || !anio) {
            Array.from(selTrimestreAnio.options).forEach(o => { if (o.value) o.disabled = false; });
            return;
        }

        try {
            const resp = await fetch(`/Home/GetTrimestresAnioOcupados?idFicha=${encodeURIComponent(idFicha)}&anio=${encodeURIComponent(anio)}`, {
                headers: { "Accept": "application/json" },
                credentials: "same-origin"
            });

            const json = await resp.json();
            if (!json.ok) return;

            const usados = new Set((json.usados || []).map(x => String(x)));

            // Deshabilitar los trimestres ya usados
            Array.from(selTrimestreAnio.options).forEach(o => {
                if (!o.value) return;
                o.disabled = usados.has(o.value);
            });

            // Si el seleccionado quedó bloqueado, mover al primero disponible
            if (selTrimestreAnio.value && usados.has(selTrimestreAnio.value)) {
                selTrimestreAnio.value = "";
                const firstOk = Array.from(selTrimestreAnio.options).find(o => o.value && !o.disabled);
                if (firstOk) selTrimestreAnio.value = firstOk.value;
            }

        } catch (e) {
            console.warn("No se pudo refrescar trimestres del año:", e);
        }
    }


    // ========== INSTRUCTORES ==========
    async function loadInstructores(q = "") {
      try {
        const url = '@Url.Action("GetInstructores", "Home")' + (q ? ('?q=' + encodeURIComponent(q)) : '');
        const resp = await fetch(url, {
          headers: { "Accept": "application/json" },
          credentials: "same-origin"
        });

        const json = await resp.json();
        if (!resp.ok || !json?.ok) {
          throw new Error(json?.msg || "No se pudieron cargar los instructores.");
        }

        const lista = Array.isArray(json.data) ? json.data : [];

        dlInstructores.innerHTML = "";
        INSTRUCTORES_BY_ID.clear();

        lista.forEach(i => {
          const id = String(i.id);
          const nombre = i.nombre;

          INSTRUCTORES_BY_ID.set(id, nombre);

          const opt = document.createElement("option");
          opt.value = nombre;
          opt.dataset.id = id;
          dlInstructores.appendChild(opt);
        });

        // limpiar selección actual
        txtBuscarInstructor.value = "";
        hfInstructorIdSeleccionado.value = "";

        const btnVerHorario = document.getElementById("btnVerHorarioInstructor");
        if (btnVerHorario) btnVerHorario.disabled = true;

      } catch (err) {
        showAlert("Error cargando instructores: " + err.message, "danger");

        dlInstructores.innerHTML = "";
        txtBuscarInstructor.value = "";
        hfInstructorIdSeleccionado.value = "";

        const btnVerHorario = document.getElementById("btnVerHorarioInstructor");
        if (btnVerHorario) btnVerHorario.disabled = true;
      }
    }


        function resolverInstructorIdDesdeTexto(texto) {
            const t = (texto || "").trim().toLowerCase();
            if (!t) return "";

            // match exacto (el datalist devuelve texto exacto del option)
            for (const [id, nombre] of INSTRUCTORES_BY_ID.entries()) {
                if (nombre.toLowerCase() === t) return id;
            }
            return "";
        }

        txtBuscarInstructor?.addEventListener("input", () => {
            const id = resolverInstructorIdDesdeTexto(txtBuscarInstructor.value);
            hfInstructorIdSeleccionado.value = id;

            // habilitar botón de ver horario solo si hay id válido
            const btnVerHorario = document.getElementById("btnVerHorarioInstructor");
            if (btnVerHorario) btnVerHorario.disabled = !id;
        });

        txtBuscarInstructorLider?.addEventListener("input", () => {
            const id = resolverInstructorIdDesdeTexto(txtBuscarInstructorLider.value);
            hfInstructorLiderId.value = id;
        });


    async function cargarInstructoresLider() {
      try {
        dlInstructoresLider.innerHTML = "";
        txtBuscarInstructorLider.value = "";
        hfInstructorLiderId.value = "";

        const resp = await fetch('@Url.Action("GetInstructores", "Home")', {
          headers: { "Accept": "application/json" },
          credentials: "same-origin"
        });
        const json = await resp.json();

        if (!json?.ok) throw new Error(json?.msg || "No se pudieron cargar instructores.");

        (json.data || []).forEach(i => {
          const id = String(i.id);
          const nombre = i.nombre;

          // Reutilizamos el mismo map global (sirve para ambos modales)
          INSTRUCTORES_BY_ID.set(id, nombre);

          const opt = document.createElement("option");
          opt.value = nombre;
          opt.dataset.id = id;
          dlInstructoresLider.appendChild(opt);
        });

      } catch (error) {
        showAlert("Error al cargar instructores líder: " + error.message, "danger");
      }
    }


    // ========== MODAL ASIGNAR ==========
    async function abrirModalAsignar(ctx, preset = null) {
        try {
            const resultado = decodeURIComponent(ctx.itemEl.dataset.resultado || "");
            let instructorAsignado = null;

            // Recargar horarios globales
            await cargarHorariosGlobales();

            // Buscar instructor recomendado
            if (resultado) {
                try {
                    const resp = await fetch(
                        '@Url.Action("GetInstructorPorResultado", "Home")' +
                        '?resultado=' + encodeURIComponent(resultado),
                        { headers: { "Accept": "application/json" } }
                    );

                    const json = await resp.json();
                    if (json.ok && json.data) {
                        instructorAsignado = {
                            id: String(json.data.IdInstructor),
                            nombre: json.data.Nombre
                        };
                    }
                } catch (err) {
                    showAlert("Error consultando instructor: " + err.message, "danger");
                }
            }

            // Cargar instructores
            await loadInstructores();

            // Selección inicial
            hfInstructorIdSeleccionado.value =
                instructorAsignado?.id ||
                preset?.instructorId ||
                "";

            // Horas predefinidas
            horaDesdeEl.value = preset?.horaDesde ?? "06:00";
            horaHastaEl.value = preset?.horaHasta ?? "09:00";

            dropContext = ctx;
            dropContextGuardado = false;

            payload.idFichaActual = hfFichaId.value || null;

            // =====================================================
            //            ✔ ABRIR MODAL (REUTILIZANDO INSTANCIA)
            // =====================================================
            bootstrap.Modal.getOrCreateInstance(modalAsignarEl).show();

            // =====================================================
            //   🔥🔥🔥 1) GUARDAR LA ASIGNACIÓN EN TIEMPO REAL
            // =====================================================
            const asignacion = payload.asignaciones.find(a => a.id === ctx.asignacionId);
            if (asignacion) {
                asignacion.horaDesde = horaDesdeEl.value;
                asignacion.horaHasta = horaHastaEl.value;
                asignacion.instructorId = hfInstructorIdSeleccionado.value ? parseInt(hfInstructorIdSeleccionado.value) : null;
                asignacion.instructorNombre = INSTRUCTORES_BY_ID.get(hfInstructorIdSeleccionado.value) || null;
            }

            // =====================================================
            //   🔥🔥🔥 2) REFRESCAR LISTA Y MOSTRAR INSTRUCTOR
            // =====================================================
            refrescarListaInstructoresEnHorario();
            await mostrarInstructorActual();

            // =====================================================
            //       Cargar info real desde BD del instructor
            // =====================================================
            if (hfInstructorIdSeleccionado.value) {
                await cargarHorasInstructor(hfInstructorIdSeleccionado.value);
                actualizarBarraInstructor();
            }

            actualizarBarraHorario();

            // =====================================================
            //          EVENTOS EN VIVO (solo 1 vez)
            // =====================================================
            if (!window._eventosModalAsignarRegistrados) {
                window._eventosModalAsignarRegistrados = true;

                txtBuscarInstructor.addEventListener("input", async () => {
                    const id = resolverInstructorIdDesdeTexto(txtBuscarInstructor.value);
                    hfInstructorIdSeleccionado.value = id;

                    // actualiza asignación en edición
                    if (dropContext) {
                        const a = payload.asignaciones.find(x => x.id === dropContext.asignacionId);
                        if (a) {
                            a.instructorId = id ? parseInt(id) : null;
                            a.instructorNombre = INSTRUCTORES_BY_ID.get(id) || null;
                        }
                    }

                    // carga horas / barras
                    if (id) await cargarHorasInstructor(id);
                    refrescarListaInstructoresEnHorario();
                    await mostrarInstructorActual();
                    actualizarBarraHorario();
                    validarEnVivo();
                });

                horaDesdeEl.addEventListener("input", async () => {
                    if (dropContext) {
                        const a = payload.asignaciones.find(x => x.id === dropContext.asignacionId);
                        if (a) a.horaDesde = horaDesdeEl.value;
                    }

                    refrescarListaInstructoresEnHorario();
                    await mostrarInstructorActual();
                    actualizarBarraHorario();
                    validarEnVivo();
                });

                horaHastaEl.addEventListener("input", async () => {
                    if (dropContext) {
                        const a = payload.asignaciones.find(x => x.id === dropContext.asignacionId);
                        if (a) a.horaHasta = horaHastaEl.value;
                    }

                    refrescarListaInstructoresEnHorario();
                    await mostrarInstructorActual();
                    actualizarBarraHorario();
                    validarEnVivo();
                });
            }

            setTimeout(() => validarEnVivo(), 200);

        } catch (err) {
            showAlert("Error al abrir el modal: " + err.message, "danger");
        }
    }

    async function cargarHorasInstructor(idInstructor) {
        const resp = await fetch("/Home/GetHorasInstructor?idInstructor=" + idInstructor);
        const json = await resp.json();

        if (json.ok) {
            window._horasInstructorActual = json.horasActuales;
            window._horasInstructorMax = json.horasMaximas;
        }
    }


        async function cargarHorariosGlobales() {
            try {
                const resp = await fetch("/Home/GetAsignacionesInstructor");
                const json = await resp.json();

                if (json.ok) {
                    HORARIOS_GLOBAL = json.data;
                }
            } catch (err) {
                console.error("Error cargando horarios globales:", err);
            }
        }

        (function wireGuardarAsignacion() {

            if (window._guardarAsigWired) return;
            window._guardarAsigWired = true;

            btnGuardarAsig.addEventListener("click", async () => {

                if (!dropContext) return;

                const instructorId = hfInstructorIdSeleccionado.value;
                const horaDesde = horaDesdeEl.value;
                const horaHasta = horaHastaEl.value;

                if (!instructorId) {
                    showAlert("Debes seleccionar un instructor.", "warning");
                    return;
                }

                if (!horaDesde || !horaHasta) {
                    showAlert("Debes indicar el horario completo.", "warning");
                    return;
                }

                const asignacion = payload.asignaciones.find(a => a.id === dropContext.asignacionId);
                const dia = asignacion?.dia || dropContext.itemEl.dataset.dia;
                const idFicha = hfFichaId.value;

                // 1️⃣ VALIDACIÓN LOCAL
                const conflictoLocal = tieneConflictoEnDia({
                    dia,
                    instructorId,
                    desde: horaDesde,
                    hasta: horaHasta,
                    ignoreId: dropContext.asignacionId
                });

                if (conflictoLocal) {
                    showAlert("❌ " + conflictoLocal, "danger");
                    return;
                }

                // 2️⃣ VALIDACIÓN BD (misma ficha)
                let respBD;
                try {
                    respBD = await $.get('/Home/ValidarFranjaExactaInstructor', {
                        idInstructor: instructorId,
                        dia: dia,
                        desde: horaDesde,
                        hasta: horaHasta,
                        idFichaActual: idFicha
                    });
                } catch (err) {
                    showAlert("Error validando horario en la BD.", "danger");
                    return;
                }

                if (!respBD.ok || respBD.choque) {
                    showAlert(respBD.msg || "❌ Choque en la base de datos.", "danger");
                    return;
                }

                // 3️⃣ VALIDACIÓN GLOBAL (otras fichas)
                let respGlobal;
                try {
                    respGlobal = await $.get('/Home/ValidarChoqueInstructorGlobal', {
                        idInstructor: instructorId,
                        dia: dia,
                        desde: horaDesde,
                        hasta: horaHasta,
                        idFichaActual: idFicha
                    });
                } catch (err) {
                    showAlert("Error validando choque global.", "danger");
                    return;
                }

                if (!respGlobal.ok || respGlobal.choque) {
                    showAlert(
                        respGlobal.msg ||
                        "❌ Este instructor ya tiene una clase en otra ficha en este horario.",
                        "danger"
                    );
                    return;
                }

                // 4️⃣ GUARDAR (NO HAY CHOQUES)
                const instructorNombre = INSTRUCTORES_BY_ID.get(String(instructorId)) || "—";

                asignacion.instructorId = Number(instructorId);
                asignacion.instructorNombre = instructorNombre;
                asignacion.horaDesde = horaDesde;
                asignacion.horaHasta = horaHasta;

                dropContext.itemEl.querySelector(".instructor").textContent = instructorNombre;
                dropContext.itemEl.querySelector(".horario").textContent =
                    `${horaDesde} – ${horaHasta}`;

                dropContext.itemEl.title = `${instructorNombre} • ${horaDesde} – ${horaHasta}`;

                dropContextGuardado = true;

                // 5️⃣ BARRAS Y ESTADO
                refrescarListaInstructoresEnHorario();
                await mostrarInstructorActual();
                actualizarBarraHorario();

                // 6️⃣ CERRAR MODAL
                allowCloseAsignarModal = true;
                bootstrap.Modal.getInstance(modalAsignarEl).hide();

                dropContext = null;

                showAlert(`Instructor ${instructorNombre} asignado correctamente.`, "success");
            });
        })();

       modalAsignarEl.addEventListener("hide.bs.modal", async function (e) {

        if (allowCloseAsignarModal) {
            allowCloseAsignarModal = false;
            dropContext = null;
            return;
        }

        if (!dropContext) return;

        const asignacion = payload.asignaciones.find(a => a.id === dropContext.asignacionId);
        if (!asignacion) {
            dropContext = null;
            return;
        }

        const instructorId = hfInstructorIdSeleccionado.value || null;
        const horaDesde = horaDesdeEl.value || "06:00";
        const horaHasta = horaHastaEl.value || "09:00";
        const idFicha = hfFichaId.value;
        const dia = asignacion.dia || dropContext.itemEl.dataset.dia;

        if (!instructorId) {
            dropContext.itemEl.remove();
            payload.asignaciones = payload.asignaciones.filter(a => a.id !== asignacion.id);
            dropContext = null;

            refrescarUsos();
            return;
        }

        e.preventDefault();

        const conflictoLocal = tieneConflictoEnDia({
            dia,
            instructorId,
            desde: horaDesde,
            hasta: horaHasta,
            ignoreId: asignacion.id
        });

        if (conflictoLocal) {
            showAlert("❌ " + conflictoLocal + " Debes ajustar instructor u horas.", "danger");
            return;
        }

        let respBD;
        try {
            respBD = await $.get("/Home/ValidarFranjaExactaInstructor", {
                idInstructor: instructorId,
                dia: dia,
                desde: horaDesde,
                hasta: horaHasta,
                idFichaActual: idFicha
            });
        } catch (err) {
            showAlert("Error validando BD.", "danger");
            return;
        }

        if (!respBD.ok || respBD.choque) {
            showAlert(respBD.msg || "❌ Choque en BD. Ajuste requerido.", "danger");
            return;
        }

        let respGlobal;
        try {
            respGlobal = await $.get("/Home/ValidarChoqueInstructorGlobal", {
                idInstructor: instructorId,
                dia: dia,
                desde: horaDesde,
                hasta: horaHasta,
                idFichaActual: idFicha
            });
        } catch (err) {
            showAlert("Error validando horario global.", "danger");
            return;
        }

        if (!respGlobal.ok || respGlobal.choque) {
            showAlert(
                respGlobal.msg ||
                "❌ Ya tiene clase en otra ficha. Ajuste requerido.",
                "danger"
            );
            return;
        }

        asignacion.instructorId = Number(instructorId);
        asignacion.instructorNombre = INSTRUCTORES_BY_ID.get(String(instructorId)) || "—";
        asignacion.horaDesde = horaDesde;
        asignacion.horaHasta = horaHasta;

        dropContext.itemEl.querySelector(".instructor").textContent =
            asignacion.instructorNombre;

        dropContext.itemEl.querySelector(".horario").textContent =
            `${horaDesde} – ${horaHasta}`;

        dropContext.itemEl.title =
            `${asignacion.instructorNombre} • ${horaDesde} – ${horaHasta}`;

        allowCloseAsignarModal = true;
        bootstrap.Modal.getInstance(modalAsignarEl).hide();

        dropContext = null;

        showAlert(
            `Instructor ${asignacion.instructorNombre} asignado correctamente.`,
            "success"
        );
    });


    // ========== DRAG & DROP DÍAS ==========
    function initDropHints() {
        document.querySelectorAll(".day-col").forEach(col => {
            const hint = col.querySelector(".drop-hint");
            if (hint) updateDropHint(col);
        });
    }

    function updateDropHint(dayCol) {
        const hint = dayCol.querySelector(".drop-hint");
        if (!hint) return;
        const hasItems = dayCol.querySelectorAll(".asignacion").length > 0;
        hint.style.display = hasItems ? "none" : "";
    }

    function wireDayDropZones() {
        document.querySelectorAll(".day-col").forEach(dia => {
            dia.addEventListener("dragover", e => {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
                dia.classList.add("drag-over");
            });

            dia.addEventListener("dragleave", () => dia.classList.remove("drag-over"));

            dia.addEventListener("drop", async e => {
                e.preventDefault();
                dia.classList.remove("drag-over");

                const competenciaCompletaData = e.dataTransfer.getData("competenciaCompleta");
                const competenciaData = e.dataTransfer.getData("competencia");
                const resultadoData = e.dataTransfer.getData("resultado");
                const diaSemana = dia.dataset.day;

                if (competenciaCompletaData && COMP_DRAGGING) {
                    mostrarModalConfirmacionCompetencia(COMP_DRAGGING, diaSemana);
                    return;
                }

                if (competenciaData && resultadoData) {
                    const competencia = decodeURIComponent(competenciaData);
                    const resultado = decodeURIComponent(resultadoData);
                    const asignacionId = nextId();

                    const item = document.createElement("div");
                    item.className = "asignacion asignacion-resultado border rounded p-2 mb-1 text-start";
                    item.dataset.asignacionId = String(asignacionId);
                    item.dataset.competencia = competencia;
                    item.dataset.resultado = resultado;
                    item.dataset.dia = diaSemana;

                    item.innerHTML = `
    <div class="d-flex align-items-start justify-content-between gap-2">
        <div class="fw-semibold flex-grow-1">
            <span class="badge bg-light text-success border border-success me-1">Resultado</span>
            ${resultado}
        </div>
        <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-link text-success p-0 edit-asig" title="Editar">
                <i class="bi bi-pencil-square"></i>
            </button>
            <button type="button" class="btn btn-link text-danger p-0 delete-asig" title="Eliminar">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
    <div class="meta mt-1">
        <i class="bi bi-mortarboard"></i><span class="instructor">Seleccione instructor…</span>
        <span class="sep">•</span>
        <i class="bi bi-clock"></i><span class="horario">--:-- – --:--</span>
    </div>`;

                    dia.appendChild(item);
                    updateDropHint(dia);

                    payload.asignaciones.push({
                        id: asignacionId,
                        competencia,
                        resultado,
                        dia: diaSemana,
                        instructorId: null,
                        instructorNombre: null,
                        horaDesde: null,
                        horaHasta: null
                    });

                    marcarResultadoUsado(competencia, resultado);
                    marcarCompetenciaUsada(competencia);

                    item.querySelector(".edit-asig")?.addEventListener("click", () => editarAsignacion(item));
                    item.querySelector(".delete-asig")?.addEventListener("click", () => eliminarAsignacion(item));

                    await abrirModalAsignar({ asignacionId, itemEl: item });
                }
            });
        });
    }

    // ========== DRAG RESULTADOS Y COMPETENCIAS ==========
    function wireResultadosDrag() {
        document.querySelectorAll(".resultado-item").forEach(r => {
            if (r.dataset.wired === "1") return;
            r.dataset.wired = "1";

            r.addEventListener("dragstart", e => {
                e.dataTransfer.setData("competencia", r.dataset.competencia);
                e.dataTransfer.setData("resultado", r.dataset.resultado);
                e.dataTransfer.effectAllowed = "move";
                r.classList.add("dragging");
            });
            r.addEventListener("dragend", () => r.classList.remove("dragging"));
        });
    }

    function wireCompetenciaDrag() {
        document.querySelectorAll(".card-header .fw-bold.text-sena").forEach((span, idx) => {
            if (span.dataset.wired === "1") return;
            span.dataset.wired = "1";

            span.draggable = true;
            span.title = "Arrastra la competencia completa";

            span.addEventListener("dragstart", e => {
                const comp = COMPETENCIAS[idx];
                if (!comp) return;
                COMP_DRAGGING = comp;
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("competenciaCompleta", encodeURIComponent(comp.Competencia));
                span.classList.add("opacity-50");
            });

            span.addEventListener("dragend", () => {
                COMP_DRAGGING = null;
                span.classList.remove("opacity-50");
            });
        });
    }

    function mostrarModalConfirmacionCompetencia(competencia, diaSemana) {
        if (!competencia) return;

        document.getElementById("nombreCompetenciaConfirm").textContent = competencia.Competencia;
        document.getElementById("totalResultadosConfirm").textContent = competencia.Resultados?.length || 0;
        document.getElementById("nombreDiaConfirm").textContent = diaSemana;

        window._competenciaPendiente = competencia;
        window._diaPendiente = diaSemana;

        const modal = new bootstrap.Modal(document.getElementById("modalConfirmCompetencia"));
        modal.show();
    }

    document.getElementById("btnConfirmAgregarCompetencia")
    ?.addEventListener("click", async () => {
        const competencia = window._competenciaPendiente;
        const diaSemana = window._diaPendiente;
        if (!competencia || !diaSemana) return;

        const asignacionId = nextId();

        const item = document.createElement("div");
        item.className = "asignacion asignacion-competencia border rounded p-2 mb-1 text-start";
        item.dataset.asignacionId = String(asignacionId);
        item.dataset.competencia = competencia.Competencia;
        item.dataset.resultado = competencia.Resultados?.[0] || "";
        item.dataset.dia = diaSemana;

        item.innerHTML = `
<div class="d-flex align-items-start justify-content-between gap-2">
    <div class="fw-semibold flex-grow-1">
        <span class="badge bg-success text-white me-1">Competencia</span>
        <i class="bi bi-bookmark-star text-success-emphasis me-1"></i>
        ${competencia.Competencia}
    </div>
    <div class="btn-group btn-group-sm">
        <button type="button" class="btn btn-link text-success p-0 edit-asig" title="Editar">
            <i class="bi bi-pencil-square"></i>
        </button>
        <button type="button" class="btn btn-link text-danger p-0 delete-asig" title="Eliminar">
            <i class="bi bi-trash"></i>
        </button>
    </div>
</div>
<div class="meta mt-1">
    <i class="bi bi-mortarboard"></i><span class="instructor">Seleccione instructor…</span>
    <span class="sep">•</span>
    <i class="bi bi-clock"></i><span class="horario">--:-- – --:--</span>
</div>`;

        const diaEl = document.querySelector(`.day-col[data-day="${diaSemana}"]`);
        if (diaEl) {
            diaEl.appendChild(item);
            updateDropHint(diaEl);
        }

        // Registramos UNA asignación que representa la competencia completa
        payload.asignaciones.push({
            id: asignacionId,
            competencia: competencia.Competencia,
            resultado: null,          // null → competencia completa
            dia: diaSemana,
            instructorId: null,
            instructorNombre: null,
            horaDesde: null,
            horaHasta: null
        });

        // Marcar visualmente
        marcarCompetenciaUsada(competencia.Competencia);
        marcarTodosResultadosDeCompetencia(competencia.Competencia);

        // Botones de editar/eliminar
        item.querySelector(".edit-asig")?.addEventListener("click", () => editarAsignacion(item));
        item.querySelector(".delete-asig")?.addEventListener("click", () => eliminarAsignacion(item));

        // Cerrar modal de confirmación
        const modalConfirm = bootstrap.Modal.getInstance(
            document.getElementById("modalConfirmCompetencia")
        );
        modalConfirm?.hide();

        // Abrir el modal de asignar horas/instructor
        await abrirModalAsignar({ asignacionId, itemEl: item });

        // Limpiar variables globales
        window._competenciaPendiente = null;
        window._diaPendiente = null;
    });


    // ========== AUTOCOMPLETADO FICHAS ==========
    function ocultarSugerencias() {
        fichaSugerencias.classList.add("d-none");
        fichaSugerencias.innerHTML = "";
    }


            function formatoFechaNet(fechaNet) {
                if (!fechaNet) return "";

                // espera formato /Date(1720414800000)/
                const m = /Date\((\d+)\)/.exec(fechaNet);
                if (!m) return "";

                const d = new Date(parseInt(m[1], 10));
                // ajusta a lo que quieras mostrar
                return d.toISOString().slice(0, 10); // "yyyy-MM-dd"
            }


    async function buscarFichasLectivas(term = "") {
        const anio = selAnio?.value?.trim();
        const trimestre = selTrimestreAnio?.value?.trim();

        fichaSugerencias.innerHTML = "";
        if (!anio || !trimestre) {
            fichaSugerencias.innerHTML = `
                <div class="list-group-item small text-muted">
                    ⚠️ Selecciona año y trimestre antes de buscar.
                </div>`;
            fichaSugerencias.classList.remove("d-none");
            return;
        }

        try {
            const url = '@Url.Action("GetFichasEnFormacion", "Home")'
                + `?term=${encodeURIComponent(term)}`
                + `&anio=${encodeURIComponent(anio)}`
                + `&trimestre=${encodeURIComponent(trimestre)}`;

            const resp = await fetch(url, { headers: { "Accept": "application/json" } });
            if (!resp.ok) throw new Error(`Error HTTP ${resp.status}`);

            const json = await resp.json();
            console.log("Fichas desde el servidor:", json);
            if (!json?.ok) throw new Error(json.msg || "No se pudieron obtener las fichas.");

            let fichas = json.data || [];

            if (term && fichas.length > 0) {
                const termLower = term.toLowerCase();
                fichas = fichas.filter(f =>
                    (f.CodigoFicha?.toString().toLowerCase().includes(termLower)) ||
                    (f.ProgramaNombre?.toLowerCase().includes(termLower))
                );
            }

            if (!fichas.length) {
                fichaSugerencias.innerHTML = `
                    <div class="list-group-item small text-muted">
                        Sin coincidencias…
                    </div>`;
                fichaSugerencias.classList.remove("d-none");
                return;
            }

            fichaSugerencias.innerHTML = "";
            fichas.forEach(f => {
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "list-group-item list-group-item-action";
                btn.innerHTML = `
                    <div><strong>${f.CodigoFicha}</strong> — ${f.ProgramaNombre}</div>
                    <small class="text-muted">
                        Trimestre ${f.TrimestreDeLaFicha ?? "?"}
                        • ${formatoFechaNet(f.FechaInicio)} - ${formatoFechaNet(f.FechaFin)}
                    </small>`;


                btn.addEventListener("click", async () => {
                    inputFicha.value = f.CodigoFicha;
                    hfFichaId.value = f.IdFicha;
                    inputPrograma.value = f.ProgramaNombre;
                    txtTrimestreFicha.value = f.TrimestreDeLaFicha ?? "";
                    actualizarSiguienteTrimestre();
                    ocultarSugerencias();

                    // bloquear trimestres del año ya usados por esta ficha en este año
                    await refrescarTrimestresAnioDisponibles();

                    // IMPORTANTÍSIMO: limpiar cache al cambiar de ficha
                    RESULTADOS_CACHE.clear();
                    PENDIENTES_SET.clear();

                    const anioSel = selAnio.value.trim();
                    const trimestreDestino = txtSiguienteTrimestre.value.trim();

                    // cargar pendientes para pintar naranja desde el primer render
                    await cargarPendientesAnterior(f.IdFicha, anioSel, trimestreDestino);

                    if (typeof cargarCompetenciasFicha === "function") {
                        await cargarCompetenciasFicha(f.IdFicha, trimestreDestino);
                    }
                });


                fichaSugerencias.appendChild(btn);
            });

            fichaSugerencias.classList.remove("d-none");
        } catch (err) {
            fichaSugerencias.innerHTML = `
                <div class="list-group-item small text-danger">
                    Error: ${err.message}
                </div>`;
            fichaSugerencias.classList.remove("d-none");
        }
    }

    inputFicha?.addEventListener("input", debounce(async () => {
        const q = inputFicha.value.trim();

        // 🔥 CASO CLAVE: borró la ficha
        if (!q) {
            resetFicha(false); // limpia TODO
            ocultarSugerencias();

            // desbloquear trimestres del año
            Array.from(selTrimestreAnio.options).forEach(o => {
                if (o.value) o.disabled = false;
            });

            return;
        }

        // mientras escribe pero aún no busca
        if (q.length < 2) {
            ocultarSugerencias();
            return;
        }

        await buscarFichasLectivas(q);
    }, 300));


    inputFicha?.addEventListener("focus", async () => {
        if (!selAnio.value || !selTrimestreAnio.value) {
            showAlert("Selecciona el año y trimestre antes de buscar fichas.", "warning");
            return;
        }
        await buscarFichasLectivas(inputFicha.value.trim());
    });

    document.addEventListener("click", e => {
        if (!fichaSugerencias.contains(e.target) && !inputFicha.contains(e.target)) {
            ocultarSugerencias();
        }
    });

        selAnio?.addEventListener("change", async () => {
            await refrescarTrimestresAnioDisponibles();
            await buscarFichasLectivas(inputFicha.value.trim());
        });

        // Aquí NO es obligatorio refrescar, porque el bloqueo depende de ficha+año.
        // Pero puedes dejarlo así sin problema:
        selTrimestreAnio?.addEventListener("change", () => buscarFichasLectivas(inputFicha.value.trim()));


    // ========== IMPORTAR EXCEL ==========
    btnCargarExcel?.addEventListener("click", () => {
        inputExcel.click();
    });

    inputExcel?.addEventListener("change", async function (e) {
        const file = e.target.files?.[0];
        if (!file) return;

        const anio = selAnio.value;
        const trimestreAnio = selTrimestreAnio.value;
        const idFicha = hfFichaId.value;

        if (!anio || !trimestreAnio || !idFicha) {
            showAlert("Debes seleccionar un Año, un Trimestre y una Ficha antes de importar.", "warning");
            e.target.value = "";
            return;
        }

        btnCargarExcel.innerHTML = `<i class="bi bi-hourglass-split me-1"></i> Cargando...`;
        btnCargarExcel.disabled = true;

        try {
            const fd = new FormData();
            fd.append("archivoExcel", file);
            fd.append("anio", anio);
            fd.append("trimestre", trimestreAnio);
            fd.append("idFicha", idFicha);

            const resp = await fetch('@Url.Action("ImportarExcel", "Home")', {
                method: "POST",
                body: fd
            });

            const data = await resp.json();
            if (!data.ok) throw new Error(data.msg || "Error al importar la planeación.");

            showAlert(data.msg, "success");

            if (Array.isArray(data.competencias) && data.competencias.length) {

                if (data.trimestreDestino) {
                    window.TRIMESTRE_DESTINO = data.trimestreDestino;

                    if (txtTrimestreFicha) {
                        txtTrimestreFicha.value = Math.max(1, data.trimestreDestino - 1);
                    }
                    if (txtSiguienteTrimestre) {
                        txtSiguienteTrimestre.value = data.trimestreDestino;
                    }

                    // ✅ cargar pendientes para que se pinten naranja
                    await cargarPendientesAnterior(idFicha, anio, String(data.trimestreDestino));
                    RESULTADOS_CACHE.clear();
                }

                mostrarCompetenciasCargadas(data.competencias);
            } else {
                const tDestino = data.trimestreDestino || window.TRIMESTRE_DESTINO;
                if (tDestino && typeof cargarCompetenciasFicha === "function") {
                    await cargarCompetenciasFicha(idFicha, tDestino);
                }
            }

        } catch (err) {
            showAlert(err.message, "danger");
        } finally {
            btnCargarExcel.disabled = false;
            btnCargarExcel.innerHTML = `<i class="bi bi-file-earmark-excel-fill me-1"></i> Cargar Planeación`;
            e.target.value = "";
        }
    });



    async function cargarFichaResumenParaModal(idFicha) {

        try {
            const resp = await fetch(`/Home/GetResumenFicha?idFicha=${idFicha}`);
            const json = await resp.json();

            if (!json.ok) {
                showAlert("⚠ No se pudo cargar el resumen de la ficha.", "warning");
                return false;
            }

            const f = json.data;

            document.getElementById("txtProgramaModal").value = f.Programa;
            document.getElementById("txtFichaModal").value = f.CodigoFicha;
            document.getElementById("txtFechaInicioModal").value = f.FechaInicio;
            document.getElementById("txtFechaFinModal").value = f.FechaFin;

            let trimestreDestino = (parseInt(f.TrimestreActual) >= 7)
                ? 7
                : parseInt(f.TrimestreActual) + 1;

            document.getElementById("txtTrimestreDestinoModal").value = trimestreDestino;

            return true;

        } catch (err) {
            console.error("Error cargarFichaResumenParaModal:", err);
            showAlert("⚠ No se pudo cargar toda la información de la ficha.", "warning");
            return false;
        }
    }


        const RESULTADOS_CACHE = new Map();
        function normKey(txt) {
            return (txt || "").trim().toLowerCase();
        }

        function renderCompetencias(list) {
            competenciasList.innerHTML = "";

            if (!Array.isArray(list) || list.length === 0) {
                competenciasList.innerHTML =
                    `<div class="text-muted text-center py-2">Sin competencias para mostrar.</div>`;
                return;
            }

            list.forEach((c, idx) => {
                const compId = `comp_${idx}`;
                const isOpen = OPEN_COMP_IDS.has(compId);
                const compTxt = (c.Competencia || "").trim();
                const isPendBlock = !!c._pendientes || /PENDIENTES/i.test(compTxt);
                const card = document.createElement("div");
                card.className = "card mb-2 border-0 shadow-sm";

                // ✅ Siempre pintamos un <ul>, aunque venga vacío
                const resultadosIniciales = Array.isArray(c.Resultados) ? c.Resultados : [];

                card.innerHTML = `
<div class="card-header d-flex justify-content-between align-items-start bg-white border-start border-4 border-success pointer ${isPendBlock ? "comp-pendiente" : ""}"
     role="button"
     aria-expanded="${isOpen}"
     aria-controls="${compId}">
    <span class="fw-bold text-sena comp-encabezado">${compTxt}</span>
    <i class="bi bi-chevron-down text-success fs-5 ${isOpen ? "rotate-180" : ""}"></i>
</div>

<div id="${compId}" class="collapse ${isOpen ? "show" : ""}">
    <div class="card-body pt-2 pb-2 ps-4">

        <div class="comp-resumen small text-muted mb-2 d-none"></div>

        <ul class="list-unstyled mb-0">
            ${resultadosIniciales.length
                        ? resultadosIniciales.map(r => `
                    <li class="resultado-item small text-muted border p-1 mb-1 rounded bg-light ${isPendBlock ? "resultado-pendiente" : ""}"
                        draggable="true"
                        data-competencia="${encodeURIComponent(compTxt)}"
                        data-resultado="${encodeURIComponent(r)}">
                        <i class="bi bi-arrows-move me-1 text-success"></i> ${r}
                    </li>`).join("")
                        : `<li class="small text-muted fst-italic">Expande para cargar resultados…</li>`
                    }
        </ul>

    </div>
</div>`;

                const collapseEl = card.querySelector(`#${compId}`);
                const headerEl = card.querySelector(".card-header");
                const chevron = card.querySelector(".bi-chevron-down");

                const bsCollapse = new bootstrap.Collapse(collapseEl, { toggle: false });

                if (headerEl.dataset.wiredClick !== "1") {
                    headerEl.dataset.wiredClick = "1";
                    headerEl.addEventListener("click", () => bsCollapse.toggle());
                }

                if (headerEl.dataset.wiredDbl !== "1") {
                    headerEl.dataset.wiredDbl = "1";
                    headerEl.addEventListener("dblclick", async (ev) => {
                        ev.preventDefault();
                        ev.stopPropagation();

                        const idFicha = (hfFichaId?.value || "").trim();
                        const trimestreAcad = (txtSiguienteTrimestre?.value || txtTrimestreFicha?.value || "").trim();

                        if (!idFicha || !trimestreAcad) {
                            showAlert("Selecciona ficha y trimestre primero.", "warning");
                            return;
                        }

                        if (typeof abrirDetalleCompetencia === "function") {
                            await abrirDetalleCompetencia(compTxt, idFicha, trimestreAcad);
                        }
                    });
                }

                collapseEl.addEventListener("shown.bs.collapse", async () => {
                    OPEN_COMP_IDS.add(compId);
                    chevron.classList.add("rotate-180");
                    headerEl.setAttribute("aria-expanded", "true");

                    const ul = collapseEl.querySelector("ul");
                    const resumenBox = collapseEl.querySelector(".comp-resumen");
                    if (!ul) return;

                    const key = normKey(compTxt);

                    // ✅ Si ya estaba cacheado, solo pinta
                    if (RESULTADOS_CACHE.has(key)) {
                        const cached = RESULTADOS_CACHE.get(key);
                        pintarResultadosEnUL(ul, compTxt, cached.data);
                        pintarResumenCompetencia(resumenBox, cached.resumen);
                        wireResultadosDrag();
                        refrescarUsos();
                        return;
                    }

                    ul.innerHTML = `
                <li class="small text-muted py-2">
                    <i class="bi bi-hourglass-split me-1"></i> Cargando resultados...
                </li>`;

                    try {
                        const info = await cargarResultadosCompetencia(compTxt);

                        if (!info || !Array.isArray(info.data)) {
                            ul.innerHTML = `<li class="small text-muted fst-italic">Sin resultados para esesta competencia.</li>`;
                            return;
                        }

                        // ✅ por seguridad, si backend no filtró:
                        const pendientes = info.data.filter(r => (r.HorasPendientes ?? 0) > 0);

                        if (!pendientes.length) {
                            ul.innerHTML = `<li class="small text-muted fst-italic">Competencia sin horas pendientes.</li>`;
                            return;
                        }

                        RESULTADOS_CACHE.set(key, { data: pendientes, resumen: info.resumen });
                        pintarResultadosEnUL(ul, compTxt, pendientes);
                        pintarResumenCompetencia(resumenBox, info.resumen);

                        wireResultadosDrag();
                        refrescarUsos();

                    } catch (err) {
                        ul.innerHTML = `
                    <li class="small text-danger">
                        Error cargando resultados: ${err.message || err}
                    </li>`;
                    }
                });

                collapseEl.addEventListener("hidden.bs.collapse", () => {
                    OPEN_COMP_IDS.delete(compId);
                    chevron.classList.remove("rotate-180");
                    headerEl.setAttribute("aria-expanded", "false");
                });

                competenciasList.appendChild(card);
            });

            wireResultadosDrag();
            wireCompetenciaDrag();
            refrescarUsos();
        }


        function pintarResultadosEnUL(ul, competenciaTxt, data) {
            ul.innerHTML = data.map(r => {
                const texto = (typeof r === "string") ? r : r.Resultado;

                const req = (typeof r === "string") ? null : (r.HorasRequeridas ?? 0);
                const prog = (typeof r === "string") ? null : (r.HorasProgramadas ?? 0);
                const pct = (typeof r === "string") ? null : (r.Porcentaje ?? 0);

                // ✅ naranja si viene como pendiente del trimestre anterior
                const esNaranja = PENDIENTES_SET.has(pendKey(competenciaTxt, texto));

                return `
                  <li class="resultado-item small text-muted border p-1 mb-1 rounded bg-light ${esNaranja ? "pendiente-naranja" : ""}"
                      draggable="true"
                      data-competencia="${encodeURIComponent(competenciaTxt)}"
                      data-resultado="${encodeURIComponent(texto)}">
                      <i class="bi bi-arrows-move me-1 text-success"></i>
                      ${texto}
                      ${req !== null
                                    ? `<div class="small text-secondary mt-1">Req: ${req}h · Prog: ${prog}h · ${pct}%</div>`
                                    : ``}
                  </li>`;
            }).join("");
        }


        function pintarResumenCompetencia(resumenBox, resumen) {
            if (!resumenBox) return;

            if (!resumen) {
                resumenBox.classList.add("d-none");
                resumenBox.innerHTML = "";
                return;
            }

            resumenBox.classList.remove("d-none");
            resumenBox.innerHTML = `
        <div class="alert alert-light border small py-2 mb-2">
            <strong>Total competencia:</strong>
            Req ${resumen.TotalRequeridas ?? 0}h ·
            Prog ${resumen.TotalProgramadas ?? 0}h ·
            Pend ${resumen.TotalPendientes ?? 0}h ·
            ${(resumen.Porcentaje ?? 0)}%
        </div>`;
        }


        function mostrarCompetenciasCargadas(competencias) {
            COMPETENCIAS = Array.isArray(competencias) ? competencias : [];
            OPEN_COMP_IDS = new Set();
            renderCompetencias(COMPETENCIAS);
        }

        txtSearch?.addEventListener("input", debounce(() => {
            const q = (txtSearch.value || "").trim().toLowerCase();
            if (!q) {
                renderCompetencias(COMPETENCIAS);
                return;
            }

            const filtered = COMPETENCIAS
                .map(c => {
                    const matchComp = (c.Competencia || "").toLowerCase().includes(q);
                    const resFiltrados = (c.Resultados || [])
                        .filter(r => (r || "").toLowerCase().includes(q));

                    if (matchComp) return { Competencia: c.Competencia, Resultados: c.Resultados || [] };
                    if (resFiltrados.length) return { Competencia: c.Competencia, Resultados: resFiltrados };
                    return null;
                })
                .filter(Boolean);

            OPEN_COMP_IDS = new Set(filtered.map((_, i) => `comp_${i}`));
            renderCompetencias(filtered);
        }, 200));


        // ========== ASIGNACIONES ==========
        function editarAsignacion(item) {
            const id = parseInt(item.dataset.asignacionId, 10);
            const a = payload.asignaciones.find(x => x.id === id);
            const preset = {
                instructorId: a?.instructorId ? String(a.instructorId) : "",
                horaDesde: a?.horaDesde || "06:00",
                horaHasta: a?.horaHasta || "09:00"
            };
            abrirModalAsignar({ asignacionId: id, itemEl: item }, preset);
        }

        function eliminarAsignacion(item) {
            const id = parseInt(item.dataset.asignacionId, 10);
            const col = item.closest(".day-col");

            payload.asignaciones = payload.asignaciones.filter(a => a.id !== id);
            item.remove();

            if (col) updateDropHint(col);

            // ✅ FIX: refrescar usados
            refrescarUsos();

            refrescarListaInstructoresEnHorario();
            mostrarInstructorActual();
            actualizarBarraHorario();
        }

        function parseHM(hhmm) {
            if (!hhmm || !/^\d{2}:\d{2}$/.test(hhmm)) return null;
            const [h, m] = hhmm.split(":").map(n => parseInt(n, 10));
            return h * 60 + m;
        }

        function rangosSePisan(d1, h1, d2, h2) {
            return d1 < h2 && d2 < h1;
        }

        function tieneConflictoEnDia({ dia, instructorId, desde, hasta, ignoreId = null }) {
            const d = parseHM(desde);
            const h = parseHM(hasta);
            if (d == null || h == null) return "Debes indicar un horario válido.";
            if (d >= h) return "La hora inicial debe ser menor que la final.";

            const choqueInstructor = payload.asignaciones.some(a =>
                a.dia === dia &&
                a.id !== ignoreId &&
                a.instructorId != null &&
                String(a.instructorId) === String(instructorId) &&
                rangosSePisan(parseHM(a.horaDesde), parseHM(a.horaHasta), d, h)
            );
            if (choqueInstructor) return "Ese instructor ya tiene una asignación en ese horario.";

            return null;
        }

        function tieneMismaFranjaMismoDia({ dia, instructorId, desde, hasta, ignoreId = null }) {
            const d = parseHM(desde);
            const h = parseHM(hasta);
            if (d == null || h == null) return false;

            return payload.asignaciones.some(a =>
                a.id !== ignoreId &&
                a.dia === dia &&
                a.instructorId != null &&
                String(a.instructorId) === String(instructorId) &&
                parseHM(a.horaDesde) === d &&
                parseHM(a.horaHasta) === h
            );
        }

    function marcarResultadoUsado(competencia, resultado) {
        if (!competencia || !resultado) return;

        const compEnc = encodeURIComponent(competencia);
        const resEnc  = encodeURIComponent(resultado);

        const selector = `.resultado-item[data-competencia="${compEnc}"][data-resultado="${resEnc}"]`;
        competenciasList
            .querySelectorAll(selector)
            .forEach(li => li.classList.add("resultado-usado"));
    }

    function marcarTodosResultadosDeCompetencia(competencia) {
        if (!competencia) return;
        const compEnc = encodeURIComponent(competencia);

        competenciasList
            .querySelectorAll(`.resultado-item[data-competencia="${compEnc}"]`)
            .forEach(li => li.classList.add("resultado-usado"));
    }

    function marcarCompetenciaUsada(competencia) {
        if (!competencia) return;

        competenciasList
            .querySelectorAll(".comp-encabezado")
            .forEach(span => {
                if (span.textContent.trim() === competencia.trim()) {
                    span.classList.add("competencia-usada");
                }
            });
    }

        function refrescarUsos() {

            // ✅ si aún no se ha guardado el horario completo,
            // no pintamos usados en la lista izquierda
            if (!APLICAR_USOS_EN_COMPETENCIAS) return;

            competenciasList
                .querySelectorAll(".resultado-usado, .competencia-usada")
                .forEach(el => el.classList.remove("resultado-usado", "competencia-usada"));

            payload.asignaciones.forEach(a => {
                if (a.resultado) {
                    marcarResultadoUsado(a.competencia, a.resultado);
                    marcarCompetenciaUsada(a.competencia);
                } else if (a.competencia) {
                    marcarCompetenciaUsada(a.competencia);
                    marcarTodosResultadosDeCompetencia(a.competencia);
                }
            });
        }

async function cargarCompetenciasFicha(idFicha, trimestreForzado = null) {

    let trimestre = trimestreForzado
        ? trimestreForzado
        : txtTrimestreFicha.value?.trim();

    if (!idFicha || !trimestre) {
        showAlert("No se puede cargar competencias sin seleccionar ficha y trimestre.", "warning");
        return;
    }

    competenciasList.innerHTML = `
        <div class="text-muted text-center py-2">
            <i class="bi bi-hourglass-split me-1"></i> Cargando competencias...
        </div>`;

    // ===============================
    // 1. Cargar competencias normales
    // ===============================
    let competencias = [];

    try {
        const url = '@Url.Action("GetCompetenciasPorTrimestre", "Home")'
            + `?idFicha=${idFicha}&trimestre=${trimestre}`;

        const resp = await fetch(url, {
            headers: { "Accept": "application/json" },
            credentials: "same-origin"
        });

        const json = await resp.json();

        if (!json.ok || !Array.isArray(json.data) || json.data.length === 0) {
            competenciasList.innerHTML = `
                <div class="text-muted text-center py-2">
                    Sin competencias para este trimestre.
                </div>`;
            return;
        }

        competencias = json.data.map(c => ({
            Competencia: (c.Competencia || "").trim(),
            Resultados: [...new Set((c.Resultados || []).map(r => (r || "").trim()))]
        })).filter(c => c.Competencia);

    } catch (err) {
        console.error("Error:", err);
        showAlert("Error cargando competencias: " + err.message, "danger");
        return;
    }

    // ==========================================
    // 2. Cargar pendientes del trimestre anterior
    // ==========================================
    const anioSel = (selAnio?.value || "").trim();
    const trimestreDestino = (trimestre || "").toString().trim();

    if (idFicha && anioSel && trimestreDestino) {
        try {
            const urlPend = `/Home/GetPendientesParaProximoTrimestre?idFicha=${idFicha}&anio=${anioSel}&trimestreDestino=${trimestreDestino}`;
            const respPend = await fetch(urlPend, { headers: { "Accept": "application/json" } });
            const jsonPend = await respPend.json();

            if (jsonPend.ok && Array.isArray(jsonPend.data) && jsonPend.data.length) {

                PENDIENTES_SET.clear();

                jsonPend.data.forEach(x => {
                    if (x.Competencia && x.Resultado) {
                        PENDIENTES_SET.add(pendKey(x.Competencia, x.Resultado));
                    }
                });

                const resultadosPend = jsonPend.data.map(p =>
                    `${p.Resultado} — Pendiente (${p.HorasFaltantes ?? 0}h)`
                );

                competencias.unshift({
                    Competencia: "🟧 PENDIENTES DEL TRIMESTRE ANTERIOR",
                    Resultados: resultadosPend
                });
            }
        } catch (e) {
            console.warn("Pendientes omitidos:", e.message);
        }
    }

    // ==========================
    // 3. Mostrar en pantalla
    // ==========================
    if (!competencias.length) {
        competenciasList.innerHTML =
            `<div class="text-muted text-center py-2">Sin competencias válidas para mostrar.</div>`;
        return;
    }

    mostrarCompetenciasCargadas(competencias);
}

        async function cargarPendientesAnterior(idFicha, anio, trimestreDestino) {
            PENDIENTES_SET.clear();

            const url = `/Home/GetPendientesParaProximoTrimestre?idFicha=${encodeURIComponent(idFicha)}&anio=${encodeURIComponent(anio)}&trimestreDestino=${encodeURIComponent(trimestreDestino)}`;
            const resp = await fetch(url);
            const json = await resp.json();

            if (!json || !json.ok || !Array.isArray(json.data)) return;

            json.data.forEach(x => {
                if (x.Resultado) {
                    PENDIENTES_SET.add(pendKey(x.Competencia, x.Resultado));
                }
            });
        }


        async function abrirDetalleCompetencia(nombreCompetencia, idFicha, trimestreAcad) {
            try {
                const url = '@Url.Action("GetResultadosPorCompetencia", "Home")'
                    + `?nombreCompetencia=${encodeURIComponent(nombreCompetencia)}`
                    + `&idFicha=${encodeURIComponent(idFicha)}`
                    + `&trimestreAcad=${encodeURIComponent(trimestreAcad)}`;

                const resp = await fetch(url, { headers: { "Accept": "application/json" }});
                const json = await resp.json();

                if (!json.ok) {
                    showAlert(json.msg || "No se pudo cargar detalle.", "danger");
                    return;
                }

                const data = json.data || [];
                const resumen = json.resumen;

                document.getElementById("tituloDetalleCompetencia").textContent =
                    `Competencia: ${resumen.Competencia} (T${trimestreAcad})`;

                document.getElementById("resumenCompetenciaBox").innerHTML = `
                    <div class="p-2 border rounded bg-light">
                        <div><strong>Total Requeridas:</strong> ${resumen.TotalRequeridas}h</div>
                        <div><strong>Total Programadas:</strong> ${resumen.TotalProgramadas}h</div>
                        <div><strong>Pendientes:</strong> ${resumen.TotalPendientes}h</div>
                        <div><strong>% Avance:</strong> ${resumen.Porcentaje}%</div>
                    </div>
                `;

                const tbody = document.getElementById("tbodyDetalleCompetencia");
                tbody.innerHTML = "";

                data.forEach(r => {
                    const tr = document.createElement("tr");
                    tr.innerHTML = `
                        <td>${r.Resultado}</td>
                        <td class="text-center">${r.HorasRequeridas}</td>
                        <td class="text-center">${r.HorasProgramadas}</td>
                        <td class="text-center">${r.HorasPendientes}</td>
                        <td class="text-center">${r.Porcentaje}%</td>`;
                    tbody.appendChild(tr);
                });

                new bootstrap.Modal(document.getElementById("modalDetalleCompetencia")).show();

            } catch (err) {
                showAlert("Error cargando detalle competencia: " + err.message, "danger");
            }
        }

        btnGuardarHorario?.addEventListener("click", async () => {

            if (!payload.asignaciones || !payload.asignaciones.length) {
                showAlert("No hay asignaciones para guardar.", "warning");
                return;
            }

            const idFichaSeleccionada = hfFichaId.value;
            if (!idFichaSeleccionada) {
                showAlert("Debes seleccionar una ficha antes de guardar el horario.", "warning");
                return;
            }

            const originalHTML = btnGuardarHorario.innerHTML;
            btnGuardarHorario.disabled = true;
            btnGuardarHorario.innerHTML = `<i class="bi bi-hourglass-split me-2"></i> Cargando...`;

            try {
                await cargarInstructoresLider();

                const ok = await cargarFichaResumenParaModal(idFichaSeleccionada);
                if (!ok) {
                    showAlert("⚠ No se pudo cargar toda la información de la ficha, pero puedes continuar.", "warning");
                }

                const modalEl = document.getElementById("modalLider");
                const modal = new bootstrap.Modal(modalEl, { keyboard: false, backdrop: "static" });
                modal.show();

            } catch (err) {
                console.error("Error en btnGuardarHorario:", err);
                showAlert("Error preparando el modal: " + (err.message || err), "danger");

            } finally {
                btnGuardarHorario.disabled = false;
                btnGuardarHorario.innerHTML = originalHTML;
            }
        });


    btnConfirmarLider?.addEventListener("click", async () => {
        const idInstructorLider = hfInstructorLiderId.value;

        if (!idInstructorLider) {
            showAlert("Debes seleccionar un instructor líder.", "warning");
            return;
        }

        const codigoFicha =
            (inputFicha.value || "").trim() ||
            (document.getElementById("txtFichaModal")?.value || "").trim();

        if (!codigoFicha) {
            showAlert("Debes seleccionar una ficha antes de guardar el horario.", "warning");
            return;
        }

        // 👇 ESTE es el trimestre académico destino que ve el usuario en el modal
        const trimestreDestino =
            (document.getElementById("txtTrimestreDestinoModal")?.value ||
             txtSiguienteTrimestre.value || "")
            .toString().trim();

        btnConfirmarLider.disabled = true;
        const originalConfirmHTML = btnConfirmarLider.innerHTML;
        btnConfirmarLider.innerHTML =
            `<i class="bi bi-hourglass-split me-2"></i> Guardando...`;

        try {
            const fd = new FormData();
            fd.append("__RequestVerificationToken", getAntiForgeryToken());
            fd.append("AsignacionesJson", JSON.stringify(payload.asignaciones));
            fd.append("numeroFicha", codigoFicha);
            fd.append("nombreHorario", `Horario ${codigoFicha} - T${trimestreDestino}`);

            fd.append("trimestreFicha", trimestreDestino);                 // 1–7 (académico)
            fd.append("anio", selAnio.value.trim());                       // 2026
            fd.append("trimestreAnio", selTrimestreAnio.value.trim());     // 1–4

            fd.append("idInstructorLider", idInstructorLider);

            fd.append("ProgramaNombre", document.getElementById("txtProgramaModal")?.value || "");
            fd.append("FechaInicioFicha", document.getElementById("txtFechaInicioModal")?.value || "");
            fd.append("FechaFinFicha", document.getElementById("txtFechaFinModal")?.value || "");

            const resp = await fetch('@Url.Action("GuardarHorario", "Home")', {
                method: "POST",
                body: fd,
                credentials: "same-origin"
            });

            const json = await resp.json();

            if (json.ok) {
                showAlert(json.msg, "success");
                APLICAR_USOS_EN_COMPETENCIAS = true;
                refrescarUsos();

                const modalInstance = bootstrap.Modal.getInstance(document.getElementById("modalLider"));
                if (modalInstance) modalInstance.hide();

                setTimeout(() => {
                    window.location.href = '@Url.Action("ListaHorarios", "Home")';
                }, 1500);
            } else {
                showAlert(json.msg || "Error guardando horario.", "danger");
            }
        } catch (err) {
            console.error("Error en btnConfirmarLider:", err);
            showAlert("Error enviando la solicitud: " + err.message, "danger");
        } finally {
            btnConfirmarLider.disabled = false;
            btnConfirmarLider.innerHTML = originalConfirmHTML;
        }
    });


        function resetFicha(parcial = false) {
            if (!parcial) {
                inputFicha.value = "";
                hfFichaId.value = "";
                inputPrograma.value = "";
                txtTrimestreFicha.value = "";
                txtSiguienteTrimestre.value = "";
            }

            competenciasList.innerHTML = "";
            payload.asignaciones = [];
            document.querySelectorAll(".day-col").forEach(col => {
                col.innerHTML = `<small class="text-muted drop-hint">Suelta aquí</small>`;
            });
            initDropHints();
        }


        selAnio.addEventListener("change", async () => {
            resetFicha(true); // limpia horario/competencias pero mantiene ficha
            await refrescarTrimestresAnioDisponibles();
        });

        selTrimestreAnio.addEventListener("change", () => {
            resetFicha(true);
        });



    // ========== TRIMESTRE SIGUIENTE ==========
    function actualizarSiguienteTrimestre() {
        const actual = parseInt(txtTrimestreFicha.value || "0");
        if (!actual || isNaN(actual)) {
            txtSiguienteTrimestre.value = "";
            return;
        }
        // ✅ FIX: 7 se queda en 7
        const siguiente = actual >= 7 ? 7 : actual + 1;
        txtSiguienteTrimestre.value = siguiente;
    }

    txtTrimestreFicha.addEventListener("change", actualizarSiguienteTrimestre);


      // ========== VALIDACIÓN EN VIVO EN MODAL ==========
    validarEnVivo._callId = 0;

    async function validarEnVivo() {
        if (!dropContext) return;

        const alertaChoque = document.getElementById("alertChoque");
        const instructorId = hfInstructorIdSeleccionado.value;
        const horaDesde = horaDesdeEl.value;
        const horaHasta = horaHastaEl.value;
        const idFicha = payload.idFichaActual || hfFichaId.value || null;

        if (!instructorId || !horaDesde || !horaHasta) {
            alertaChoque.classList.add("d-none");
            return;
        }

        const asignacion = payload.asignaciones.find(a => a.id === dropContext.asignacionId);
        const dia = asignacion?.dia || dropContext.itemEl.dataset.dia;

        const conflictoLocal = tieneConflictoEnDia({
            dia,
            instructorId,
            desde: horaDesde,
            hasta: horaHasta,
            ignoreId: dropContext.asignacionId
        });

        if (conflictoLocal) {
            alertaChoque.textContent = "❌ " + conflictoLocal;
            alertaChoque.classList.remove("d-none");
            return;
        }

        const myCallId = ++validarEnVivo._callId;

        async function getJson(url, params) {
            const qs = Object.keys(params)
                .map(k => `${encodeURIComponent(k)}=${encodeURIComponent(params[k])}`)
                .join("&");

            const resp = await fetch(`${url}?${qs}`, { credentials: "same-origin" });
            const text = await resp.text();

            try {
                return JSON.parse(text);
            } catch {
                throw new Error("Respuesta no JSON: " + text.substring(0, 200));
            }
        }

        try {
            async function getJson(url, params) {
                const qs = new URLSearchParams(params).toString();
                const resp = await fetch(`${url}?${qs}`, { credentials: "same-origin" });
                return await resp.json();
            }

            // uso:
            const respBD = await getJson('/Home/ValidarFranjaExactaInstructor', {
                idInstructor: instructorId, dia, desde: horaDesde, hasta: horaHasta, idFichaActual: idFicha
            });

            if (myCallId !== validarEnVivo._callId) return;

            if (!respBD.ok || respBD.choque) {
                alertaChoque.textContent =
                    respBD.msg || "❌ Choque de horario en la base de datos.";
                alertaChoque.classList.remove("d-none");
                return;
            }
        } catch (err) {
            alertaChoque.textContent = "Error validando BD: " + (err.message || err);
            alertaChoque.classList.remove("d-none");
            return;
        }

        try {
            const respGlobal = await getJson("/Home/ValidarChoqueInstructorGlobal", {
                idInstructor: instructorId,
                dia: dia,
                desde: horaDesde,
                hasta: horaHasta,
                idFichaActual: idFicha || 0
            });

            if (myCallId !== validarEnVivo._callId) return;

            if (!respGlobal.ok || respGlobal.choque) {
                alertaChoque.textContent =
                    respGlobal.msg ||
                    "❌ Este instructor ya tiene una clase en otra ficha en este horario.";
                alertaChoque.classList.remove("d-none");
                return;
            }

            alertaChoque.classList.add("d-none");

        } catch (err) {
            alertaChoque.textContent =
                "Error validando horario global: " + (err.message || err);
            alertaChoque.classList.remove("d-none");
        }
    }


        function actualizarBarraHorario() {

            if (dropContext) {
                const asignacion = payload.asignaciones.find(a => a.id === dropContext.asignacionId);
                if (asignacion) {
                    asignacion.horaDesde = horaDesdeEl.value;
                    asignacion.horaHasta = horaHastaEl.value;
                }
            }

            const barra = document.getElementById("barraHorario");
            const lbl = document.getElementById("lblHorasHorario");

            let minutos = 0;

            for (const a of payload.asignaciones) {
                if (!a.horaDesde || !a.horaHasta) continue;

                const d = parseHM(a.horaDesde);
                const h = parseHM(a.horaHasta);

                minutos += (h - d);
            }

            const horas = (minutos / 60) * 12;
            const pct = Math.min(100, Math.round((horas / 440) * 100));

            lbl.textContent = `${horas.toFixed(1)} horas programadas`;
            barra.style.width = pct + "%";
            barra.textContent = pct + "%";

            barra.className = "progress-bar fw-bold";

            if (pct < 60) barra.classList.add("bg-horario-ok");
            else if (pct < 80) barra.classList.add("bg-horario-aviso");
            else if (pct <= 100) barra.classList.add("bg-horario-peligro");
            else barra.classList.add("bg-horario-rojo");

            mostrarInstructorActual();
        }

        function actualizarBarraInstructor() {
            const barra = document.getElementById("barraInstructor");
            const lblHoras = document.getElementById("lblHorasInstructor");
            const lblMax = document.getElementById("lblMaxInstructor");
            const estado = document.getElementById("estadoInstructor");

            if (!INSTRUCTORES_EN_HORARIO.length) {
                lblHoras.textContent = "0 horas";
                lblMax.textContent = "Máximo: 0h";
                barra.style.width = "0%";
                barra.textContent = "0%";
                barra.className = "progress-bar fw-bold bg-inst-ok";
                estado.textContent = "Sin instructor seleccionado";
                return;
            }

            const id = INSTRUCTORES_EN_HORARIO[indexInstructorActual];
            const max = window._horasInstructorMax || 0;
            const base = window._horasInstructorActual || 0;
            const nuevas = calcularHorasAsignadasAInstructor(id);

            const total = base + nuevas;

            const pct = max > 0
                ? Math.min(100, Math.round((total / max) * 100))
                : 0;

            lblHoras.textContent = `${total.toFixed(1)} horas`;
            lblMax.textContent = `Máximo: ${max}h`;

            barra.style.width = pct + "%";
            barra.textContent = pct + "%";

            barra.className = "progress-bar fw-bold";
            estado.textContent = "";

            if (pct < 70) {
                barra.classList.add("bg-inst-ok");
                estado.textContent = "";
                estado.className = "text-muted mt-1 d-block";
            }
            else if (pct < 90) {
                barra.classList.add("bg-inst-aviso");
                estado.textContent = "Se acerca al límite permitido.";
                estado.className = "text-warning fw-bold mt-1 d-block";
            }
            else if (pct < 100) {
                barra.classList.add("bg-inst-alto");
                estado.textContent = "Muy cerca del límite máximo.";
                estado.className = "text-danger fw-bold mt-1 d-block";
            }
            else {
                barra.classList.add("bg-inst-max");
                estado.textContent = "Límite superado.";
                estado.className = "text-danger fw-bold mt-1 d-block";
            }
        }

        function calcularHorasAsignadasAInstructor(idInstructor) {
            let minutos = 0;

            for (const a of payload.asignaciones) {
                if (String(a.instructorId) !== String(idInstructor)) continue;
                if (!a.horaDesde || !a.horaHasta) continue;

                const d = parseHM(a.horaDesde);
                const h = parseHM(a.horaHasta);

                minutos += (h - d);
            }

            const horasSimples = minutos / 60;
            return horasSimples * 12;
        }

        function refrescarListaInstructoresEnHorario() {
            const ids = new Set();

            for (const a of payload.asignaciones) {
                if (a.instructorId) ids.add(String(a.instructorId));
            }

            INSTRUCTORES_EN_HORARIO = Array.from(ids);
            if (indexInstructorActual >= INSTRUCTORES_EN_HORARIO.length)
                indexInstructorActual = 0;
        }

        async function mostrarInstructorActual() {
            refrescarListaInstructoresEnHorario();

            const lblNombre = document.getElementById("nombreInstructorActual");

            if (INSTRUCTORES_EN_HORARIO.length === 0) {
                lblNombre.textContent = "Sin instructores asignados";
                actualizarBarraInstructor();
                return;
            }

            const id = INSTRUCTORES_EN_HORARIO[indexInstructorActual];
            lblNombre.textContent = INSTRUCTORES_BY_ID.get(id) || "Instructor";

            await cargarHorasInstructor(id);
            actualizarBarraInstructor();
        }

        document.getElementById("btnPrevInstructor").addEventListener("click", () => {
            if (INSTRUCTORES_EN_HORARIO.length === 0) return;

            if (INSTRUCTORES_EN_HORARIO.length > 1) {
                indexInstructorActual =
                    (indexInstructorActual - 1 + INSTRUCTORES_EN_HORARIO.length) %
                    INSTRUCTORES_EN_HORARIO.length;
            }

            mostrarInstructorActual();
        });

        document.getElementById("btnNextInstructor").addEventListener("click", () => {
            if (INSTRUCTORES_EN_HORARIO.length === 0) return;

            if (INSTRUCTORES_EN_HORARIO.length > 1) {
                indexInstructorActual =
                    (indexInstructorActual + 1) % INSTRUCTORES_EN_HORARIO.length;
            }

            mostrarInstructorActual();
        });

        // ========== MODAL HORARIO INSTRUCTOR ==========

        document.getElementById("btnVerHorarioInstructor")?.addEventListener("click", function () {
            const id = hfInstructorIdSeleccionado.value;
            if (!id) {
                showAlert("Por favor, selecciona un instructor primero.", "warning");
                return;
            }

            const nombre = INSTRUCTORES_BY_ID.get(String(id)) || "Instructor";
            abrirModalHorarioInstructor(id, nombre);
        });

                hfInstructorIdSeleccionado?.addEventListener("change", function () {
                instructorSeleccionadoId = this.value;
                const option = this.options[this.selectedIndex];
                instructorSeleccionadoNombre = option.text;

                const btnVerHorario = document.getElementById("btnVerHorarioInstructor");
                if (btnVerHorario) {
                    btnVerHorario.disabled = !instructorSeleccionadoId;
                    if (instructorSeleccionadoId) {
                        btnVerHorario.title = `Ver horario de ${instructorSeleccionadoNombre}`;
                    } else {
                        btnVerHorario.title = "Selecciona un instructor primero";
                    }
                }
            });

            document.getElementById("btnVerHorarioInstructor")?.addEventListener("click", function () {
                if (!instructorSeleccionadoId) {
                    showAlert("Por favor, selecciona un instructor primero.", "warning");
                    return;
                }

                abrirModalHorarioInstructor(instructorSeleccionadoId, instructorSeleccionadoNombre);
            });

      async function abrirModalHorarioInstructor(instructorId, instructorNombre) {
        try {
            instructorSeleccionadoId = instructorId;
            instructorSeleccionadoNombre = instructorNombre;

            const modal = document.getElementById("modalHorarioInstructor");
            const titulo = document.getElementById("modalHorarioInstructorTitle");
            const contenido = document.getElementById("contenidoHorarioInstructor");

            titulo.textContent = `Horario de ${instructorNombre}`;
            contenido.innerHTML = `<div class="text-center py-3">Cargando horario...</div>`;

            await cargarVistaHorarioInstructor(instructorId, contenido);

            const modalInstance = new bootstrap.Modal(modal);
            modalInstance.show();

            posicionarModalAlLado();
        } catch (err) {
            console.error("Error abriendo modal:", err);
            mostrarNotificacion("Error al abrir el horario: " + err.message, "danger");
        }
    }

    async function cargarVistaHorarioInstructor(instructorId, contenedor) {
        try {
            const resp = await fetch(`/Home/GetHorariosInstructores?idInstructor=${instructorId}`);
            const json = await resp.json();

            if (!json.ok) {
                contenedor.innerHTML = `<div class="alert alert-danger">${json.msg || "Error al cargar datos"}</div>`;
                return;
            }

            const asignaciones = json.data || [];

            const diasSemana = ["Lunes", "Martes", "Miercoles", "Jueves", "Viernes", "Sabado"];
            let html = `<div class="row px-2">`;

            diasSemana.forEach(dia => {
                const registros = asignaciones.filter(a => a.Dia === dia);

                html += `
                    <div class="col-4 mb-3">
                        <div class="card p-2 shadow-sm" style="border-left: 4px solid #0d6efd;">
                            <h6 class="text-success fw-bold mb-2">${dia}</h6>
                `;

                if (registros.length === 0) {
                    html += `<div class="text-muted small">Sin asignaciones</div>`;
                } else {
                    registros.forEach(r => {
                        html += `
                            <div class="border rounded p-2 mb-2 bg-light">
                                <div><strong>${r.HoraDesde} - ${r.HoraHasta}</strong></div>
                                <div class="small">Ficha: ${r.CodigoFicha}</div>
                            </div>
                        `;
                    });
                }

                html += `</div></div>`;
            });

            html += `</div>`;

            contenedor.innerHTML = html;

        } catch (err) {
            contenedor.innerHTML = `<div class="alert alert-danger">Error: ${err.message}</div>`;
            console.error("Error cargando horario instructor:", err);
        }
    }

       function posicionarModalAlLado() {

            try {
                const modalAsignarDialog = document.querySelector('#modalAsignar .modal-dialog');
                const modalHorarioDialog = document.querySelector('#dialogHorarioInstructor');

                if (!modalAsignarDialog || !modalHorarioDialog) return;

                const rect = modalAsignarDialog.getBoundingClientRect();

                modalHorarioDialog.style.position = 'fixed';
                modalHorarioDialog.style.margin = '0';
                modalHorarioDialog.style.transform = 'none';
                modalHorarioDialog.style.zIndex = '2000';

                modalHorarioDialog.style.top = (rect.bottom + 12) + "px";
                modalHorarioDialog.style.left = rect.left + "px";

                modalHorarioDialog.style.width = "450px";
                modalHorarioDialog.style.maxWidth = "450px";

            } catch (err) {
                console.error("Error posicionando modal instructor:", err);
            }
        }


            document.getElementById('modalHorarioInstructor')?.addEventListener('hidden.bs.modal', function () {
                instructorSeleccionadoId = null;
                instructorSeleccionadoNombre = null;

                if (document.querySelectorAll('.modal.show').length === 0) {
                    document.body.classList.remove('modal-open');
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    backdrops.forEach(b => b.remove());
                }
            });

            window.addEventListener('resize', function () {
                if (modalHorarioInstance && modalAsignarInstance) {
                    const modalHorario = document.getElementById('modalHorarioInstructor');
                    const modalAsignar = document.getElementById('modalAsignar');

                    if (modalHorario.classList.contains('show') && modalAsignar.classList.contains('show')) {
                        posicionarModalAlLado();
                    }
                }
            });

            // ========== INICIALIZACIÓN ==========
            // ✅ BIEN
            (async function init() {
                initDropHints();
                wireDayDropZones();
                await cargarHorariosGlobales();
        })();

    </script>
}