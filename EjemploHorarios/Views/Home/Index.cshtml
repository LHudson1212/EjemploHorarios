@model EjemploHorarios.Models.ViewModels.PlanificacionVM
@using System.Web.Helpers

@{
    ViewBag.Title = "Gestión de Horarios - SENA";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<!-- ========================= CSS / ESTILOS ========================= -->
<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />

<style>
    /* ====================================================================
                   SISTEMA DE GESTIÓN DE HORARIOS SENA - ESTILOS ULTRA MEJORADOS
                   (Aplicados al código funcional existente)
               ==================================================================== */

    /* ====== Variables de tema ====== */
    :root {
        /* Colores principales SENA con más variantes */
        --sena-green: #008037;
        --sena-green-light: #00a859;
        --sena-green-dark: #006028;
        --sena-green-ultra-light: #e6f7ed;
        --sena-green-glow: rgba(0, 168, 89, 0.4);
        /* Colores de texto */
        --sena-ink: #1f2937;
        --sena-muted: #6b7280;
        --sena-light: #9ca3af;
        /* Colores por día */
        --day-lunes: linear-gradient(135deg, #00a859 0%, #00c96d 100%);
        --day-lunes-solid: #00a859;
        --day-martes: linear-gradient(135deg, #0091ea 0%,#00b0ff 100%);
        --day-martes-solid: #0091ea;
        --day-miercoles: linear-gradient(135deg, #ff9800 0%, #ffb74d 100%);
        --day-miercoles-solid: #ff9800;
        --day-jueves: linear-gradient(135deg, #d81b60 0%, #f06292 100%);
        --day-jueves-solid: #d81b60;
        --day-viernes: linear-gradient(135deg, #8e24aa 0%, #ab47bc 100%);
        --day-viernes-solid: #8e24aa;
        --day-sabado: linear-gradient(135deg, #5d4037 0%, #795548 100%);
        --day-sabado-solid: #5d4037;
        /* Sombras */
        --shadow-xs: 0 1px 4px rgba(0, 0, 0, 0.02);
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.12);
        --shadow-xl: 0 12px 32px rgba(0, 0, 0, 0.16);
        --shadow-2xl: 0 20px 48px rgba(0, 0, 0, 0.2);
        --shadow-glow: 0 0 20px var(--sena-green-glow);
        /* Efectos */
        --ring: 0 0 0 4px rgba(0, 128, 55, 0.15);
        --ring-success: 0 0 0 4px rgba(0, 168, 89, 0.25);
        --backdrop-blur: blur(16px);
        --backdrop-blur-strong: blur(24px);
        /* Transiciones */
        --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-base: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-slow: 500ms cubic-bezier(0.4, 0, 0.2, 1);
        --transition-bounce: 600ms cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    * {
        box-sizing: border-box;
    }

    html {
        scroll-behavior: smooth;
        font-size: 16px;
    }

    body {
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
        color: var(--sena-ink);
        background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 50%, #f0fdf4 100%);
        background-size: 200% 200%;
        animation: gradientShift 15s ease infinite;
        min-height: 100vh;
        position: relative;
        overflow-x: hidden;
    }

    @@keyframes gradientShift {
        0%, 100% {
            background-position: 0% 50%
        }

        50% {
            background-position: 100% 50%
        }
    }

    {
        background-position: 0% 50%
    }

    50% {
        background-position: 100% 50%
    }

    }

    /* Utilitarios */
    .border-sena {
        border-color: var(--sena-green) !important;
    }

    .bg-sena {
        background: linear-gradient(135deg, var(--sena-green) 0%, var(--sena-green-light) 100%) !important;
        color: #fff;
        box-shadow: var(--shadow-md);
        position: relative;
        overflow: hidden;
    }

        .bg-sena::before {
            content: "";
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255,255,255,.15) 0%, transparent 70%);
            animation: shimmer 4s ease-in-out infinite;
        }

    .text-sena {
        color: var(--sena-green) !important;
        font-weight: 600;
    }

    .pointer {
        cursor: pointer;
    }

    @@keyframes shimmer {
        from {
            transform: translate(-50%,-50%) rotate(0)
        }

        to {
            transform: translate(-50%,-50%) rotate(360deg)
        }
    }

    {
        transform: translate(-50%,-50%) rotate(0)
    }

    to {
        transform: translate(-50%,-50%) rotate(360deg)
    }

    }

    /* Tarjetas / contenedores */
    .card {
        border-radius: 1.25rem;
        box-shadow: var(--shadow-md);
        border: 1px solid rgba(0,128,55,.1);
        background: rgba(255,255,255,.98);
        backdrop-filter: var(--backdrop-blur);
        transition: all var(--transition-base);
        overflow: hidden;
    }

        .card:hover {
            box-shadow: var(--shadow-xl), var(--shadow-glow);
            transform: translateY(-4px) scale(1.01);
            border-color: rgba(0,128,55,.2);
        }

    .card-header {
        border: 0;
        font-weight: 700;
        padding: 1.25rem 1.5rem;
    }

    /* Header principal */
    header {
        position: relative;
        padding: 1.5rem 0;
        margin-bottom: .5rem;
    }

        header h2 {
            font-size: 2.2rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--sena-green) 0%, var(--sena-green-light) 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: .25rem;
        }

    /* Controles */
    .form-label {
        font-weight: 700;
        color: var(--sena-green);
        margin-bottom: .55rem;
        font-size: .95rem;
        letter-spacing: .3px;
        display: flex;
        align-items: center;
        gap: .5rem;
    }

        .form-label::before {
            content: '';
            width: 4px;
            height: 16px;
            background: linear-gradient(180deg, var(--sena-green) 0%, var(--sena-green-light) 100%);
            border-radius: 2px;
        }

    .form-control, .form-select {
        border-radius: .85rem;
        border: 2px solid #e5e7eb;
        padding: .7rem 1rem;
        transition: all var(--transition-base);
        background: #fff;
        font-size: .95rem;
        box-shadow: var(--shadow-xs);
    }

        .form-control:focus, .form-select:focus {
            border-color: var(--sena-green);
            box-shadow: var(--ring), var(--shadow-md);
            outline: none;
            transform: translateY(-1px);
        }

    /* Botones */
    .btn {
        border-radius: .85rem;
        padding: .7rem 1.5rem;
        font-weight: 600;
        transition: all var(--transition-base);
        border: none;
        letter-spacing: .4px;
        box-shadow: var(--shadow-sm);
    }

    .btn-success {
        background: linear-gradient(135deg, var(--sena-green) 0%, var(--sena-green-light) 100%);
        color: #fff;
    }

        .btn-success:hover {
            background: linear-gradient(135deg, var(--sena-green-dark) 0%, var(--sena-green) 100%);
            box-shadow: var(--shadow-lg), var(--shadow-glow);
            transform: translateY(-3px) scale(1.02);
        }

    .btn-outline-success {
        border: 2px solid var(--sena-green);
        color: var(--sena-green);
        background: transparent;
    }

        .btn-outline-success:hover {
            background: var(--sena-green);
            color: #fff;
        }

    /* Zona de días */
    .day-col {
        min-height: 500px;
        background: linear-gradient(180deg, rgba(246, 255, 246, .9) 0%, rgba(255,255,255,.95) 100%);
        border: 3px dashed #b6e4c3;
        border-radius: 1.25rem;
        padding: 1.25rem;
        transition: all var(--transition-base);
        position: relative;
        backdrop-filter: var(--backdrop-blur);
        box-shadow: var(--shadow-xs);
    }

        .day-col.dragover {
            background: linear-gradient(180deg, rgba(234,255,234,.98) 0%, rgba(246,255,246,.98) 100%);
            transform: scale(1.02);
            border-color: var(--sena-green);
            border-style: solid;
            box-shadow: var(--ring-success), var(--shadow-xl), var(--shadow-glow);
        }

        .day-col small.text-muted {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%,-50%);
            color: var(--sena-light);
            font-size: .9rem;
            text-align: center;
            pointer-events: none;
            opacity: .6;
            font-weight: 600;
        }

    /* Tarjeta de evento */
    .event-card {
        border-left: 5px solid var(--sena-green);
        background: #fff;
        padding: 1rem;
        border-radius: 1rem;
        box-shadow: var(--shadow-sm);
        margin-bottom: 1rem;
        font-size: .95rem;
        text-align: left;
        transition: all var(--transition-base);
        position: relative;
    }

        .event-card:hover {
            transform: translateY(-4px) translateX(3px) scale(1.01);
            box-shadow: var(--shadow-lg);
        }

        .event-card small {
            display: block;
            color: var(--sena-muted);
            font-size: .86rem;
        }

        .event-card .btn {
            opacity: 0;
            transform: scale(.9) translateY(5px);
            transition: all var(--transition-bounce);
        }

        .event-card:hover .btn {
            opacity: 1;
            transform: scale(1) translateY(0);
        }

    /* Chips (competencias) */
    .chip {
        display: inline-flex;
        align-items: center;
        gap: .6rem;
        padding: .5rem 1rem;
        border-radius: 999px;
        border: 2px solid #e5e7eb;
        background: linear-gradient(135deg, #fff 0%, #f9fafb 100%);
        font-size: .9rem;
        margin: .35rem .45rem .35rem 0;
        cursor: grab;
        transition: all var(--transition-base);
        font-weight: 500;
        box-shadow: var(--shadow-sm);
    }

        .chip:hover {
            box-shadow: var(--shadow-md), var(--shadow-glow);
            transform: translateY(-3px) scale(1.03);
            border-color: var(--sena-green-light);
        }

        .chip small {
            color: var(--sena-muted);
            font-weight: 600;
            font-size: .82rem;
        }

    /* Autocomplete */
    .autocomplete-list {
        position: absolute;
        left: 0;
        right: 0;
        top: calc(100% + .6rem);
        z-index: 1055;
        max-height: 320px;
        overflow-y: auto;
        border-radius: 1rem;
        border: 2px solid var(--sena-green-light);
        background: rgba(255,255,255,.98);
        box-shadow: var(--shadow-2xl);
    }

    .list-group-item-action {
        padding: .85rem 1.25rem;
        border: none;
        border-bottom: 1px solid #f3f4f6;
    }

        .list-group-item-action:hover {
            background: linear-gradient(90deg, rgba(234,255,234,.9) 0%, rgba(246,255,246,.5) 100%);
            color: var(--sena-green);
            font-weight: 600;
            padding-left: 1.5rem;
        }

    #fichaSugerencias.d-none {
        display: none;
    }

    /* Tabla */
    .table thead th {
        position: sticky;
        top: 0;
        z-index: 10;
        background: linear-gradient(135deg, var(--sena-green) 0%, var(--sena-green-light) 100%);
        color: #fff;
        font-weight: 700;
        padding: 1.25rem;
        border: none;
        letter-spacing: 1px;
    }

    /* Alertas */
    .floating-alert {
        position: fixed;
        top: 2rem;
        right: 2rem;
        z-index: 3000 !important; /* 🔥 Ahora siempre encima del modal */
        min-width: 360px;
        max-width: 480px;
        box-shadow: var(--shadow-2xl);
        border-radius: 1.25rem;
        overflow: hidden;
        border: none;
    }


        .floating-alert .progress {
            height: 4px;
            background: rgba(0,0,0,.08);
            border-radius: 0;
        }

        .floating-alert .progress-bar {
            background: linear-gradient(90deg, var(--sena-green) 0%, var(--sena-green-light) 100%);
            transition: width 100ms linear;
            box-shadow: 0 0 10px rgba(0,168,89,.5);
        }

    /* Resultado ya usado en el horario */
    .resultado-usado {
        background: #dcfce7 !important; /* verde clarito */
        border-color: #16a34a !important; /* borde verde */
        color: #166534 !important; /* texto verde más oscuro */
        font-weight: 600;
    }


    /* Competencia que ya tiene al menos una asignación */
    .competencia-usada {
        background: #dcfce7;
        border-radius: .75rem;
        padding: .15rem .4rem;
    }

    /* Resultado asignado en el horario */
    .asignacion-resultado {
        border-left: 4px solid #16a34a; /* Verde SENA */
        background-color: #f0fdf4; /* Verde muy suave */
    }

    /* Competencia completa asignada en el horario */
    .asignacion-competencia {
        border-left: 4px solid #0f766e; /* Verde más oscuro */
        background-color: #ecfdf3;
        box-shadow: 0 0 0 1px rgba(16, 185, 129, 0.25);
    }

    @@media (max-width: 768px) {
        .floating-alert {
            min-width: 320px;
            right: 1rem;
            left: 1rem;
        }

        .day-col {
            min-height: 380px;
        }

        .table thead th {
            min-width: 150px;
            padding: 1rem;
            font-size: .9rem;
        }
    }

    {
        min-width: 320px;
        right: 1rem;
        left: 1rem;
    }

    .day-col {
        min-height: 380px;
    }

    .table thead th {
        min-width: 150px;
        padding: 1rem;
        font-size: .9rem;
    }

    }

    /* ===== Efectos visuales del acordeón de competencias ===== */
    .card-header.pointer {
        cursor: pointer;
        transition: all 0.25s ease;
    }

        .card-header.pointer:hover {
            background: rgba(0, 128, 55, 0.05);
        }

    .card-header .bi {
        transition: transform 0.3s ease;
    }

    .collapse.show + .card-header .bi-chevron-down {
        transform: rotate(180deg);
    }

    .day-col {
        min-height: 120px;
        border: 1px dashed #aaa;
        border-radius: 8px;
        padding: 4px;
        background-color: #f8f9fa;
        transition: background-color 0.2s ease;
    }

        .day-col.drag-over {
            background-color: #d1e7dd;
        }

    .resultado-item.dragging {
        opacity: 0.5;
    }

    .asignacion {
        font-size: 0.85rem;
    }

        /* Meta de la asignación: instructor y horario */
        .asignacion .meta {
            display: flex;
            align-items: center;
            gap: .75rem;
            margin-top: .15rem;
            font-size: .85rem;
            color: var(--sena-muted);
            line-height: 1.2;
        }

            .asignacion .meta i {
                font-size: 1rem;
            }

            .asignacion .meta .sep {
                opacity: .5;
            }

        .asignacion .fw-semibold {
            font-weight: 600;
        }

    /* El panel izquierdo puede crecer y hace que la página empuje al <section> */
    aside.col-lg-3 {
        align-self: flex-start;
    }

    /* Si tu lista de competencias es MUY larga, dale scroll interno en vez de empujar TODA la página */
    #competenciasList {
        max-height: calc(100vh - 320px); /* ajusta al gusto */
        overflow: auto;
    }

    #contenedorBarras .progress-bar {
        transition: width .4s ease, background-color .4s ease;
    }

    /* Colores para el horario */
    .bg-horario-ok {
        background: #00a859 !important;
    }

    .bg-horario-aviso {
        background: #ffb300 !important;
    }

    .bg-horario-peligro {
        background: #f57c00 !important;
    }

    .bg-horario-rojo {
        background: #d32f2f !important;
    }

    /* Colores para instructor */
    .bg-inst-ok {
        background: #00a859 !important;
    }

    .bg-inst-aviso {
        background: #ffb300 !important;
    }

    .bg-inst-alto {
        background: #f57c00 !important;
    }

    .bg-inst-max {
        background: #d32f2f !important;
    }

    .rotate-180 {
        transform: rotate(180deg);
    }

    .card-header .bi {
        transition: transform .25s ease;
    }

    /* Asegurar que el modal esté siempre por encima de blur, alerts, autocompletes, etc. */
    .modal {
        z-index: 2000 !important;
    }

    .modal-backdrop {
        z-index: 1990 !important;
    }

    /* Tu dropdown de autocomplete tenía z-index ~1055; mantenlo por debajo del modal */
    .autocomplete-list {
        z-index: 1200;
    }

    .asignacion[data-resultado="null"] {
        background-color: #e7f5ef !important;
        border-left: 4px solid var(--sena-green);
    }
</style>


<!-- ========================= HTML / VISTA ========================= -->

<main class="container-fluid p-3">
    <header class="mb-3 text-center">
        <h2 class="text-sena mb-1">Sistema de Gestión de Horarios</h2>
        <p class="text-muted mb-0">Planifica y organiza la formación por días con arrastrar y soltar.</p>
    </header>

    <!-- Filtros -->
    <section class="row align-items-end mb-4 g-3" aria-label="Filtros de búsqueda">
        <!-- Año -->
        <div class="col-lg-2 col-md-3">
            <label class="form-label fw-bold text-sena" for="selAnio">Año del Horario</label>
            <input id="selAnio" type="number" min="2024" max="2100" class="form-control" placeholder="Ej: 2026" autocomplete="off" />
        </div>

        <!-- Trimestre del año -->
        <div class="col-lg-2 col-md-3">
            <label class="form-label fw-bold text-sena" for="selTrimestreAnio">Trimestre del Año</label>
            <select id="selTrimestreAnio" class="form-select">
                <option value="">-- Selecciona un trimestre --</option>
                <option value="1">Trimestre 1</option>
                <option value="2">Trimestre 2</option>
                <option value="3">Trimestre 3</option>
                <option value="4">Trimestre 4</option>
            </select>
        </div>

        <!-- Ficha -->
        <div class="col-lg-4 col-md-6 position-relative">
            <label class="form-label fw-bold text-sena" for="inputFicha">Ficha</label>
            <input id="inputFicha"
                   class="form-control"
                   placeholder="Escribe el código o programa..."
                   autocomplete="off"
                   aria-autocomplete="list"
                   aria-expanded="false"
                   aria-controls="fichaSugerencias" />
            <input type="hidden" id="hfFichaId" />
            <div id="fichaSugerencias"
                 class="list-group autocomplete-list d-none"
                 role="listbox"
                 aria-label="Sugerencias de ficha">
            </div>
        </div>

        <!-- Trimestres ficha -->
        <div class="col-lg-3 col-md-4">
            <label class="form-label fw-bold text-sena">Trimestres</label>
            <div class="d-flex gap-2 align-items-center">
                <input id="txtTrimestreFicha"
                       type="number"
                       class="form-control text-center"
                       placeholder="1–7"
                       min="1" max="7"
                       readonly
                       style="width: 80px;" />
                <span class="fw-bold">→</span>
                <input id="txtSiguienteTrimestre"
                       type="number"
                       class="form-control text-center"
                       placeholder="Siguiente"
                       readonly
                       style="width: 100px;" />
            </div>
        </div>
    </section>

    @using (Html.BeginForm("GuardarHorario", "Home", FormMethod.Post, new { id = "formGuardarHorario", autocomplete = "off" }))
    {
        @Html.AntiForgeryToken()
        <input type="hidden" id="hfAsignaciones" name="AsignacionesJson" />

        <div class="row g-3">
            <!-- Panel izquierdo -->
            <aside class="col-lg-3 d-flex flex-column" aria-label="Panel lateral">
                <!-- Importar Excel -->
                <div class="col-lg-12 col-md-12 mb-2">
                    <label class="form-label fw-bold text-sena">Importar Excel</label>
                    <div class="d-flex align-items-center gap-2">
                        <button type="button"
                                id="btnCargarExcel"
                                class="btn btn-success btn-sm"
                                data-bs-toggle="tooltip"
                                title="Importa la planeación desde un archivo Excel">
                            <i class="bi bi-file-earmark-excel-fill me-1"></i> Cargar Planeación
                        </button>
                        <input type="file" id="inputExcel" accept=".xlsx,.xls" class="d-none" />
                    </div>
                </div>

                <!-- Programa -->
                <div class="mb-2">
                    <label class="form-label fw-bold text-sena" for="inputPrograma">Programa de Formación</label>
                    <input id="inputPrograma"
                           type="text"
                           class="form-control"
                           placeholder="Escribe o selecciona un programa..."
                           autocomplete="off" />
                </div>

                <!-- Competencias -->
                <div class="card border-sena shadow-sm mb-3">
                    <div class="card-header bg-sena fw-bold d-flex justify-content-between align-items-center">
                        <span>Competencias</span>
                        <div class="input-group input-group-sm" style="width:55%;">
                            <input id="txtSearch"
                                   type="text"
                                   class="form-control"
                                   placeholder="Buscar..."
                                   autocomplete="off"
                                   aria-label="Buscar competencia" />
                            <span class="input-group-text bg-success text-white" title="Buscar">
                                <i class="bi bi-search"></i>
                            </span>
                        </div>
                    </div>
                    <div class="card-body p-2">
                        <div id="competenciasList"
                             class="list-group list-group-flush"
                             aria-live="polite"
                             aria-label="Listado de competencias">
                        </div>
                    </div>
                </div>
            </aside>

            <!-- Panel central -->
            <section class="col-lg-9">
                <div class="card border-sena shadow-sm">
                    <div class="card-header bg-sena fw-bold d-flex justify-content-between align-items-center">
                        <span>Días de formación</span>
                        <small class="opacity-75">
                            Arrastra los resultados de aprendizaje hacia un día para crear asignaciones
                        </small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-bordered align-middle text-center"
                                   aria-label="Calendario semanal de formación">
                                <thead class="table-success">
                                    <tr>
                                        <th scope="col">Lunes</th>
                                        <th scope="col">Martes</th>
                                        <th scope="col">Miércoles</th>
                                        <th scope="col">Jueves</th>
                                        <th scope="col">Viernes</th>
                                        <th scope="col">Sábado</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        @foreach (var d in new[] { "Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado" })
                                        {
                                            <td>
                                                <div class="day-col"
                                                     id="day-@d.ToLower()"
                                                     data-day="@d"
                                                     role="list"
                                                     aria-label="@d">
                                                    <small class="text-muted drop-hint">Suelta aquí</small>
                                                </div>
                                            </td>
                                        }
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <small class="text-muted">
                            Arrastra aquí las asignaciones creadas desde la sección de competencias.
                        </small>
                    </div>
                </div>

                <div class="mt-3 text-end">
                    <button id="btnGuardarHorario"
                            type="button"
                            class="btn btn-success"
                            title="Guarda el horario actual">
                        <i class="bi bi-save me-2"></i>Guardar Todo
                    </button>

                    <button type="button"
                            class="btn btn-success"
                            onclick="location.href='@Url.Action("ListaHorarios", "Home")'"
                            title="Ver horarios guardados">
                        <i class="bi bi-calendar-check me-2"></i>Ver Horarios
                    </button>
                </div>
            </section>
        </div>
    }
</main>


<!-- ================== BARRAS DE PROGRESO UNIFICADAS ================== -->
<div id="contenedorBarras" class="p-3 bg-white border rounded shadow-sm mt-4">

    <!-- ========== HORAS DEL HORARIO ========== -->
    <label class="fw-bold text-sena">
        <i class="bi bi-hourglass-split me-1"></i> Horas programadas del horario
    </label>

    <div class="d-flex justify-content-between small mb-1">
        <span id="lblHorasHorario">0 horas asignadas</span>
        <span class="text-muted">Límite: 440h – Objetivo: 352h (80%)</span>
    </div>

    <div class="progress mb-4" style="height: 20px;">
        <div id="barraHorario" class="progress-bar bg-success fw-bold" style="width: 0%;">0%</div>
    </div>

    <!-- ========== HORAS POR INSTRUCTOR ========== -->
    <label class="fw-bold text-sena">
        <i class="bi bi-person-lines-fill me-1"></i> Horas asignadas al instructor
    </label>

    <!-- 🔥 Botones para navegar entre instructores asignados -->
    <div class="d-flex justify-content-between align-items-center mb-2">
        <button id="btnPrevInstructor" class="btn btn-sm btn-outline-success">
            <i class="bi bi-chevron-left"></i>
        </button>

        <div class="fw-bold text-sena" id="nombreInstructorActual">
            Sin instructores asignados
        </div>

        <button id="btnNextInstructor" class="btn btn-sm btn-outline-success">
            <i class="bi bi-chevron-right"></i>
        </button>
    </div>

    <div class="d-flex justify-content-between small mb-1">
        <span id="lblHorasInstructor">0 horas</span>
        <span id="lblMaxInstructor" class="text-muted">Máximo: 0h</span>
    </div>

    <div class="progress" style="height: 18px;">
        <div id="barraInstructor" class="progress-bar fw-bold" style="width: 0%;">0%</div>
    </div>

    <small id="estadoInstructor" class="text-muted mt-1 d-block"></small>
</div>

<!-- Modal Asignar -->
<div class="modal fade" id="modalAsignar" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-sena">
            <div class="modal-header bg-sena text-white">
                <h5 class="modal-title">Asignar Instructor y Horario</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">

                <div id="alertChoque"
                     class="alert alert-danger d-none text-center fw-bold"
                     style="font-size: 1rem; border-radius: 10px;">
                </div>
                <input type="hidden" id="hfResultadoId" />
                <input type="hidden" id="hfProgramaId" />
                <input type="hidden" id="hfCompetenciaId" />

                <div class="mb-3">
                    <label class="form-label" for="selInstructor">Instructor</label>
                    <select id="selInstructor" class="form-select"></select>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label" for="horaDesde">Desde</label>
                        <input id="horaDesde" type="time" class="form-control" value="06:00" />
                    </div>
                    <div class="col-6">
                        <label class="form-label" for="horaHasta">Hasta</label>
                        <input id="horaHasta" type="time" class="form-control" value="09:00" />
                    </div>
                </div>



                <button id="btnGuardarAsignacion"
                        type="button"
                        class="btn btn-success w-100"
                        title="Guardar asignación">
                    <i class="bi bi-check-circle me-2"></i>Guardar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Detalles (si luego quieres usarlo) -->
<div class="modal fade" id="modalDetalles" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-sena">
            <div class="modal-header bg-sena text-white">
                <h5 class="modal-title">Detalles de Asignación</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detallesBody" aria-live="polite"></div>
        </div>
    </div>
</div>

<!-- Modal Confirmar Competencia Completa -->
<div class="modal fade" id="modalConfirmCompetencia" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-sena">
            <div class="modal-header bg-sena text-white">
                <h5 class="modal-title">Agregar Competencia Completa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p class="fw-semibold mb-3">
                    ¿Deseas agregar la competencia
                    <span id="nombreCompetenciaConfirm" class="text-success"></span>
                    completa (con todos sus resultados de aprendizaje)?
                </p>
                <p class="text-muted small">
                    Esta competencia contiene
                    <span id="totalResultadosConfirm" class="fw-bold text-dark"></span>
                    resultados que se agregarán automáticamente al día
                    <span id="nombreDiaConfirm" class="text-primary fw-bold"></span>.
                </p>
                <div class="d-flex justify-content-center gap-3 mt-3">
                    <button type="button" class="btn btn-success" id="btnConfirmAgregarCompetencia">Sí, agregar</button>
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Instructor Líder -->
<div class="modal fade" id="modalLider" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-sena">
            <div class="modal-header bg-sena text-white">
                <h5 class="modal-title">
                    <i class="bi bi-person-badge me-2"></i> Asignar Instructor Líder
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">

                <!-- === INFORMACIÓN VISUAL SOLO LECTURA (traída desde BD) === -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Programa de Formación</label>
                    <input id="txtProgramaModal" type="text" class="form-control" readonly />
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label fw-bold">Ficha</label>
                        <input id="txtFichaModal" type="text" class="form-control" readonly />
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-bold">Trimestre destino</label>
                        <input id="txtTrimestreDestinoModal" type="text" class="form-control text-center" readonly />
                    </div>
                </div>

                <div class="row g-2 mb-3">
                    <div class="col-6">
                        <label class="form-label fw-bold">Fecha inicio</label>
                        <input id="txtFechaInicioModal" type="date" class="form-control" readonly />
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-bold">Fecha fin</label>
                        <input id="txtFechaFinModal" type="date" class="form-control" readonly />
                    </div>
                </div>

                <hr />

                <!-- === INSTRUCTOR LÍDER (queda igual que antes) === -->
                <div class="mb-3">
                    <label for="selInstructorLider" class="form-label fw-bold">Instructor Líder</label>
                    <select id="selInstructorLider" class="form-select">
                        <option value="">Cargando instructores...</option>
                    </select>
                </div>
                <button id="btnConfirmarLider"
                        type="button"
                        class="btn btn-success w-100">
                    <i class="bi bi-check-circle me-2"></i>Guardar Horario
                </button>
            </div>
        </div>
    </div>
</div>


<!-- ========================= JS / LÓGICA ========================= -->
@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
    // ========== UTILIDADES ==========
    function showAlert(message, type = "danger", ms = 4500) {
        const wrap = document.createElement("div");
        wrap.className = `alert alert-${type} floating-alert`;
        wrap.role = "alert";
        wrap.innerHTML = `
            <div class="d-flex align-items-start gap-2 p-3">
                <i class="bi ${type === "success" ? "bi-check-circle-fill" : "bi-exclamation-triangle-fill"} fs-5 mt-1"></i>
                <div class="flex-grow-1">${message}</div>
                <button type="button" class="btn-close" aria-label="Close"></button>
            </div>
            <div class="progress"><div class="progress-bar" style="width:100%"></div></div>`;
        document.body.appendChild(wrap);

        const bar = wrap.querySelector(".progress-bar");
        const closeBtn = wrap.querySelector(".btn-close");
        let start = performance.now();

        const tick = (t) => {
            const elapsed = t - start;
            const pct = Math.max(0, 100 - (elapsed / ms) * 100);
            bar.style.width = pct + "%";
            if (elapsed >= ms) {
                wrap.classList.add("hide");
                setTimeout(() => wrap.remove(), 220);
            } else {
                wrap._raf = requestAnimationFrame(tick);
            }
        };
        wrap._raf = requestAnimationFrame(tick);

        closeBtn.addEventListener("click", () => {
            cancelAnimationFrame(wrap._raf);
            wrap.classList.add("hide");
            setTimeout(() => wrap.remove(), 200);
        });
    }

    function getAntiForgeryToken() {
        const el = document.querySelector('input[name="__RequestVerificationToken"]');
        return el ? el.value : null;
    }

    function debounce(fn, ms = 250) {
        let t;
        return (...args) => {
            clearTimeout(t);
            t = setTimeout(() => fn.apply(this, args), ms);
        };
    }

        // ========== ESTADO GLOBAL ==========
        let payload = {
            numeroFicha: "",
            nombreHorario: "Horario generado",
            trimestre: "",
            asignaciones: []
        };

        let COMPETENCIAS = [];                 // [{ Competencia, Resultados: [] }]
        let OPEN_COMP_IDS = new Set();        // ids de acordeones abiertos
        let COMP_DRAGGING = null;             // competencia que se arrastra completa
        let INSTRUCTORES_EN_HORARIO = [];
        let indexInstructorActual = 0;
   

    const INSTRUCTORES_BY_ID = new Map(); // cache id → nombre

    let dropContext = null;              // contexto de asignación que se está editando
    let dropContextGuardado = false;

    const nextId = (() => { let c = 1; return () => c++; })();
    // 🔥 NECESARIA: almacena horarios reales de otras fichas
    let HORARIOS_GLOBAL = [];

    // Flag para permitir cerrar el modal cuando nosotros lo cerremos manualmente
    let allowCloseAsignarModal = false;

    // ========== REFERENCIAS DOM ==========
    const selAnio             = document.getElementById("selAnio");
    const selTrimestreAnio    = document.getElementById("selTrimestreAnio");
    const inputFicha          = document.getElementById("inputFicha");
    const fichaSugerencias    = document.getElementById("fichaSugerencias");
    const hfFichaId           = document.getElementById("hfFichaId");
    const txtTrimestreFicha   = document.getElementById("txtTrimestreFicha");
    const txtSiguienteTrimestre = document.getElementById("txtSiguienteTrimestre");
    const inputPrograma       = document.getElementById("inputPrograma");

    const competenciasList    = document.getElementById("competenciasList");
    const txtSearch           = document.getElementById("txtSearch");

    const btnCargarExcel      = document.getElementById("btnCargarExcel");
    const inputExcel          = document.getElementById("inputExcel");

    const modalAsignarEl      = document.getElementById("modalAsignar");
    const selInstructorEl     = document.getElementById("selInstructor");
    const horaDesdeEl         = document.getElementById("horaDesde");
    const horaHastaEl         = document.getElementById("horaHasta");
    const btnGuardarAsig      = document.getElementById("btnGuardarAsignacion");

    const btnGuardarHorario   = document.getElementById("btnGuardarHorario");
    const selInstructorLider  = document.getElementById("selInstructorLider");
    const btnConfirmarLider   = document.getElementById("btnConfirmarLider");

    // ========== INSTRUCTORES ==========
    async function loadInstructores(q = "") {
        try {
            const url = '@Url.Action("GetInstructores", "Home")' + (q ? ('?q=' + encodeURIComponent(q)) : '');
            const resp = await fetch(url, {
                headers: { "Accept": "application/json" },
                credentials: "same-origin"
            });

            let json = await resp.json();
            if (!resp.ok || !json?.ok) {
                throw new Error(json?.msg || "No se pudieron cargar los instructores.");
            }

            const lista = Array.isArray(json.data) ? json.data : [];
            INSTRUCTORES_BY_ID.clear();

            selInstructorEl.innerHTML = "";
            selInstructorEl.appendChild(new Option("Seleccione un instructor…", "", true, false));

            lista.forEach(i => {
                INSTRUCTORES_BY_ID.set(String(i.id), i.nombre);
                selInstructorEl.appendChild(new Option(i.nombre, String(i.id)));
            });
        } catch (err) {
            showAlert("Error cargando instructores: " + err.message, "danger");
            selInstructorEl.innerHTML = "";
            selInstructorEl.appendChild(new Option("Seleccione un instructor…", "", true, false));
        }
    }

    async function cargarInstructoresLider() {
        selInstructorLider.innerHTML = `<option value="">Cargando...</option>`;
        try {
            const resp = await fetch('@Url.Action("GetInstructores", "Home")');
            const json = await resp.json();

            selInstructorLider.innerHTML = `<option value="">Seleccione...</option>`;
            (json.data || []).forEach(i => {
                selInstructorLider.innerHTML += `<option value="${i.id}">${i.nombre}</option>`;
            });
        } catch (error) {
            selInstructorLider.innerHTML = `<option value="">Error al cargar instructores</option>`;
        }
    }

    // ========== MODAL ASIGNAR ==========
    async function abrirModalAsignar(ctx, preset = null) {
        try {
            const resultado = decodeURIComponent(ctx.itemEl.dataset.resultado || "");
            let instructorAsignado = null;

            // Recargar horarios globales
            await cargarHorariosGlobales();

            // Buscar instructor recomendado
            if (resultado) {
                try {
                    const resp = await fetch(
                        '@Url.Action("GetInstructorPorResultado", "Home")' +
                        '?resultado=' + encodeURIComponent(resultado),
                        { headers: { "Accept": "application/json" } }
                    );

                    const json = await resp.json();
                    if (json.ok && json.data) {
                        instructorAsignado = {
                            id: String(json.data.IdInstructor),
                            nombre: json.data.Nombre
                        };
                    }
                } catch (err) {
                    showAlert("Error consultando instructor: " + err.message, "danger");
                }
            }

            // Cargar instructores
            await loadInstructores();

            // Selección inicial
            selInstructorEl.value =
                instructorAsignado?.id ||
                preset?.instructorId ||
                "";

            // Horas predefinidas
            horaDesdeEl.value = preset?.horaDesde ?? "06:00";
            horaHastaEl.value = preset?.horaHasta ?? "09:00";

            dropContext = ctx;
            dropContextGuardado = false;

            payload.idFichaActual = hfFichaId.value || null;

            // =====================================================
            //            ✔ ABRIR MODAL
            // =====================================================
            new bootstrap.Modal(modalAsignarEl).show();

            // =====================================================
            //   🔥🔥🔥 1) GUARDAR LA ASIGNACIÓN EN TIEMPO REAL
            //         PARA QUE LAS BARRAS FUNCIONEN
            // =====================================================
            const asignacion = payload.asignaciones.find(a => a.id === ctx.asignacionId);
            if (asignacion) {
                asignacion.horaDesde = horaDesdeEl.value;
                asignacion.horaHasta = horaHastaEl.value;
                asignacion.instructorId = selInstructorEl.value ? parseInt(selInstructorEl.value) : null;
                asignacion.instructorNombre = INSTRUCTORES_BY_ID.get(selInstructorEl.value) || null;
            }

            // =====================================================
            //   🔥🔥🔥 2) REFRESCAR LISTA Y MOSTRAR INSTRUCTOR
            // =====================================================
            refrescarListaInstructoresEnHorario();
            await mostrarInstructorActual();  // carga del backend + barras

            // =====================================================
            //       Cargar info real desde BD del instructor
            // =====================================================
            if (selInstructorEl.value) {
                await cargarHorasInstructor(selInstructorEl.value);
                actualizarBarraInstructor();
            }

            actualizarBarraHorario();

            // =====================================================
            //          EVENTOS EN VIVO (solo 1 vez)
            // =====================================================
            if (!window._eventosModalAsignarRegistrados) {
                window._eventosModalAsignarRegistrados = true;

                selInstructorEl.addEventListener("change", async () => {

                    if (dropContext) {
                        const a = payload.asignaciones.find(x => x.id === dropContext.asignacionId);
                        if (a) {
                            a.instructorId = selInstructorEl.value ? parseInt(selInstructorEl.value) : null;
                            a.instructorNombre = INSTRUCTORES_BY_ID.get(selInstructorEl.value) || null;
                        }
                    }

                    if (selInstructorEl.value) {
                        await cargarHorasInstructor(selInstructorEl.value);
                    }

                    refrescarListaInstructoresEnHorario();
                    await mostrarInstructorActual();

                    actualizarBarraHorario();
                    validarEnVivo();
                });

                horaDesdeEl.addEventListener("input", async () => {
                    if (dropContext) {
                        const a = payload.asignaciones.find(x => x.id === dropContext.asignacionId);
                        if (a) a.horaDesde = horaDesdeEl.value;
                    }

                    refrescarListaInstructoresEnHorario();
                    await mostrarInstructorActual();
                    actualizarBarraHorario();
                    validarEnVivo();
                });

                horaHastaEl.addEventListener("input", async () => {
                    if (dropContext) {
                        const a = payload.asignaciones.find(x => x.id === dropContext.asignacionId);
                        if (a) a.horaHasta = horaHastaEl.value;
                    }

                    refrescarListaInstructoresEnHorario();
                    await mostrarInstructorActual();
                    actualizarBarraHorario();
                    validarEnVivo();
                });
            }

            setTimeout(() => validarEnVivo(), 200);

        } catch (err) {
            showAlert("Error al abrir el modal: " + err.message, "danger");
        }
    }

    async function cargarHorasInstructor(idInstructor) {
        const resp = await fetch("/Home/GetHorasInstructor?idInstructor=" + idInstructor);
        const json = await resp.json();

        if (json.ok) {
            window._horasInstructorActual = json.horasActuales;   // BD
            window._horasInstructorMax = json.horasMaximas;      // BD
        }
    }


        async function cargarHorariosGlobales() {
            try {
                const resp = await fetch("/Home/GetAsignacionessInstructor");
                const json = await resp.json();

                if (json.ok) {
                    HORARIOS_GLOBAL = json.data;   // ← GUARDA TODOS LOS HORARIOS REALES
                }
            } catch (err) {
                console.error("Error cargando horarios globales:", err);
            }
        }

    //  GUARDAR ASIGNACIÓN DESDE EL MODAL  (VALIDA EN BD)
    // =============================================================
    (function wireGuardarAsignacion() {
        let wired = false;
        if (wired) return;
        wired = true;

        btnGuardarAsig.addEventListener("click", () => {
            if (!dropContext) return;

            const instructorId = selInstructorEl.value || null;
            const horaDesde = horaDesdeEl.value || "";
            const horaHasta = horaHastaEl.value || "";

            if (!instructorId) {
                showAlert("Debes seleccionar un instructor.", "warning");
                return;
            }
            if (!horaDesde || !horaHasta) {
                showAlert("Debes indicar el horario completo.", "warning");
                return;
            }

            const asignacion = payload.asignaciones.find(a => a.id === dropContext.asignacionId);
            const dia = asignacion?.dia || dropContext.itemEl.dataset.dia;

            // IdFicha actual (de la ficha seleccionada en pantalla)
            const idFicha = hfFichaId.value;

            // =============== VALIDACIÓN LOCAL (en el horario que estás armando) ===============
            const conflictoLocal = tieneConflictoEnDia({
                dia,
                instructorId,
                desde: horaDesde,
                hasta: horaHasta,
                ignoreId: dropContext.asignacionId
            });

            if (conflictoLocal) {
                showAlert("❌ " + conflictoLocal, "danger");
                return;
            }

            // =============== VALIDAR EN BD LA FRANJA (MISMA FICHA) ===============
            $.get('@Url.Action("ValidarChoqueHorarioBD", "Home")', {
                idInstructor: instructorId,
                idFicha: idFicha,
                dia: dia,
                desde: horaDesde,
                hasta: horaHasta
            }).done(respBD => {

                if (!respBD.ok) {
                    // 🔥 Mensaje viene directamente del backend:
                    // "❌ Choque detectado: X ya tiene clase el día..."
                    showAlert(respBD.msg || "❌ Choque de horario en la base de datos.", "danger");
                    // NO cerramos el modal: el usuario debe cambiar instructor u horas
                    return;
                }

                // (Opcional) mantener tu validación global entre fichas si la sigues usando:
                $.get("/Home/ValidarChoqueInstructorGlobal", {
                    idInstructor: instructorId,
                    dia: dia,
                    desde: horaDesde,
                    hasta: horaHasta,
                    idFichaActual: idFicha
                }).done(resp => {

                    if (!resp.ok) {
                        showAlert("Error validando horario: " + resp.msg, "danger");
                        return;
                    }

                    if (resp.choque) {
                        showAlert("❌ Este instructor ya está asignado en otra ficha en este mismo horario.", "danger");
                        return;
                    }

                    // =============== SI TODO OK → GUARDAR EN payload / DOM ===============
                    const instructorNombre = INSTRUCTORES_BY_ID.get(String(instructorId)) || "—";

                    if (asignacion) {
                        asignacion.instructorId = parseInt(instructorId, 10);
                        asignacion.instructorNombre = instructorNombre;
                        asignacion.horaDesde = horaDesde;
                        asignacion.horaHasta = horaHasta;
                    }

                    const nombreEl = dropContext.itemEl.querySelector(".instructor");
                    const horarioEl = dropContext.itemEl.querySelector(".horario");

                    if (nombreEl) nombreEl.textContent = instructorNombre;
                    if (horarioEl) nombreEl.textContent = instructorNombre;
                    if (horarioEl) horarioEl.textContent = `${horaDesde} – ${horaHasta}`;
                    dropContext.itemEl.title = `${instructorNombre} • ${horaDesde} – ${horaHasta}`;

                    dropContextGuardado = true;

                    showAlert(`Instructor ${instructorNombre} asignado correctamente.`, "success");

                    // ✅ Permitimos el cierre y cerramos el modal
                    allowCloseAsignarModal = true;
                    const modalInstance = bootstrap.Modal.getInstance(modalAsignarEl);
                    modalInstance.hide();

                    dropContext = null;
                });
            });
        });
    })();

    // Si se cierra el modal sin guardar
    modalAsignarEl.addEventListener("hide.bs.modal", function (e) {
        // Si lo estamos cerrando nosotros mismos después de validar, dejar pasar
        if (allowCloseAsignarModal) {
            allowCloseAsignarModal = false;
            dropContext = null;
            return;
        }

        if (!dropContext) return;

        const asignacion = payload.asignaciones.find(a => a.id === dropContext.asignacionId);
        if (!asignacion) {
            dropContext = null;
            return;
        }

        const instructorId = selInstructorEl.value?.trim() || null;
        const horaDesde = horaDesdeEl.value?.trim() || "06:00";
        const horaHasta = horaHastaEl.value?.trim() || "09:00";
        const idFicha   = hfFichaId.value;
        const dia       = asignacion.dia || dropContext.itemEl.dataset.dia;

        // Si NO hay instructor seleccionado, se interpreta como cancelar:
        // → se elimina la asignación y SÍ se permite cerrar el modal
        if (!instructorId) {
            dropContext.itemEl?.remove();
            payload.asignaciones = payload.asignaciones.filter(a => a.id !== dropContext.asignacionId);
            dropContext = null;

            // Recalcular resaltados
            refrescarUsos();
            return;
        }

        // A partir de aquí queremos validar y, mientras tanto, BLOQUEAR el cierre
        e.preventDefault();

        // 1️⃣ Validación local (en el horario en memoria)
        const conflictoLocal = tieneConflictoEnDia({
            dia,
            instructorId,
            desde: horaDesde,
            hasta: horaHasta,
            ignoreId: dropContext.asignacionId
        });

        if (conflictoLocal) {
            showAlert(
                "❌ " + conflictoLocal + " Debes seleccionar otro instructor o cambiar las horas.",
                "danger"
            );
            return; // no cerramos el modal
        }

        // 2️⃣ Validación contra la BASE DE DATOS (misma lógica que en el backend)
        $.get('@Url.Action("ValidarChoqueHorarioBD", "Home")', {
            idInstructor: instructorId,
            idFicha: idFicha,
            dia: dia,
            desde: horaDesde,
            hasta: horaHasta
        }).done(function (respBD) {

            if (!respBD.ok) {
                // Choque detectado en BD → NO dejar cerrar, mostrar mensaje
                showAlert(
                    (respBD.msg || "❌ Choque de horario en la base de datos.") +
                    " Debes seleccionar otro instructor o cambiar las horas.",
                    "danger"
                );
                return;
            }

            // (Opcional) 3️⃣ Validación global entre fichas, si quieres seguir usándola
            $.get("/Home/ValidarChoqueInstructorGlobal", {
                idInstructor: instructorId,
                dia: dia,
                desde: horaDesde,
                hasta: horaHasta,
                idFichaActual: idFicha
            }).done(function (resp) {

                if (!resp.ok) {
                    showAlert("Error validando horario: " + resp.msg, "danger");
                    return;
                }

                if (resp.choque) {
                    showAlert(
                        "❌ Este instructor ya tiene una clase en otra ficha en este mismo rango. " +
                        "Debes seleccionar otro instructor o cambiar las horas.",
                        "danger"
                    );
                    return;
                }

                // ✅ Si NO hay conflictos → guardamos la asignación y ahora sí cerramos el modal
                asignacion.instructorId = parseInt(instructorId, 10);
                asignacion.horaDesde = horaDesde;
                asignacion.horaHasta = horaHasta;
                asignacion.instructorNombre = INSTRUCTORES_BY_ID.get(String(instructorId)) || "—";

                const nombreEl  = dropContext.itemEl.querySelector(".instructor");
                const horarioEl = dropContext.itemEl.querySelector(".horario");

                if (nombreEl)  nombreEl.textContent  = asignacion.instructorNombre;
                if (horarioEl) horarioEl.textContent = `${horaDesde} – ${horaHasta}`;
                dropContext.itemEl.title = `${asignacion.instructorNombre} • ${horaDesde} – ${horaHasta}`;

                dropContextGuardado = true;

                // Permitimos el cierre y lo disparamos manualmente
                allowCloseAsignarModal = true;
                const modalInstance = bootstrap.Modal.getInstance(modalAsignarEl);
                modalInstance.hide();
            }).fail(function () {
                showAlert("Error validando horario global.", "danger");
            });

        }).fail(function () {
            showAlert("Error validando horario en la base de datos.", "danger");
        });
    });

    // ========== DRAG & DROP DÍAS ==========
    function initDropHints() {
        document.querySelectorAll(".day-col").forEach(col => {
            const hint = col.querySelector(".drop-hint");
            if (hint) updateDropHint(col);
        });
    }

    function updateDropHint(dayCol) {
        const hint = dayCol.querySelector(".drop-hint");
        if (!hint) return;
        const hasItems = dayCol.querySelectorAll(".asignacion").length > 0;
        hint.style.display = hasItems ? "none" : "";
    }

    function wireDayDropZones() {
        document.querySelectorAll(".day-col").forEach(dia => {
            dia.addEventListener("dragover", e => {
                e.preventDefault();
                e.dataTransfer.dropEffect = "move";
                dia.classList.add("drag-over");
            });

            dia.addEventListener("dragleave", () => dia.classList.remove("drag-over"));

            dia.addEventListener("drop", async e => {
                e.preventDefault();
                dia.classList.remove("drag-over");

                const competenciaCompletaData = e.dataTransfer.getData("competenciaCompleta");
                const competenciaData = e.dataTransfer.getData("competencia");
                const resultadoData = e.dataTransfer.getData("resultado");
                const diaSemana = dia.dataset.day;

                // Competencia completa
                if (competenciaCompletaData && COMP_DRAGGING) {
                    mostrarModalConfirmacionCompetencia(COMP_DRAGGING, diaSemana);
                    return;
                }

                // Resultado individual
                if (competenciaData && resultadoData) {
                    const competencia = decodeURIComponent(competenciaData);
                    const resultado = decodeURIComponent(resultadoData);
                    const asignacionId = nextId();

                    const item = document.createElement("div");
                    // 👇 Notar la clase asignacion-resultado
                    item.className = "asignacion asignacion-resultado border rounded p-2 mb-1 text-start";
                    item.dataset.asignacionId = String(asignacionId);
                    item.dataset.competencia = competencia;
                    item.dataset.resultado = resultado;
                    item.dataset.dia = diaSemana;

                    item.innerHTML = `
    <div class="d-flex align-items-start justify-content-between gap-2">
        <div class="fw-semibold flex-grow-1">
            <span class="badge bg-light text-success border border-success me-1">Resultado</span>
            ${resultado}
        </div>
        <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-link text-success p-0 edit-asig" title="Editar">
                <i class="bi bi-pencil-square"></i>
            </button>
            <button type="button" class="btn btn-link text-danger p-0 delete-asig" title="Eliminar">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
    <div class="meta mt-1">
        <i class="bi bi-mortarboard"></i><span class="instructor">Seleccione instructor…</span>
        <span class="sep">•</span>
        <i class="bi bi-clock"></i><span class="horario">--:-- – --:--</span>
    </div>`;

                    dia.appendChild(item);
                    updateDropHint(dia);

                    payload.asignaciones.push({
                        id: asignacionId,
                        competencia,
                        resultado,
                        dia: diaSemana,
                        instructorId: null,
                        instructorNombre: null,
                        horaDesde: null,
                        horaHasta: null
                    });

                    // 🔥 Marcar en la lista que este resultado/competencia está en uso
                    marcarResultadoUsado(competencia, resultado);
                    marcarCompetenciaUsada(competencia);

                    item.querySelector(".edit-asig")?.addEventListener("click", () => editarAsignacion(item));
                    item.querySelector(".delete-asig")?.addEventListener("click", () => eliminarAsignacion(item));

                    await abrirModalAsignar({ asignacionId, itemEl: item });
                }
            });
        });
    }

    // ========== DRAG RESULTADOS Y COMPETENCIAS ==========
    function wireResultadosDrag() {
        document.querySelectorAll(".resultado-item").forEach(r => {
            if (r.dataset.wired === "1") return;
            r.dataset.wired = "1";

            r.addEventListener("dragstart", e => {
                e.dataTransfer.setData("competencia", r.dataset.competencia);
                e.dataTransfer.setData("resultado", r.dataset.resultado);
                e.dataTransfer.effectAllowed = "move";
                r.classList.add("dragging");
            });
            r.addEventListener("dragend", () => r.classList.remove("dragging"));
        });
    }

    function wireCompetenciaDrag() {
        document.querySelectorAll(".card-header .fw-bold.text-sena").forEach((span, idx) => {
            if (span.dataset.wired === "1") return;
            span.dataset.wired = "1";

            span.draggable = true;
            span.title = "Arrastra la competencia completa";

            span.addEventListener("dragstart", e => {
                const comp = COMPETENCIAS[idx];
                if (!comp) return;
                COMP_DRAGGING = comp;
                e.dataTransfer.effectAllowed = "move";
                e.dataTransfer.setData("competenciaCompleta", encodeURIComponent(comp.Competencia));
                span.classList.add("opacity-50");
            });

            span.addEventListener("dragend", () => {
                COMP_DRAGGING = null;
                span.classList.remove("opacity-50");
            });
        });
    }

    function mostrarModalConfirmacionCompetencia(competencia, diaSemana) {
        if (!competencia) return;

        document.getElementById("nombreCompetenciaConfirm").textContent = competencia.Competencia;
        document.getElementById("totalResultadosConfirm").textContent = competencia.Resultados?.length || 0;
        document.getElementById("nombreDiaConfirm").textContent = diaSemana;

        window._competenciaPendiente = competencia;
        window._diaPendiente = diaSemana;

        const modal = new bootstrap.Modal(document.getElementById("modalConfirmCompetencia"));
        modal.show();
    }

    document.getElementById("btnConfirmAgregarCompetencia")
        ?.addEventListener("click", async () => {
            const competencia = window._competenciaPendiente;
            const diaSemana = window._diaPendiente;
            if (!competencia || !diaSemana) return;

            const asignacionId = nextId();
            const item = document.createElement("div");
            // 👇 Clase especial para competencias
            item.className = "asignacion asignacion-competencia border rounded p-2 mb-1 text-start";
            item.dataset.asignacionId = String(asignacionId);
            item.dataset.competencia = competencia.Competencia; // texto plano
            item.dataset.resultado = competencia.Resultados?.[0] || "";
            item.dataset.dia = diaSemana;

            item.innerHTML = `
    <div class="d-flex align-items-start justify-content-between gap-2">
        <div class="fw-semibold flex-grow-1">
            <span class="badge bg-success text-white me-1">Competencia</span>
            <i class="bi bi-bookmark-star text-success-emphasis me-1"></i>
            ${competencia.Competencia}
        </div>
        <div class="btn-group btn-group-sm">
            <button type="button" class="btn btn-link text-success p-0 edit-asig" title="Editar">
                <i class="bi bi-pencil-square"></i>
            </button>
            <button type="button" class="btn btn-link text-danger p-0 delete-asig" title="Eliminar">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    </div>
    <div class="meta mt-1">
        <i class="bi bi-mortarboard"></i><span class="instructor">Seleccione instructor…</span>
        <span class="sep">•</span>
        <i class="bi bi-clock"></i><span class="horario">--:-- – --:--</span>
    </div>`;


            const diaEl = document.querySelector(`.day-col[data-day="${diaSemana}"]`);
            if (diaEl) {
                diaEl.appendChild(item);
                updateDropHint(diaEl);
            }

            payload.asignaciones.push({
                id: asignacionId,
                competencia: competencia.Competencia,
                resultado: null,   // ← competencia completa
                dia: diaSemana,
                instructorId: null,
                instructorNombre: null,
                horaDesde: null,
                horaHasta: null
            });

            item.querySelector(".edit-asig")?.addEventListener("click", () => editarAsignacion(item));
            item.querySelector(".delete-asig")?.addEventListener("click", () => eliminarAsignacion(item));

            const modalConfirm = bootstrap.Modal.getInstance(document.getElementById("modalConfirmCompetencia"));
            modalConfirm.hide();

            // 🔥 Resaltar competencia y TODOS sus resultados en la lista
            marcarCompetenciaUsada(competencia.Competencia);
            marcarTodosResultadosDeCompetencia(competencia.Competencia);

            await abrirModalAsignar({ asignacionId, itemEl: item });

            window._competenciaPendiente = null;
            window._diaPendiente = null;
        });

    // ========== AUTOCOMPLETADO FICHAS ==========
    function ocultarSugerencias() {
        fichaSugerencias.classList.add("d-none");
        fichaSugerencias.innerHTML = "";
    }

    async function buscarFichasLectivas(term = "") {
        const anio = selAnio?.value?.trim();
        const trimestre = selTrimestreAnio?.value?.trim();

        fichaSugerencias.innerHTML = "";
        if (!anio || !trimestre) {
            fichaSugerencias.innerHTML = `
                <div class="list-group-item small text-muted">
                    ⚠️ Selecciona año y trimestre antes de buscar.
                </div>`;
            fichaSugerencias.classList.remove("d-none");
            return;
        }

        try {
            const url = '@Url.Action("GetFichasEnFormacion", "Home")'
                + `?term=${encodeURIComponent(term)}`
                + `&anio=${encodeURIComponent(anio)}`
                + `&trimestre=${encodeURIComponent(trimestre)}`;

            const resp = await fetch(url, { headers: { "Accept": "application/json" } });
            if (!resp.ok) throw new Error(`Error HTTP ${resp.status}`);

            const json = await resp.json();
            if (!json?.ok) throw new Error(json.msg || "No se pudieron obtener las fichas.");

            let fichas = json.data || [];

            if (term && fichas.length > 0) {
                const termLower = term.toLowerCase();
                fichas = fichas.filter(f =>
                    (f.CodigoFicha?.toString().toLowerCase().includes(termLower)) ||
                    (f.ProgramaNombre?.toLowerCase().includes(termLower))
                );
            }

            if (!fichas.length) {
                fichaSugerencias.innerHTML = `
                    <div class="list-group-item small text-muted">
                        Sin coincidencias…
                    </div>`;
                fichaSugerencias.classList.remove("d-none");
                return;
            }

            fichaSugerencias.innerHTML = "";
            fichas.forEach(f => {
                const btn = document.createElement("button");
                btn.type = "button";
                btn.className = "list-group-item list-group-item-action";
                btn.innerHTML = `
                    <div><strong>${f.CodigoFicha}</strong> — ${f.ProgramaNombre}</div>
                    <small class="text-muted">
                        Trimestre ${f.TrimestreDeLaFicha ?? "?"}
                        • ${f.FechaInicio?.split("T")[0] ?? ""} - ${f.FechaFin?.split("T")[0] ?? ""}
                    </small>`;

                btn.addEventListener("click", () => {
                    inputFicha.value = f.CodigoFicha;
                    hfFichaId.value = f.IdFicha;
                    inputPrograma.value = f.ProgramaNombre;
                    txtTrimestreFicha.value = f.TrimestreDeLaFicha ?? "";
                    actualizarSiguienteTrimestre();
                    ocultarSugerencias();

                    if (typeof cargarCompetenciasFicha === "function") {
                        cargarCompetenciasFicha(f.IdFicha);
                    }
                });

                fichaSugerencias.appendChild(btn);
            });

            fichaSugerencias.classList.remove("d-none");
        } catch (err) {
            fichaSugerencias.innerHTML = `
                <div class="list-group-item small text-danger">
                    Error: ${err.message}
                </div>`;
            fichaSugerencias.classList.remove("d-none");
        }
    }

    inputFicha?.addEventListener("input", debounce(async () => {
        const q = inputFicha.value.trim();
        hfFichaId.value = "";
        txtTrimestreFicha.value = "";
        inputPrograma.value = "";
        if (q.length < 2) {
            ocultarSugerencias();
            return;
        }
        await buscarFichasLectivas(q);
    }, 300));

    inputFicha?.addEventListener("focus", async () => {
        if (!selAnio.value || !selTrimestreAnio.value) {
            showAlert("Selecciona el año y trimestre antes de buscar fichas.", "warning");
            return;
        }
        await buscarFichasLectivas(inputFicha.value.trim());
    });

    document.addEventListener("click", e => {
        if (!fichaSugerencias.contains(e.target) && !inputFicha.contains(e.target)) {
            ocultarSugerencias();
        }
    });

    selAnio?.addEventListener("change", () => buscarFichasLectivas(inputFicha.value.trim()));
    selTrimestreAnio?.addEventListener("change", () => buscarFichasLectivas(inputFicha.value.trim()));

    // ========== IMPORTAR EXCEL ==========
    btnCargarExcel?.addEventListener("click", () => {
        inputExcel.click();
    });

    inputExcel?.addEventListener("change", async function (e) {
        const file = e.target.files?.[0];
        if (!file) return;

        const anio = selAnio.value;
        const trimestre = selTrimestreAnio.value;
        const idFicha = hfFichaId.value;

        if (!anio || !trimestre || !idFicha) {
            showAlert("Debes seleccionar un Año, un Trimestre y una Ficha antes de importar.", "warning");
            e.target.value = "";
            return;
        }

        btnCargarExcel.innerHTML = `<i class="bi bi-hourglass-split me-1"></i> Cargando...`;
        btnCargarExcel.disabled = true;

        try {
            const fd = new FormData();
            fd.append("archivoExcel", file);
            fd.append("anio", anio);
            fd.append("trimestre", trimestre);
            fd.append("idFicha", idFicha);

            const resp = await fetch('@Url.Action("ImportarExcel", "Home")', {
                method: "POST",
                body: fd
            });
            const data = await resp.json();

            if (!data.ok) throw new Error(data.msg || "Error al importar la planeación.");

            showAlert(data.msg, "success");
            cargarCompetenciasFicha(idFicha);
        } catch (err) {
            showAlert(err.message, "danger");
        } finally {
            btnCargarExcel.disabled = false;
            btnCargarExcel.innerHTML = `<i class="bi bi-file-earmark-excel-fill me-1"></i> Cargar Planeación`;
            e.target.value = "";
        }
    });

    async function cargarFichaResumenParaModal(idFicha) {
        if (!idFicha) {
            showAlert("No hay ficha seleccionada.", "warning");
            return false;
        }
        try {
            const resp = await fetch('@Url.Action("GetFichaResumen", "Home")?idFicha=' + encodeURIComponent(idFicha), {
                headers: { "Accept": "application/json" },
                credentials: "same-origin"
            });
            const json = await resp.json();
            if (!resp.ok || !json.ok) {
                showAlert(json?.msg || "No se pudo obtener la información de la ficha.", "danger");
                return false;
            }

            const d = json.data || {};
            // Rellenar los campos del modal (solo visualización)
            document.getElementById("txtProgramaModal").value = d.ProgramaNombre || "";
            document.getElementById("txtFichaModal").value = d.CodigoFicha || "";
            document.getElementById("txtTrimestreDestinoModal").value = d.TrimestreDestino || "";
            // Si vienen fechas, asignarlas; si no, dejarlas vacías
            document.getElementById("txtFechaInicioModal").value = d.FechaInicio || "";
            document.getElementById("txtFechaFinModal").value = d.FechaFin || "";

            return true;
        } catch (err) {
            showAlert("Error cargando resumen de ficha: " + err.message, "danger");
            return false;
        }
    }

    // ========== RENDER COMPETENCIAS ==========
    function renderCompetencias(list) {
        competenciasList.innerHTML = "";

        if (!list || !list.length) {
            competenciasList.innerHTML =
                `<div class="text-muted text-center py-2">Sin competencias para mostrar.</div>`;
            return;
        }

        list.forEach((c, idx) => {
            const compId = `comp_${idx}`;
            const isOpen = OPEN_COMP_IDS.has(compId);

            const card = document.createElement("div");
            card.className = "card mb-2 border-0 shadow-sm";

            card.innerHTML = `
            <div class="card-header d-flex justify-content-between align-items-center bg-white border-start border-4 border-success pointer"
                 role="button"
                 aria-expanded="${isOpen}"
                 aria-controls="${compId}">
                <span class="fw-bold text-sena comp-encabezado">${c.Competencia}</span>
                <i class="bi bi-chevron-down text-success fs-5 ${isOpen ? 'rotate-180' : ''}"></i>
            </div>
            <div id="${compId}" class="collapse ${isOpen ? 'show' : ''}">
                <div class="card-body pt-2 pb-2 ps-4">
                    ${Array.isArray(c.Resultados) && c.Resultados.length
                        ? `<ul class="list-unstyled mb-0">
                                ${c.Resultados.map(r => `
                                    <li class="resultado-item small text-muted border p-1 mb-1 rounded bg-light"
                                        draggable="true"
                                        data-competencia="${encodeURIComponent(c.Competencia)}"
                                        data-resultado="${encodeURIComponent(r)}">
                                        <i class="bi bi-arrows-move me-1 text-success"></i> ${r}
                                    </li>`).join("")}
                           </ul>`
                        : `<small class="text-muted fst-italic">Sin resultados de aprendizaje</small>`
                    }
                </div>
            </div>`;

            const collapseEl = card.querySelector(`#${compId}`);
            const headerEl = card.querySelector(".card-header");
            const chevron = card.querySelector(".bi-chevron-down");

            // Instancia de Bootstrap Collapse sin auto-toggle
            const bsCollapse = new bootstrap.Collapse(collapseEl, { toggle: false });

            // Toggle manual al hacer clic en la cabecera
            headerEl.addEventListener("click", () => {
                bsCollapse.toggle();
            });

            collapseEl.addEventListener("shown.bs.collapse", () => {
                OPEN_COMP_IDS.add(compId);
                chevron.classList.add("rotate-180");
                headerEl.setAttribute("aria-expanded", "true");
            });

            collapseEl.addEventListener("hidden.bs.collapse", () => {
                OPEN_COMP_IDS.delete(compId);
                chevron.classList.remove("rotate-180");
                headerEl.setAttribute("aria-expanded", "false");
            });

            competenciasList.appendChild(card);
        });

        wireResultadosDrag();
        wireCompetenciaDrag();

        // 🔥 Aplica resaltado según lo que ya está asignado
        refrescarUsos();
    }

    function mostrarCompetenciasCargadas(competencias) {
        COMPETENCIAS = Array.isArray(competencias) ? competencias : [];
        OPEN_COMP_IDS = new Set();
        renderCompetencias(COMPETENCIAS);
    }

    txtSearch?.addEventListener("input", debounce(() => {
        const q = (txtSearch.value || "").trim().toLowerCase();
        if (!q) {
            renderCompetencias(COMPETENCIAS);
            return;
        }

        const filtered = COMPETENCIAS
            .map(c => {
                const matchComp = (c.Competencia || "").toLowerCase().includes(q);
                const resFiltrados = (c.Resultados || [])
                    .filter(r => (r || "").toLowerCase().includes(q));
                if (matchComp) {
                    return { Competencia: c.Competencia, Resultados: c.Resultados || [] };
                }
                if (resFiltrados.length) {
                    return { Competencia: c.Competencia, Resultados: resFiltrados };
                }
                return null;
            })
            .filter(Boolean);

        OPEN_COMP_IDS = new Set(filtered.map((_, i) => `comp_${i}`));
        renderCompetencias(filtered);
    }, 200));

    // ========== ASIGNACIONES ==========
    function editarAsignacion(item) {
        const id = parseInt(item.dataset.asignacionId, 10);
        const a = payload.asignaciones.find(x => x.id === id);
        const preset = {
            instructorId: a?.instructorId ? String(a.instructorId) : "",
            horaDesde: a?.horaDesde || "06:00",
            horaHasta: a?.horaHasta || "09:00"
        };
        abrirModalAsignar({ asignacionId: id, itemEl: item }, preset);
    }

    function eliminarAsignacion(item) {
        const id = parseInt(item.dataset.asignacionId, 10);
        const col = item.closest(".day-col");

        // eliminar del payload
        payload.asignaciones = payload.asignaciones.filter(a => a.id !== id);

        // eliminar del DOM
        item.remove();

        if (col) updateDropHint(col);

        // 🔥 recalcular barras
        refrescarListaInstructoresEnHorario();
        mostrarInstructorActual();  // recalcula barra instructor
        actualizarBarraHorario();   // recalcula la del horario
    }

    function parseHM(hhmm) {
        if (!hhmm || !/^\d{2}:\d{2}$/.test(hhmm)) return null;
        const [h, m] = hhmm.split(":").map(n => parseInt(n, 10));
        return h * 60 + m;
    }

    function rangosSePisan(d1, h1, d2, h2) {
        return d1 < h2 && d2 < h1;
    }

    function tieneConflictoEnDia({ dia, instructorId, desde, hasta, ignoreId = null }) {
        const d = parseHM(desde);
        const h = parseHM(hasta);
        if (d == null || h == null) return "Debes indicar un horario válido.";
        if (d >= h) return "La hora inicial debe ser menor que la final.";

        const choqueInstructor = payload.asignaciones.some(a =>
            a.dia === dia &&
            a.id !== ignoreId &&
            a.instructorId != null &&
            String(a.instructorId) === String(instructorId) &&
            rangosSePisan(parseHM(a.horaDesde), parseHM(a.horaHasta), d, h)
        );
        if (choqueInstructor) return "Ese instructor ya tiene una asignación en ese horario.";

        return null;
    }

    // 🔹 misma franja exacta (desde/hasta) el mismo día para el mismo instructor
    function tieneMismaFranjaMismoDia({ dia, instructorId, desde, hasta, ignoreId = null }) {
        const d = parseHM(desde);
        const h = parseHM(hasta);
        if (d == null || h == null) return false;

        return payload.asignaciones.some(a =>
            a.id !== ignoreId &&
            a.dia === dia &&
            a.instructorId != null &&
            String(a.instructorId) === String(instructorId) &&
            parseHM(a.horaDesde) === d &&
            parseHM(a.horaHasta) === h
        );
    }

    // ========== MARCAR RESULTADOS/COMPETENCIAS USADOS ==========
    // Marca visualmente un resultado como "usado"
    function marcarResultadoUsado(competencia, resultado) {
        if (!competencia || !resultado) return;

        const compEnc = encodeURIComponent(competencia);
        const resEnc  = encodeURIComponent(resultado);

        const selector = `.resultado-item[data-competencia="${compEnc}"][data-resultado="${resEnc}"]`;
        competenciasList
            .querySelectorAll(selector)
            .forEach(li => li.classList.add("resultado-usado"));
    }

    // Marca TODOS los resultados asociados a una competencia
    function marcarTodosResultadosDeCompetencia(competencia) {
        if (!competencia) return;
        const compEnc = encodeURIComponent(competencia);

        competenciasList
            .querySelectorAll(`.resultado-item[data-competencia="${compEnc}"]`)
            .forEach(li => li.classList.add("resultado-usado"));
    }

    // Marca visualmente una competencia como "usada"
    function marcarCompetenciaUsada(competencia) {
        if (!competencia) return;

        competenciasList
            .querySelectorAll(".comp-encabezado")
            .forEach(span => {
                if (span.textContent.trim() === competencia.trim()) {
                    span.classList.add("competencia-usada");
                }
            });
    }

    // Recalcula todo (por si se borran asignaciones, recarga, etc.)
    function refrescarUsos() {
        // Limpia marcas anteriores
        competenciasList
            .querySelectorAll(".resultado-usado, .competencia-usada")
            .forEach(el => {
                el.classList.remove("resultado-usado", "competencia-usada");
            });

        // Recorre las asignaciones activas y vuelve a marcar
        payload.asignaciones.forEach(a => {
            if (a.resultado) {
                // resultado individual
                marcarResultadoUsado(a.competencia, a.resultado);
                marcarCompetenciaUsada(a.competencia);
            } else if (a.competencia) {
                // competencia completa
                marcarCompetenciaUsada(a.competencia);
                marcarTodosResultadosDeCompetencia(a.competencia);
            }
        });
    }

    // ========== CARGAR COMPETENCIAS POR FICHA/TRIM ==========
    async function cargarCompetenciasFicha(idFicha) {
        const trimestreFicha = txtTrimestreFicha.value.trim();
        if (!idFicha || !trimestreFicha) {
            showAlert("No se puede cargar competencias sin seleccionar ficha y trimestre.", "warning");
            return;
        }

        try {
            const url = '@Url.Action("GetCompetenciasPorTrimestre", "Home")'
                + `?idFicha=${encodeURIComponent(idFicha)}&trimestre=${encodeURIComponent(trimestreFicha)}`;

            const resp = await fetch(url, { headers: { "Accept": "application/json" } });
            const json = await resp.json();

            if (!json.ok) {
                showAlert(json.msg || "No hay competencias en este trimestre.", "info");
                competenciasList.innerHTML =
                    `<div class="text-muted text-center py-2">Sin competencias para este trimestre.</div>`;
                return;
            }

            mostrarCompetenciasCargadas(json.data);
        } catch (err) {
            console.error(err);
            showAlert("Error cargando competencias: " + err.message, "danger");
        }
    }

    // =========================
    // BOTÓN: Guardar Todo (con feedback visual)
    // =========================
    btnGuardarHorario?.addEventListener("click", async () => {
        // 1) Validaciones básicas
        if (!payload.asignaciones || !payload.asignaciones.length) {
            showAlert("No hay asignaciones para guardar.", "warning");
            return;
        }

        const idFichaSeleccionada = hfFichaId.value;
        if (!idFichaSeleccionada) {
            showAlert("Debes seleccionar una ficha antes de guardar el horario.", "warning");
            return;
        }

        // 2) Feedback: deshabilitar botón y mostrar indicador
        const originalHTML = btnGuardarHorario.innerHTML;
        btnGuardarHorario.disabled = true;
        btnGuardarHorario.innerHTML = `<i class="bi bi-hourglass-split me-2"></i> Cargando...`;

        try {
            // 3) Cargar instructores para el select (esperar)
            await cargarInstructoresLider();

            // 4) Cargar desde la BD el resumen de ficha que mostraremos en el modal
            const ok = await cargarFichaResumenParaModal(idFichaSeleccionada);
            if (!ok) {
                // Si la carga falló, no abrimos el modal y salimos (el finally restaurará el botón)
                return;
            }

            // 5) Mostrar modal LÍDER (backdrop static para evitar cierres involuntarios)
            const modalEl = document.getElementById("modalLider");
            const modal = new bootstrap.Modal(modalEl, { keyboard: true, backdrop: 'static' });
            modal.show();
        } catch (err) {
            console.error("Error en btnGuardarHorario:", err);
            showAlert("Error preparando el modal: " + (err.message || err), "danger");
        } finally {
            // 6) Restaurar el botón siempre
            btnGuardarHorario.disabled = false;
            btnGuardarHorario.innerHTML = originalHTML;
        }
    });


    // =========================
    // BOTÓN: Confirmar Líder (envío final)
    // =========================
    btnConfirmarLider?.addEventListener("click", async () => {
        const idInstructorLider = selInstructorLider.value;

        if (!idInstructorLider) {
            showAlert("Debes seleccionar un instructor líder.", "warning");
            return;
        }

        // Asegurarnos que hay ficha seleccionada (código) o que el modal fue cargado
        const codigoFicha = (inputFicha.value || "").trim() || (document.getElementById("txtFichaModal")?.value || "").trim();
        if (!codigoFicha) {
            showAlert("Debes seleccionar una ficha antes de guardar el horario.", "warning");
            return;
        }

        // Tomar el trimestre de destino que mostramos en el modal (es el trimestre al que *va* la ficha).
        // Si por alguna razón no está, como fallback usamos selTrimestreAnio.
        const trimestreDestino = (document.getElementById("txtTrimestreDestinoModal")?.value || selTrimestreAnio.value || "").toString().trim();

        // Opcional: deshabilitar el botón 'Guardar Horario' dentro del modal para evitar doble click
        btnConfirmarLider.disabled = true;
        const originalConfirmHTML = btnConfirmarLider.innerHTML;
        btnConfirmarLider.innerHTML = `<i class="bi bi-hourglass-split me-2"></i> Guardando...`;

        try {
            const fd = new FormData();
            fd.append("__RequestVerificationToken", getAntiForgeryToken());
            fd.append("AsignacionesJson", JSON.stringify(payload.asignaciones));
            fd.append("numeroFicha", codigoFicha);
            fd.append("nombreHorario", `Horario ${codigoFicha} - T${trimestreDestino}`);
            fd.append("trimestre", trimestreDestino);               // enviamos el trimestre destino (1..7)
            fd.append("idInstructorLider", idInstructorLider);

            // Enviamos también los datos solo-lectura que se muestran en el modal
            const programaModal = document.getElementById("txtProgramaModal")?.value || "";
            const fechaInicioModal = document.getElementById("txtFechaInicioModal")?.value || "";
            const fechaFinModal = document.getElementById("txtFechaFinModal")?.value || "";

            fd.append("ProgramaNombre", programaModal);
            fd.append("FechaInicioFicha", fechaInicioModal);
            fd.append("FechaFinFicha", fechaFinModal);

            const resp = await fetch('@Url.Action("GuardarHorario", "Home")', {
                method: "POST",
                body: fd,
                credentials: "same-origin"
            });

            const json = await resp.json();

            if (json.ok) {
                showAlert(json.msg, "success");
                // Cerrar modal líder si está abierto
                try {
                    const modalInstance = bootstrap.Modal.getInstance(document.getElementById("modalLider"));
                    if (modalInstance) modalInstance.hide();
                } catch (e) { /* noop */ }

                setTimeout(() => {
                    window.location.href = '@Url.Action("ListaHorarios", "Home")';
                }, 1500);
            } else {
                showAlert(json.msg || "Error guardando horario.", "danger");
            }
        } catch (err) {
            console.error("Error en btnConfirmarLider:", err);
            showAlert("Error enviando la solicitud: " + err.message, "danger");
        } finally {
            btnConfirmarLider.disabled = false;
            btnConfirmarLider.innerHTML = originalConfirmHTML;
        }
    });


    // ========== TRIMESTRE SIGUIENTE ==========
    function actualizarSiguienteTrimestre() {
        const actual = parseInt(txtTrimestreFicha.value || "0");
        if (!actual || isNaN(actual)) {
            txtSiguienteTrimestre.value = "";
            return;
        }
        const siguiente = actual >= 7 ? 1 : actual + 1;
        txtSiguienteTrimestre.value = siguiente;
    }

    txtTrimestreFicha.addEventListener("change", actualizarSiguienteTrimestre);

    // ========== VALIDACIÓN EN VIVO EN MODAL ==========
    validarEnVivo._callId = 0; // contador para evitar race conditions

    async function validarEnVivo() {
        if (!dropContext) return;

        const alertaChoque = document.getElementById("alertChoque");
        const instructorId = selInstructorEl.value;
        const horaDesde = horaDesdeEl.value;
        const horaHasta = horaHastaEl.value;
        const idFicha = payload.idFichaActual || hfFichaId.value || null;

        // si faltan datos básicos, ocultamos alerta y salimos
        if (!instructorId || !horaDesde || !horaHasta) {
            alertaChoque.classList.add("d-none");
            return;
        }

        const asignacion = payload.asignaciones.find(a => a.id === dropContext.asignacionId);
        const dia = asignacion?.dia || dropContext.itemEl.dataset.dia;

        // --- 1️⃣ VALIDACIÓN LOCAL (rangos se pisan) ---
        const conflictoLocal = tieneConflictoEnDia({
            dia,
            instructorId,
            desde: horaDesde,
            hasta: horaHasta,
            ignoreId: dropContext.asignacionId
        });

        if (conflictoLocal) {
            alertaChoque.textContent = "❌ " + conflictoLocal;
            alertaChoque.classList.remove("d-none");
            return;
        }

        // --- PREPARAR ID DE LLAMADA PARA EVITAR RACE CONDITIONS ---
        const myCallId = ++validarEnVivo._callId;

        // Helper para construir querystring y llamar con fetch
        async function getJson(url, params) {
            const qs = Object.keys(params || {})
                .map(k => encodeURIComponent(k) + "=" + encodeURIComponent(params[k]))
                .join("&");
            const full = url + (qs ? ("?" + qs) : "");
            const resp = await fetch(full, { credentials: 'same-origin' });
            // Si respuesta no es JSON lanzamos
            const text = await resp.text();
            try {
                return JSON.parse(text);
            } catch (e) {
                throw new Error("Respuesta no JSON: " + text.substring(0, 200));
            }
        }

        // --- 2️⃣ VALIDACIÓN FRANJA EXACTA EN BD ---
        try {
            const respFran = await getJson("/Home/ValidarFranjaExactaInstructor", {
                idInstructor: instructorId,
                dia: dia,
                desde: horaDesde,
                hasta: horaHasta,
                idFichaActual: idFicha || 0
            });

            // Si ya hay una llamada más reciente, descartamos este resultado
            if (myCallId !== validarEnVivo._callId) return;

            if (!respFran || respFran.ok === false) {
                alertaChoque.textContent = respFran?.msg || "Error validando franja horaria.";
                alertaChoque.classList.remove("d-none");
                return;
            }

            if (respFran.choque) {
                alertaChoque.textContent =
                    "❌ Este instructor ya tiene programada una actividad en esta misma franja horaria (según la base de datos).";
                alertaChoque.classList.remove("d-none");
                return;
            }
        } catch (err) {
            // Si falla la validación exacta, mostramos error y no continuamos
            alertaChoque.textContent = "Error validando franja exacta: " + (err.message || err);
            alertaChoque.classList.remove("d-none");
            return;
        }

        // --- 3️⃣ VALIDACIÓN GLOBAL (OTRAS FICHAS) ---
        try {
            const respGlobal = await getJson("/Home/ValidarChoqueInstructorGlobal", {
                idInstructor: instructorId,
                dia: dia,
                desde: horaDesde,
                hasta: horaHasta,
                idFichaActual: idFicha || 0
            });

            // Si ya hay una llamada más reciente, descartamos este resultado
            if (myCallId !== validarEnVivo._callId) return;

            if (!respGlobal || respGlobal.ok === false) {
                alertaChoque.textContent = respGlobal?.msg || "Error validando horario.";
                alertaChoque.classList.remove("d-none");
                return;
            }

            if (respGlobal.choque) {
                alertaChoque.textContent =
                    "❌ Este instructor ya tiene una clase en otra ficha en este mismo rango.";
                alertaChoque.classList.remove("d-none");
            } else {
                alertaChoque.classList.add("d-none");
            }
        } catch (err) {
            alertaChoque.textContent = "Error validando horario global: " + (err.message || err);
            alertaChoque.classList.remove("d-none");
        }
    }


    function animarChoque(alertaEl) {
        alertaEl.classList.remove("shake-alert");
        void alertaEl.offsetWidth; // fuerza reflow
        alertaEl.classList.add("shake-alert");
    }

    // Eventos en vivo
    selInstructorEl.addEventListener("change", validarEnVivo);
    horaDesdeEl.addEventListener("input", validarEnVivo);
    horaHastaEl.addEventListener("input", validarEnVivo);

    // =============================
    //  VALIDACIÓN GLOBAL DE HORARIO
    //  Consulta horarios reales de otras fichas
    function conflictoGlobal(instructorId, dia, desde, hasta, idFichaActual) {

        const d1 = parseHM(desde);
        const h1 = parseHM(hasta);

        if (d1 == null || h1 == null || d1 >= h1) {
            return "Debes indicar un horario válido.";
        }

        const asigs = HORARIOS_GLOBAL.filter(h =>
            h.IdInstructor == instructorId &&
            h.Dia === dia &&
            h.IdFicha != idFichaActual   // ← OTRA FICHA
        );

        for (const h of asigs) {
            const d2 = parseHM(h.HoraDesde);
            const h2 = parseHM(h.HoraHasta);

            const choque =
                (d1 >= d2 && d1 < h2) ||
                (h1 > d2 && h1 <= h2) ||
                (d1 <= d2 && h1 >= h2);

            if (choque) {
                return `El instructor ya está asignado el día ${dia} de ${h.HoraDesde} a ${h.HoraHasta} en otra ficha.`;
            }
        }
        return null;
    }

        function actualizarBarraHorario() {

            if (dropContext) {
                const asignacion = payload.asignaciones.find(a => a.id === dropContext.asignacionId);
                if (asignacion) {
                    asignacion.horaDesde = horaDesdeEl.value;
                    asignacion.horaHasta = horaHastaEl.value;
                }
            }

            const barra = document.getElementById("barraHorario");
            const lbl = document.getElementById("lblHorasHorario");

            let minutos = 0;

            for (const a of payload.asignaciones) {
                if (!a.horaDesde || !a.horaHasta) continue;

                const d = parseHM(a.horaDesde);
                const h = parseHM(a.horaHasta);

                minutos += (h - d);
            }

            const horas = (minutos / 60) * 12;
            const pct = Math.min(100, Math.round((horas / 440) * 100));

            lbl.textContent = `${horas.toFixed(1)} horas programadas`;
            barra.style.width = pct + "%";
            barra.textContent = pct + "%";

            barra.className = "progress-bar fw-bold";

            if (pct < 60) barra.classList.add("bg-horario-ok");
            else if (pct < 80) barra.classList.add("bg-horario-aviso");
            else if (pct <= 100) barra.classList.add("bg-horario-peligro");
            else barra.classList.add("bg-horario-rojo");

            // 🔥 Se recalcula también la barra del instructor
            mostrarInstructorActual();
        }

        function actualizarBarraInstructor() {
            const barra = document.getElementById("barraInstructor");
            const lblHoras = document.getElementById("lblHorasInstructor");
            const lblMax = document.getElementById("lblMaxInstructor");
            const estado = document.getElementById("estadoInstructor");

            // 🔥 Si aún no hay instructores asignados, mostrar 0
            if (!INSTRUCTORES_EN_HORARIO.length) {
                lblHoras.textContent = "0 horas";
                lblMax.textContent = "Máximo: 0h";
                barra.style.width = "0%";
                barra.textContent = "0%";
                barra.className = "progress-bar fw-bold bg-inst-ok";
                estado.textContent = "Sin instructor seleccionado";
                return;
            }

            // 🔥 ID del instructor actualmente visible en la barra
            const id = INSTRUCTORES_EN_HORARIO[indexInstructorActual];

            // 🔥 Datos traídos del backend
            const max = window._horasInstructorMax || 0;
            const base = window._horasInstructorActual || 0;

            // 🔥 Horas nuevas del horario (multiplicadas por 12 según tu regla)
            const nuevas = calcularHorasAsignadasAInstructor(id);

            const total = base + nuevas;

            const pct = max > 0
                ? Math.min(100, Math.round((total / max) * 100))
                : 0;

            // 🔥 Etiquetas
            lblHoras.textContent = `${total.toFixed(1)} horas`;
            lblMax.textContent = `Máximo: ${max}h`;

            // 🔥 Barra visual
            barra.style.width = pct + "%";
            barra.textContent = pct + "%";

            // 🔥 Reset estilos
            barra.className = "progress-bar fw-bold";
            estado.textContent = "";

            // 🔥 Colores y mensajes según porcentaje
            if (pct < 70) {
                barra.classList.add("bg-inst-ok");
                estado.textContent = "";
                estado.className = "text-muted mt-1 d-block";
            }
            else if (pct < 90) {
                barra.classList.add("bg-inst-aviso");
                estado.textContent = "Se acerca al límite permitido.";
                estado.className = "text-warning fw-bold mt-1 d-block";
            }
            else if (pct < 100) {
                barra.classList.add("bg-inst-alto");
                estado.textContent = "Muy cerca del límite máximo.";
                estado.className = "text-danger fw-bold mt-1 d-block";
            }
            else {
                barra.classList.add("bg-inst-max");
                estado.textContent = "Límite superado.";
                estado.className = "text-danger fw-bold mt-1 d-block";
            }
        }

        function calcularHorasAsignadasAInstructor(idInstructor) {
            let minutos = 0;

            for (const a of payload.asignaciones) {
                if (String(a.instructorId) !== String(idInstructor)) continue;
                if (!a.horaDesde || !a.horaHasta) continue;

                const d = parseHM(a.horaDesde);
                const h = parseHM(a.horaHasta);

                minutos += (h - d);
            }

            const horasSimples = minutos / 60;
            return horasSimples * 12;   // ← 🔥 regla solicitada
        }

        function refrescarListaInstructoresEnHorario() {
            const ids = new Set();

            for (const a of payload.asignaciones) {
                if (a.instructorId) ids.add(String(a.instructorId));
            }

            INSTRUCTORES_EN_HORARIO = Array.from(ids);
            if (indexInstructorActual >= INSTRUCTORES_EN_HORARIO.length)
                indexInstructorActual = 0;
        }

        async function mostrarInstructorActual() {
            refrescarListaInstructoresEnHorario();

            const lblNombre = document.getElementById("nombreInstructorActual");

            if (INSTRUCTORES_EN_HORARIO.length === 0) {
                lblNombre.textContent = "Sin instructores asignados";
                actualizarBarraInstructor();
                return;
            }

            const id = INSTRUCTORES_EN_HORARIO[indexInstructorActual];
            lblNombre.textContent = INSTRUCTORES_BY_ID.get(id) || "Instructor";

            // 🔥 cargar horas reales del backend
            await cargarHorasInstructor(id);

            // 🔥 recalcular barra
            actualizarBarraInstructor();
        }

        document.getElementById("btnPrevInstructor").addEventListener("click", () => {
            if (INSTRUCTORES_EN_HORARIO.length === 0) return;

            // ✔ si solo hay 1 instructor NO cambiamos índice, pero sí actualizamos la barra
            if (INSTRUCTORES_EN_HORARIO.length > 1) {
                indexInstructorActual =
                    (indexInstructorActual - 1 + INSTRUCTORES_EN_HORARIO.length) %
                    INSTRUCTORES_EN_HORARIO.length;
            }

            mostrarInstructorActual();
        });

        document.getElementById("btnNextInstructor").addEventListener("click", () => {
            if (INSTRUCTORES_EN_HORARIO.length === 0) return;

            if (INSTRUCTORES_EN_HORARIO.length > 1) {
                indexInstructorActual =
                    (indexInstructorActual + 1) % INSTRUCTORES_EN_HORARIO.length;
            }

            mostrarInstructorActual();
        });


    // ========== INICIALIZACIÓN ==========
    (async function init() {
        initDropHints();
        wireDayDropZones();
        await cargarHorariosGlobales();
    })();

    </script>
}